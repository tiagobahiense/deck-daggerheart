<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesa de Jogo - Daggerheart (GM)</title>
    <link rel="stylesheet" href="style.css?v=8.0">
    <link rel="stylesheet" href="ficha.css?v=4.0">
    <link rel="stylesheet" href="dados.css?v=2.0">
    <link rel="stylesheet" href="inimigos.css?v=3.6">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        body { display: flex; height: 100vh; flex-direction: column; background-color: #050505; }
        
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; display: flex; align-items: center; justify-content: center; color: var(--gold); font-family: 'MedievalSharp', cursive; font-size: 2rem; }

        #container-principal { display: flex; flex: 1; overflow: hidden; gap: 0; }
        
        /* 1. JOGADORES (ESQUERDA) */
        #area-jogadores { width: 350px; flex-shrink: 0; display: flex; flex-direction: column; border-right: 2px solid var(--gold); background: #0a0a0a; }
        #painel { padding: 10px; overflow-y: auto; height: 100%; display: flex; flex-direction: column; gap: 10px; }
        
        .card-jogador { width: 100%; background: rgba(20,20,20,0.9); border: 1px solid #444; border-radius:8px; padding:8px; box-sizing: border-box; }
        .card-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:5px; }
        .nome { color: var(--gold); font-weight: bold; font-size: 0.9rem; }
        .tag-classe { font-size: 0.65rem; color: #aaa; background: #222; padding: 1px 4px; border-radius: 4px; }
        
        .btn-abrir-ficha-mestre { background: var(--gold); color: #000; border: none; border-radius: 15px; padding: 2px 8px; font-weight: bold; cursor: pointer; font-size: 0.75rem; margin-left:5px; }
        .btn-expandir-mesa { background: #333; color: #ccc; border: 1px solid #555; width: 100%; padding: 4px; cursor: pointer; font-size: 0.75rem; margin-top:5px; border-radius: 4px; }
        .btn-expandir-mesa:hover { background: #444; color: #fff; }
        .mesa-expandida { display: none; margin-top: 5px; border-top: 1px dashed #444; padding-top: 5px; }
        .mesa-expandida.ativo { display: block; }
        .grid-mini { display: flex; flex-wrap: wrap; gap: 4px; min-height: 40px; }

        /* 2. √ÅREA DE BATALHA (CENTRO) */
        #area-batalha-gm { flex-grow: 1; background: url('img/background_epico.png') no-repeat center center; background-size: cover; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        #titulo-batalha { background: rgba(0,0,0,0.8); color: var(--gold); text-align: center; padding: 5px; font-family: 'MedievalSharp', cursive; border-bottom: 1px solid var(--gold); }
        
        /* 3. ESCUDO E DADOS (DIREITA) */
        #sidebar-escudo { width: 280px; flex-shrink: 0; background: #0f0f0f; border-left: 2px solid var(--gold); padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .escudo-topicos { display: flex; flex-direction: column; gap: 5px; }
        .btn-topico { background: #222; border: 1px solid #444; color: #ddd; padding: 8px; text-align: left; cursor: pointer; border-radius: 5px; transition: 0.2s; }
        .btn-topico:hover { border-color: var(--gold); background: #333; }

        /* Controles Gerais */
        #controles-mestre { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background: #111; border-bottom: 2px solid var(--gold); z-index: 100; }
        .btn-rest { font-size: 0.8rem; padding: 5px 10px; cursor: pointer; color: white; border-radius: 4px; border:none; }
        .curto { background: #f57c00; } .longo { background: #d32f2f; }
        .btn-nav-mestre { background: #333; color: #fff; padding: 5px 10px; border: 1px solid #555; cursor: pointer; border-radius: 4px; }

        /* Modal Criar */
        #modal-criar-inimigo { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9000; align-items: center; justify-content: center; }
        .modal-criar-content { background: #1a1a1a; width: 450px; padding: 20px; border: 2px solid var(--gold); border-radius: 10px; display: flex; flex-direction: column; gap: 10px; max-height:90vh; overflow-y:auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .form-full { grid-column: 1 / -1; }
        input, textarea { width: 100%; box-sizing: border-box; background: #222; border: 1px solid #444; color: white; padding: 5px; }
        
        /* Preview Card */
        #preview-carta-mestre { display: none; position: fixed; top: 50%; left: 50%; width: 320px; height: 480px; z-index: 9999; transform: translate(-50%, -50%); border: 3px solid var(--gold); background: #000; pointer-events: none; background-size: contain; background-repeat: no-repeat; background-position: center; box-shadow: 0 0 60px rgba(255,215,0,0.4); border-radius: 10px; }
        #preview-carta-mestre .token-count { position: absolute; top: -10px; right: -10px; background: #000; border: 2px solid #fff; color: #fff; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; }
        
        /* Modal Escudo */
        #modal-escudo { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center; }
        #modal-escudo.ativo { display: flex; }
        .modal-escudo-content { background: #1a1a1a; padding: 30px; border: 2px solid var(--gold); max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative; color: #ddd; border-radius: 10px; }
        .modal-escudo-content h2 { color:var(--gold); margin-top:0; }
        .modal-escudo-content h3 { color:#ffff99; margin-top:15px; }
        #btn-fechar-escudo { position: absolute; top: 10px; right: 10px; background: var(--gold); border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    
    <div id="loading-screen">Carregando Mesa...</div>
    <div id="preview-carta-mestre"></div>

    <div id="controles-mestre">
        <div style="display:flex; gap:10px;">
            <button class="btn-rest curto" onclick="realizarDescanso('curto')">üåô Curto</button>
            <button class="btn-rest longo" onclick="realizarDescanso('longo')">üåï Longo</button>
        </div>
        <div style="display:flex; gap:10px;">
             <button class="btn-rest" style="background: #444; border: 1px solid var(--gold);" onclick="abrirCriadorInimigo()">üëæ Novo Inimigo</button>
             <button class="btn-rest" style="background: #330000; border: 1px solid red;" onclick="removerTodosInimigos()">üóëÔ∏è Limpar</button>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <div id="btn-abrir-dados" onclick="abrirSeletorDados()" style="position:static; width:40px; height:30px; font-size:1.2rem; display:flex; align-items:center; justify-content:center; cursor:pointer;">üé≤</div>
            <button class="btn-nav-mestre" onclick="window.location.href='admin.html'">‚öôÔ∏è Admin</button>
        </div>
    </div>

    <div id="container-principal">
        
        <div id="area-jogadores">
            <h3 style="color:#aaa; text-align:center; margin:5px 0; border-bottom:1px solid #333;">JOGADORES</h3>
            <div id="painel">
                <p style="text-align:center; color:#666;">Carregando...</p>
            </div>
        </div>

        <div id="area-batalha-gm">
            <div id="titulo-batalha">CAMPO DE BATALHA</div>
            <div id="area-inimigos"></div>
        </div>

        <div id="sidebar-escudo">
            <h3 style="color:var(--gold); text-align:center; border-bottom:1px solid #333; padding-bottom:5px; margin-top:0;">ESCUDO GM</h3>
            <div class="escudo-topicos">
                <button class="btn-topico" onclick="exibirTopico('testes')">üé≤ Testes & Dualidade</button>
                <button class="btn-topico" onclick="exibirTopico('recursos')">üíé Recursos</button>
                <button class="btn-topico" onclick="exibirTopico('combate')">‚öîÔ∏è Combate</button>
                <button class="btn-topico" onclick="exibirTopico('dano')">ü©∏ Dano</button>
                <button class="btn-topico" onclick="exibirTopico('armadura')">üõ°Ô∏è Armadura</button>
                <button class="btn-topico" onclick="exibirTopico('morte')">‚ò†Ô∏è Morte</button>
                <button class="btn-topico" onclick="exibirTopico('distancia')">üìè Dist√¢ncia</button>
                <button class="btn-topico" onclick="exibirTopico('descanso')">üí§ Descanso</button>
                <button class="btn-topico" onclick="exibirTopico('mestre')">üíÄ Moves do GM</button>
            </div>
        </div>
    </div>

    <div id="modal-criar-inimigo">
        <div class="modal-criar-content">
            <h2 style="color:var(--gold); text-align:center; margin-top:0;">Invocar Inimigo</h2>
            <div class="form-grid">
                <div class="form-group form-full"><label>Nome</label><input type="text" id="new-enemy-name" placeholder="Ex: Lobo Atroz"></div>
                <div class="form-group form-full">
                    <label>Imagem (Upload ou Link)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="new-enemy-img" placeholder="URL ou Upload..." style="flex:1">
                        <label for="upload-file-input" style="background:#333; border:1px solid #555; padding:5px; cursor:pointer; color:white;">üìÅ</label>
                        <input type="file" id="upload-file-input" accept="image/*" style="display:none" onchange="processarUploadImagem()">
                        <img id="preview-img-mini" style="width:30px; height:30px; display:none; border:1px solid #555;">
                    </div>
                </div>
                <div class="form-group"><label>PV Max</label><input type="number" id="new-enemy-pv" value="4"></div>
                <div class="form-group"><label>Estresse (PF)</label><input type="number" id="new-enemy-pf" value="0"></div>
                <div class="form-group"><label>Dificuldade</label><input type="number" id="new-enemy-dif" value="12"></div>
                <div class="form-group"><label>Ataque</label><input type="text" id="new-enemy-atk" value="+2"></div>
                <div class="form-group"><label>Dano</label><input type="text" id="new-enemy-dmg" value="1d6+2"></div>
                <div class="form-group"><label>Limiares</label><input type="text" id="new-enemy-limiares" placeholder="5/10"></div>
                <div class="form-group form-full"><label>Habilidades</label><textarea id="new-enemy-desc" rows="3"></textarea></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-rest" style="background:#4CAF50; flex:1;" onclick="salvarNovoInimigo()">Invocar</button>
                <button class="btn-rest" style="background:#f44336; flex:1;" onclick="fecharCriadorInimigo()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-selecao-dados" onclick="if(event.target===this) fecharSeletorDados()">
        <div class="dados-content">
            <div class="dados-header">Rolagem de Dados</div>
            <div class="dualidade-box">
                <span style="color:#ddd; font-size: 0.9rem;">Teste de A√ß√£o (2d12)</span>
                <button class="btn-dualidade" onclick="adicionarDualidade()">‚ö° Rolar Dualidade</button>
            </div>
            <hr style="border: 0; border-top: 1px solid #444; width: 100%;">
            <div class="grid-dados">
                <div class="dado-control"><span class="dado-label">d4</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d4', -1)">-</button><span id="count-d4" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d4', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d6</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d6', -1)">-</button><span id="count-d6" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d6', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d8</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d8', -1)">-</button><span id="count-d8" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d8', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d10</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d10', -1)">-</button><span id="count-d10" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d10', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d12</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d12', -1)">-</button><span id="count-d12" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d12', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d20</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d20', -1)">-</button><span id="count-d20" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d20', 1)">+</button></div></div>
            </div>
            <button class="btn-rolar-final" onclick="rolarDadosConfirmados()">Rolar Selecionados</button>
        </div>
    </div>

    <div id="overlay-rolagem">
        <div id="quem-rolou-label"></div>
        <div id="container-dados-rolando"></div>
        <button id="btn-fechar-rolagem" onclick="fecharResultadoRolagem()">Fechar Resultado</button>
    </div>

    <div id="modal-escudo">
        <div class="modal-escudo-content">
            <button id="btn-fechar-escudo" onclick="fecharEscudo()">√ó</button>
            <div id="escudo-conteudo"></div>
        </div>
    </div>

    <div id="sheet-modal" class="modal">
        <div class="sheet-content">
            <div class="sheet-toolbar">
                <button class="tool-btn active" onclick="selecionarFerramenta('texto')">T</button>
                <button class="tool-btn" onclick="selecionarFerramenta('marcador')">‚óè</button>
                <button class="tool-btn" onclick="limparPaginaAtual()" style="color:#f66;">üóëÔ∏è</button>
            </div>
            <button class="btn-close-sheet" onclick="fecharFicha()">X</button>
            <div class="sheet-container" id="sheet-container"><img id="sheet-bg"><div id="sheet-inputs-layer"></div></div>
            <div class="sheet-footer"><button class="nav-simple-btn" onclick="mudarPaginaFicha(-1)">‚ùÆ</button><span id="sheet-page-indicator">1</span><button class="nav-simple-btn" onclick="mudarPaginaFicha(1)">‚ùØ</button></div>
        </div>
    </div>

    <div id="carta-usada-animada" class="carta-tabuleiro-animada"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, get, onChildChanged, push, query, limitToLast, onChildAdded, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATWkyYE6b3wyz3LdFXAmxKxNQOexa_vUY",
            authDomain: "deck-daggerheart.firebaseapp.com",
            databaseURL: "https://deck-daggerheart-default-rtdb.firebaseio.com",
            projectId: "deck-daggerheart",
            storageBucket: "deck-daggerheart.firebasestorage.app",
            messagingSenderId: "825358776791",
            appId: "1:825358776791:web:ce0ab844f58c60573c7392",
            measurementId: "G-20TB05E9N2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // EXPORTS
        window.db = db; window.ref = ref; window.set = set; window.get = get; window.remove = remove;
        window.onValue = onValue; window.push = push; window.update = update;
        window.query = query; window.limitToLast = limitToLast; window.onChildAdded = onChildAdded;
        
        window.nomeJogador = "Mestre";
        const EMAIL_MESTRE = "tgbahiense@gmail.com";

        window.fazerLogout = function() {
            signOut(auth).then(() => window.location.href = "index.html");
        }

        window.abrirFichaDoJogador = function(nome) {
            window.nomeJogador = nome;
            get(ref(db, `mesa_rpg/jogadores/${nome}/slots/Fundamental`)).then(snap => {
                if(snap.exists() && snap.val().profissao) {
                    localStorage.setItem('profissaoSelecionada', snap.val().profissao);
                    if(window.abrirFichaPersonagem) window.abrirFichaPersonagem();
                } else alert("Jogador sem classe.");
            });
        };

        window.toggleMesaJogador = function(nome) {
            const el = document.getElementById(`mesa-${nome}`);
            if(el) el.classList.toggle('ativo');
        };

        // RENDERIZA√á√ÉO DOS JOGADORES COM DETALHES
        function iniciarPainelJogadores() {
            const jogadoresRef = ref(db, 'mesa_rpg/jogadores');
            const accountsRef = ref(db, 'mesa_rpg/accounts');
            let nomesDePersonagens = new Set();
            let cacheJogadores = {};

            function render() {
                const painel = document.getElementById('painel');
                if(!painel) return;
                painel.innerHTML = "";
                const nomes = Array.from(nomesDePersonagens).sort();
                if (nomes.length === 0) { painel.innerHTML = "<p style='color:#666;text-align:center'>Vazio.</p>"; return; }

                nomes.forEach(nome => {
                    const p = cacheJogadores[nome] || {};
                    const card = document.createElement('div');
                    card.className = 'card-jogador';
                    const safeName = nome.replace(/'/g, "\\'");

                    let htmlMao = "";
                    if(p.mao && p.mao.length > 0) {
                        p.mao.forEach(c => {
                            let cl = "mini-carta"; let tt = c.nome; let ex = "";
                            if(c.estado==='curto') { cl+=" indisponivel"; ex+=`<div class="icone-descanso-mini"><img src="img/meia-lua.png"></div>`; }
                            if(c.estado==='longo') { cl+=" indisponivel"; ex+=`<div class="icone-descanso-mini"><img src="img/lua-cheia.png"></div>`; }
                            if(c.tokens>0) ex+=`<div class="token-count">${c.tokens}</div>`;
                            htmlMao += `<div class="${cl}" style="background-image: url('${c.caminho}')" title="${tt}">${ex}</div>`;
                        });
                    } else { htmlMao = "<span style='font-size:0.7rem; color:#666'>Vazia</span>"; }

                    let htmlMesa = "";
                    if(p.slots) {
                        ['Ancestralidade', 'Comunidade', 'Fundamental', 'Especializacao', 'Maestria'].forEach(k => {
                            if(p.slots[k]) {
                                htmlMesa += `<div class="mini-carta slot-ativo" style="background-image: url('${p.slots[k].caminho}')" title="${k}"></div>`;
                            }
                        });
                    }
                    if(p.reserva && p.reserva.length > 0) {
                        p.reserva.forEach(c => htmlMesa += `<div class="mini-carta carta-reserva-visual" style="background-image: url('${c.caminho}')" title="Reserva"></div>`);
                    }
                    if(htmlMesa === "") htmlMesa = "<span style='font-size:0.7rem; color:#666'>Nada na mesa.</span>";

                    let classeNome = "";
                    if(p.slots && p.slots.Fundamental && p.slots.Fundamental.profissao) classeNome = p.slots.Fundamental.profissao;

                    card.innerHTML = `
                        <div class="card-header">
                            <div><div class="nome">${nome}</div>${classeNome ? `<div class="tag-classe">${classeNome}</div>` : ''}</div>
                            <div style="display:flex;align-items:center;">
                                <button class="btn-abrir-ficha-mestre" onclick="window.abrirFichaDoJogador('${safeName}')">üìù</button>
                            </div>
                        </div>
                        <div class="label">M√£o</div><div class="grid-mini" data-jogador="${nome}">${htmlMao}</div>
                        <button class="btn-expandir-mesa" onclick="window.toggleMesaJogador('${safeName}')">üìÇ Ver Mesa</button>
                        <div id="mesa-${nome}" class="mesa-expandida">
                            <div class="label">Mesa & Reserva</div>
                            <div class="grid-mini">${htmlMesa}</div>
                        </div>
                    `;
                    painel.appendChild(card);
                });
            }

            onValue(accountsRef, (snap) => {
                const setNomes = new Set();
                if (snap.exists()) {
                    snap.forEach(c => {
                        const d = c.val();
                        if (d.status !== 'inactive' && d.characters) Object.keys(d.characters).forEach(n => setNomes.add(String(n).toUpperCase()));
                    });
                }
                nomesDePersonagens = setNomes;
                render();
            });

            onValue(jogadoresRef, (snap) => {
                cacheJogadores = snap.exists() ? snap.val() : {};
                Object.keys(cacheJogadores).forEach(n => nomesDePersonagens.add(String(n).toUpperCase()));
                render();
            });
            
            onChildChanged(jogadoresRef, (snap) => {
                const n = snap.key; const d = snap.val();
                if(d.cartaUsada) animarCartaEspecifica(n, d.cartaUsada);
            });
        }

        window.realizarDescanso = function(tipo) {
            get(ref(db, 'mesa_rpg/jogadores')).then(snap => {
                if(snap.exists()) {
                    Object.keys(snap.val()).forEach(n => {
                        const p = snap.val()[n];
                        // Reset M√£o
                        if(p.mao) {
                            let m = false; p.mao.forEach(c => { if(c && (tipo==='longo' || c.estado==='curto')){ c.estado='ativo'; m=true; } });
                            if(m) set(ref(db, `mesa_rpg/jogadores/${n}/mao`), p.mao);
                        }
                        // Reset Slots
                        if(p.slots) {
                             let m = false; Object.keys(p.slots).forEach(k => { if(p.slots[k] && (tipo==='longo' || p.slots[k].estado==='curto')){ p.slots[k].estado='ativo'; m=true; } });
                             if(m) set(ref(db, `mesa_rpg/jogadores/${n}/slots`), p.slots);
                        }
                    });
                }
            });
        };

        function animarCartaEspecifica(nome, carta) {
            const grid = document.querySelector(`[data-jogador="${nome}"]`);
            if(!grid) return;
            const imgs = grid.querySelectorAll('.mini-carta');
            imgs.forEach(el => {
                if(el.style.backgroundImage.includes(carta.caminho.split('/').pop())) {
                    el.style.transform = "scale(1.2)"; el.style.boxShadow = "0 0 15px gold";
                    setTimeout(() => { el.style.transform = ""; el.style.boxShadow = ""; }, 1000);
                }
            });
            const pre = document.getElementById('preview-carta-mestre');
            pre.style.backgroundImage = `url('${carta.caminho}')`;
            pre.style.display = 'block';
            setTimeout(() => pre.style.display='none', 3000);
        }

        const topicos = {
            testes: { titulo: "üé≤ TESTES & DUALIDADE", conteudo: "<h2>üé≤ TESTES & DUALIDADE</h2><h3>Rolagem Padr√£o</h3><ul><li><strong>Role:</strong> <code>2d12 (Esperan√ßa + Medo) + Atributo</code></li><li><strong>Cr√≠tico:</strong> Dados iguais (ex: 1,1 ou 12,12). Sucesso autom√°tico + Ganha Esperan√ßa.</li></ul><h3>Resultados</h3><ul><li><strong>Sucesso com Esperan√ßa:</strong> Total ‚â• Dificuldade & Esperan√ßa > Medo. <br><em>A√ß√£o funciona e ganha 1 Esperan√ßa.</em></li><li><strong>Sucesso com Medo:</strong> Total ‚â• Dificuldade & Medo > Esperan√ßa. <br><em>A√ß√£o funciona, mas GM ganha 1 Medo.</em></li><li><strong>Falha com Esperan√ßa:</strong> Total < Dificuldade & Esperan√ßa > Medo. <br><em>Falha, mas ganha 1 Esperan√ßa.</em></li><li><strong>Falha com Medo:</strong> Total < Dificuldade & Medo > Esperan√ßa. <br><em>Falha e GM ganha 1 Medo ou faz movimento.</em></li></ul>" },
            recursos: { titulo: "üíé RECURSOS DO JOGADOR", conteudo: "<h2>üíé RECURSOS DO JOGADOR</h2><h3>Esperan√ßa</h3><ul><li><strong>Ganho:</strong> Sucesso com Esperan√ßa ou Cr√≠tico.</li><li><strong>Gastos:</strong><ul><li><strong>Experi√™ncia:</strong> Use uma carta de Experi√™ncia.</li><li><strong>Ajudar:</strong> Gaste 1 para dar +1d6 (ou +2d6 com v√≠nculo) a um aliado.</li></ul></li></ul><h3>Estresse (Fadiga)</h3><ul><li>Usada para ativar habilidades ou absorver consequ√™ncias menores.</li><li>Se encher, o pr√≥ximo dano vai direto para PV.</li></ul>" },
            combate: { titulo: "‚öîÔ∏è COMBATE", conteudo: "<h2>‚öîÔ∏è COMBATE</h2><h3>Ataque</h3><ul><li><strong>Teste:</strong> Atributo da arma vs <strong>Dificuldade (Evas√£o do Inimigo)</strong>.</li><li><strong>Vantagem:</strong> +1d6 no total.</li><li><strong>Desvantagem:</strong> -1d6 no total.</li></ul><h3>Dano</h3><ul><li><strong>Dados:</strong> Base da arma (ex: d8) + Cartas de Dano.</li><li><strong>Cr√≠tico:</strong> Adicione o valor m√°ximo dos dados ao total rolado.</li></ul>" },
            dano: { titulo: "ü©∏ DANO & LIMIARES", conteudo: "<h2>ü©∏ DANO & LIMIARES</h2><p>O dano sofrido √© comparado aos limiares do personagem:</p><ul><li><strong>Abaixo do Menor:</strong> 0 PV (Arranh√£o).</li><li><strong>Menor:</strong> 1 PV (Machucado).</li><li><strong>Maior:</strong> 2 PV (Ferida Grave).</li><li><strong>Severo:</strong> 3 PV (Mortal).</li></ul>" },
            armadura: { titulo: "üõ°Ô∏è ARMADURA (PA)", conteudo: "<h2>üõ°Ô∏è ARMADURA (PA)</h2><ul><li>Gaste <strong>slots de Armadura</strong> para reduzir o dano recebido.</li><li>A quantidade reduzida depende do tipo de armadura equipada.</li><li>Slots gastos s√≥ recuperam em Descanso ou Reparo.</li></ul>" },
            morte: { titulo: "‚ò†Ô∏è MORTE", conteudo: "<h2>‚ò†Ô∏è MORTE</h2><p>Se marcar o √∫ltimo PV, o personagem cai. Escolha:</p><ul><li><strong>Arriscar Tudo:</strong> Role Fear die. Se falhar, morre. Se passar, levanta com 1 PV.</li><li><strong>Evitar a Morte:</strong> Fica inconsciente e ganha uma Cicatriz.</li><li><strong>Sacrif√≠cio Glorioso:</strong> Morre realizando um feito imposs√≠vel (Sucesso Cr√≠tico Autom√°tico).</li></ul>" },
            distancia: { titulo: "üìè DIST√ÇNCIA & MOVIMENTO", conteudo: "<h2>üìè DIST√ÇNCIA & MOVIMENTO</h2><ul><li><strong>Melee:</strong> Adjacente.</li><li><strong>Very Close:</strong> Ao alcance do bra√ßo/arma longa.</li><li><strong>Close:</strong> Alguns passos (mesma sala).</li><li><strong>Far:</strong> Precisa gritar/correr (outro lado do campo).</li><li><strong>Very Far:</strong> Apenas armas de longo alcance/magia.</li></ul>" },
            descanso: { titulo: "üí§ DESCANSO", conteudo: "<h2>üí§ DESCANSO</h2><h3>Curto</h3><ul><li>Pode reparar Armadura.</li><li>Pode curar PV ou limpar Estresse (role 1d4 + atributo).</li></ul><h3>Longo</h3><ul><li>Recupera <strong>todos</strong> PV, Estresse e Armadura.</li><li>Reseta habilidades di√°rias.</li><li>GM ganha Medo baseado na seguran√ßa do local.</li></ul>" },
            mestre: { titulo: "üíÄ O MESTRE (GM)", conteudo: "<h2>üíÄ O MESTRE (GM)</h2><h3>Quando o GM Age?</h3><ul><li>Quando os jogadores falham.</li><li>Quando rolam <strong>Com Medo</strong>.</li><li>Quando olham para voc√™ esperando algo acontecer (Oportunidade de Ouro).</li></ul><h3>Medo</h3><ul><li>Use Medo para ativar habilidades especiais de monstros ou complicar a cena.</li><li>Cada Medo gasto = 1 Token de A√ß√£o do GM.</li></ul>" }
        };

        window.exibirTopico = function(id) { if(topicos[id]) { document.getElementById('escudo-conteudo').innerHTML = topicos[id].conteudo; document.getElementById('modal-escudo').classList.add('ativo'); } }
        window.fecharEscudo = function() { document.getElementById('modal-escudo').classList.remove('ativo'); }
        document.getElementById('modal-escudo').addEventListener('click', function(e) { if(e.target===this) fecharEscudo(); });

        onAuthStateChanged(auth, u => {
            document.getElementById('loading-screen').style.display = 'none';
            if(!u || u.email !== EMAIL_MESTRE) { window.location.href="index.html"; return; }
            iniciarPainelJogadores();
            setTimeout(() => {
                if(window.iniciarSistemaInimigos) window.iniciarSistemaInimigos();
                if(window.escutarRolagens) window.escutarRolagens();
            }, 1000);
        });

        // HOVER PREVIEW ATUALIZADO (DETECTA CARTA DE MESA TAMB√âM)
        document.addEventListener('mouseover', (e) => {
            // Verifica se o alvo ou algum pai √© .mini-carta (M√ÉO E MESA USAM ESSA CLASSE)
            const c = e.target.closest('.mini-carta');
            if (c && !c.classList.contains('status-vazio')) {
                const p = document.getElementById('preview-carta-mestre');
                
                // Tenta pegar imagem do estilo inline (M√£o) ou computado (Mesa pode ter classes)
                let bg = c.style.backgroundImage;
                if (!bg || bg === 'none') {
                     bg = window.getComputedStyle(c).backgroundImage;
                }
                
                if (bg && bg !== 'none') {
                    p.style.backgroundImage = bg;
                    p.innerHTML = c.innerHTML; // Copia tokens se tiver
                    p.style.display = 'flex';
                }
            }
        });
        
        document.addEventListener('mouseout', (e) => { 
            if (e.target.closest('.mini-carta')) {
                document.getElementById('preview-carta-mestre').style.display = 'none';
            }
        });

    </script>
    
    <script src="ficha.js?v=4.0"></script>
    <script src="dados.js?v=2.0"></script>
    <script src="inimigos.js?v=4.0"></script>
</body>
</html>

### 3. `index.html` (V5.0 - Sincronia de Inimigos)
Adicionei a chamada de `iniciarSistemaInimigos()` **dentro** da fun√ß√£o `selecionarPersonagem()`, para garantir que o listener de inimigos reinicie e sincronize assim que o jogador entra na mesa.

```html
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grim√≥rio Daggerheart</title>
    <link rel="icon" type="image/png" href="img/favicon.png" />
    <link rel="stylesheet" href="style.css?v=10.1">
    <link rel="stylesheet" href="profissao.css?v=1.0">
    <link rel="stylesheet" href="selecao-classe.css?v=3.0">
    <link rel="stylesheet" href="ficha.css?v=4.0">
    <link rel="stylesheet" href="dados.css?v=2.0">
    <link rel="stylesheet" href="inimigos.css?v=3.6">
    <link href="[https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap](https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap)" rel="stylesheet">
</head>
<body>

    <div id="login-screen">
        <div class="login-box" id="fase-selecao">
            <h1>Grim√≥rio Daggerheart</h1>
            <p>Escolha seu destino</p>
            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 20px;">
                <button type="button" class="btn-main" onclick="irParaLoginJogador()">Sou Jogador</button>
                <button type="button" class="btn-main" onclick="irParaLoginNarrador()" style="background: #8b0000; color: #fff; border: 2px solid #ff4444;">Sou Narrador</button>
            </div>
            <button type="button" onclick="forcarLogout()" style="background: transparent; color: #666; border: none; font-size: 0.8rem; margin-top: 20px;">For√ßar Logout (Reset)</button>
        </div>

        <div class="login-box" id="fase-login-jogador" style="display: none;">
            <h1>Acesso do Jogador</h1>
            <p>Insira suas credenciais</p>
            <div class="input-group">
                <input type="email" id="player-email" placeholder="Email" class="input-login">
            </div>
            <div class="input-group">
                <input type="password" id="player-pass" placeholder="Senha" class="input-login">
                <span class="toggle-password" onclick="togglePassword('player-pass')">üëÅÔ∏è</span>
            </div>
            <div id="error-msg-player"></div>
            <button type="button" class="btn-entrar" onclick="fazerLoginJogador()">Entrar</button>
            <button type="button" class="btn-voltar" onclick="voltarParaSelecao()">Voltar</button>
        </div>

        <div class="login-box" id="fase-login-narrador" style="display: none;">
            <h1>Acesso do Narrador</h1>
            <p>√Årea Restrita</p>
            <div class="input-group">
                <input type="email" id="narrador-email" placeholder="Email" class="input-login">
            </div>
            <div class="input-group">
                <input type="password" id="narrador-pass" placeholder="Senha" class="input-login">
                <span class="toggle-password" onclick="togglePassword('narrador-pass')">üëÅÔ∏è</span>
            </div>
            <div id="error-msg-narrador"></div>
            <button type="button" class="btn-entrar" onclick="fazerLoginNarrador()">Acessar Admin</button>
            <button type="button" class="btn-voltar" onclick="voltarParaSelecao()">Voltar</button>
        </div>

        <div class="login-box" id="fase-personagem" style="display: none;">
            <h1>Seus Personagens</h1>
            <p>Escolha um personagem existente ou crie um novo</p>
            <div id="lista-personagens" style="margin: 20px 0; min-height: 100px;">
                <p style="color: #888; text-align: center;">Carregando...</p>
            </div>
            <div style="border-top: 1px solid #444; padding-top: 15px; margin-top: 15px;">
                <p style="margin-bottom: 10px; color: #aaa; font-size: 0.9rem;">Criar novo personagem:</p>
                <input type="text" id="nome-personagem" placeholder="Nome do Novo Personagem" class="input-login" autocomplete="off" style="margin-bottom: 10px;">
                <button type="button" class="btn-entrar" onclick="criarNovoPersonagem()">Criar e Jogar</button>
            </div>
            <button type="button" class="btn-voltar" onclick="voltarParaSelecao()" style="margin-top: 15px;">Cancelar</button>
        </div>
    </div>

    <div id="classe-selection-modal" class="modal-selecao">
        <div class="classe-carousel-wrapper">
            <div class="selecao-header">
                <h2>Escolha sua Classe</h2>
                <p>Clique na imagem para ler as habilidades</p>
            </div>
            <div class="carousel-main">
                <button class="nav-btn prev" onclick="window.mudarClasse(-1)">‚ùÆ</button>
                <div class="card-display" onclick="window.verDetalhesClasse()">
                    <div class="card-glow"></div>
                    <img id="img-classe-perfil" src="" alt="Imagem da Classe" class="img-perfil-animada">
                    <div class="card-label">
                        <span id="nome-classe-selecao">CLASSE</span>
                    </div>
                    <div class="click-hint">üîç Clique para ver Habilidades</div>
                </div>
                <button class="nav-btn next" onclick="window.mudarClasse(1)">‚ùØ</button>
            </div>
            <div class="selecao-footer">
                <div class="carousel-dots" id="carousel-dots"></div>
                <button class="btn-confirmar-final" onclick="window.confirmarSelecaoClasse()">
                    ‚úì Confirmar <span id="btn-nome-classe">Classe</span>
                </button>
            </div>
        </div>
    </div>

    <div id="modal-detalhes-classe" class="modal" style="z-index: 7000;">
        <div class="modal-detalhes-content">
            <button class="close-detalhes" onclick="window.fecharDetalhesClasse()">X</button>
            <div class="pdf-wrapper">
                <button class="nav-pdf-btn prev" id="btn-pdf-prev" onclick="window.mudarPaginaPDF(-1)">‚ùÆ</button>
                <div class="pdf-container">
                    <img id="img-classe-pdf" src="" alt="Detalhes da Classe">
                </div>
                <button class="nav-pdf-btn next" id="btn-pdf-next" onclick="window.mudarPaginaPDF(1)">‚ùØ</button>
            </div>
            <div class="detalhes-footer">
                <div class="page-counter" id="pdf-page-counter">P√°gina 1 de 2</div>
                <button class="btn-confirmar-final" onclick="window.confirmarSelecaoClasseDeDentro()">
                    Escolher esta Classe
                </button>
            </div>
        </div>
    </div>

    <div id="sheet-modal" class="modal">
        <div class="sheet-content">
            <div class="sheet-toolbar">
                <button class="tool-btn active" onclick="selecionarFerramenta('texto')" title="Texto (T)">T</button>
                <button class="tool-btn" onclick="selecionarFerramenta('marcador')" title="Marcador (Bolinha)">‚óè</button>
                <div style="height: 1px; background: #444; width: 100%; margin: 5px 0;"></div>
                <button class="tool-btn" onclick="limparPaginaAtual()" title="Limpar P√°gina" style="color: #ff6666;">üóëÔ∏è</button>
            </div>
            <button class="btn-close-sheet" onclick="fecharFicha()" title="Fechar">X</button>
            <div class="sheet-container" id="sheet-container">
                <img id="sheet-bg" src="" alt="Ficha">
                <div id="sheet-inputs-layer"></div>
            </div>
            <div class="sheet-footer">
                <button class="nav-simple-btn" onclick="mudarPaginaFicha(-1)">‚ùÆ Anterior</button>
                <span id="sheet-page-indicator">P√°gina 1</span>
                <button class="nav-simple-btn" onclick="mudarPaginaFicha(1)">Pr√≥xima ‚ùØ</button>
            </div>
        </div>
    </div>

    <div id="hover-preview" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 350px; height: 525px; background-size: contain; background-repeat: no-repeat; background-position: center; border-radius: 12px; box-shadow: 0 20px 60px rgba(255, 215, 0, 0.8); border: 3px solid var(--gold); pointer-events: none; z-index: 99999;"></div>
    <div id="hover-preview-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 350px; height: 525px; background-size: contain; background-repeat: no-repeat; background-position: center; border-radius: 12px; box-shadow: 0 20px 60px rgba(212, 175, 55, 0.8); border: 3px solid var(--gold); pointer-events: none; z-index: 99999;"></div>
    <div id="hover-preview-slot" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; height: 600px; background-size: contain; background-repeat: no-repeat; background-position: center; border-radius: 12px; box-shadow: 0 20px 60px rgba(212, 175, 55, 0.8); border: 3px solid var(--gold); pointer-events: none; z-index: 99999;"></div>

    <div id="app-container" style="display: none; opacity: 0;">
        <div id="aura-profissao"></div>
        <div id="particulas-profissao"></div>

        <div id="audio-control">
            <button onclick="toggleMusic()" id="btn-music">üîä</button>
            <input type="range" id="volume" min="0" max="1" step="0.01" value="0.05" oninput="setVolume()">
        </div>
        <audio id="bg-music" loop><source src="audio/jornada.mp3" type="audio/mpeg"></audio>
        <audio id="use-card-sound"><source src="audio/use-card.mp3" type="audio/mpeg"></audio>
        <div id="system-message"></div>

        <div id="area-inimigos"></div>

        <div id="area-jogo">
            <section id="mesa-area">
                <div class="grupo-fixo">
                    <div class="titulo-grupo">Identidade</div>
                    <div class="slots-row">
                        <div class="slot-fixo" onclick="abrirGrimorio('Ancestralidade', 'Ancestralidade')" id="slot-Ancestralidade">
                            <span class="label-slot">Ancestralidade</span>
                            <button class="btn-limpar" onclick="limparSlot('Ancestralidade', event)">√ó</button>
                        </div>
                        <div class="slot-fixo" onclick="abrirGrimorio('Comunidade', 'Comunidade')" id="slot-Comunidade">
                            <span class="label-slot">Comunidade</span>
                            <button class="btn-limpar" onclick="limparSlot('Comunidade', event)">√ó</button>
                        </div>
                    </div>
                </div>
                <div class="grupo-fixo destaque-classe">
                    <div class="titulo-grupo">Evolu√ß√£o de Subclasse</div>
                    <div class="slots-row">
                        <div class="slot-classe" onclick="abrirGrimorio('Classes', 'Fundamental')" id="slot-Fundamental">
                            <span class="label-slot">Fundamental</span> <span class="nivel-req">N√≠vel 1</span>
                            <button class="btn-limpar" onclick="limparSlot('Fundamental', event)">√ó</button>
                        </div>
                        <div class="seta-evolucao">‚ûú</div>
                        <div class="slot-classe" onclick="abrirGrimorio('Classes', 'Especializacao')" id="slot-Especializacao">
                            <span class="label-slot">Especializa√ß√£o</span> <span class="nivel-req">Avan√ßo</span>
                            <button class="btn-limpar" onclick="limparSlot('Especializacao', event)">√ó</button>
                        </div>
                        <div class="seta-evolucao">‚ûú</div>
                        <div class="slot-classe" onclick="abrirGrimorio('Classes', 'Maestria')" id="slot-Maestria">
                            <span class="label-slot">Maestria</span> <span class="nivel-req">Avan√ßo</span>
                            <button class="btn-limpar" onclick="limparSlot('Maestria', event)">√ó</button>
                        </div>
                    </div>
                </div>
            </section>
            <div id="deck-container-wrapper">
                <div id="deck-area" onclick="abrirGrimorio('Geral')">
                    <div class="pote-glow"></div>
                    <img src="img/pote_deck.png" alt="Deck" class="pote-img">
                    <div class="label-deck">Grim√≥rio</div>
                </div>
            </div>
            <section id="reserva-area">
                <div class="titulo-reserva">Reserva (Inativas)</div>
                <div id="cartas-reserva"></div>
            </section>
        </div> 
        <footer id="mao-area">
            <div id="cartas-mao"></div>
            
            <button onclick="window.abrirFichaPersonagem()" style="
                position: absolute; bottom: 20px; right: 20px; z-index: 2000; pointer-events: auto;
                padding: 10px 20px; background: var(--gold); border: 2px solid #fff; border-radius: 5px;
                cursor: pointer; font-weight: bold; font-family: 'MedievalSharp', cursive;
                font-size: 1rem; box-shadow: 0 0 10px rgba(0,0,0,0.8); color: #000;
            ">
                üìù Ficha
            </button>
        </footer>
        
        <div id="btn-abrir-dados" onclick="abrirSeletorDados()" title="Rolar Dados">üé≤</div>
        
        <div id="carta-tabuleiro-animada" class="carta-tabuleiro-animada"></div>
    </div>

    <div id="modal-selecao-dados" onclick="if(event.target===this) fecharSeletorDados()">
        <div class="dados-content">
            <div class="dados-header">Rolagem de Dados</div>
            <div class="dualidade-box">
                <span style="color:#ddd; font-size: 0.9rem;">Teste de A√ß√£o (2d12)</span>
                <button class="btn-dualidade" onclick="adicionarDualidade()">‚ö° Rolar Dualidade</button>
            </div>
            <hr style="border: 0; border-top: 1px solid #444; width: 100%;">
            <div class="grid-dados">
                <div class="dado-control"><span class="dado-label">d4</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d4', -1)">-</button><span id="count-d4" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d4', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d6</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d6', -1)">-</button><span id="count-d6" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d6', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d8</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d8', -1)">-</button><span id="count-d8" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d8', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d10</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d10', -1)">-</button><span id="count-d10" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d10', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d12</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d12', -1)">-</button><span id="count-d12" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d12', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d20</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d20', -1)">-</button><span id="count-d20" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d20', 1)">+</button></div></div>
            </div>
            <button class="btn-rolar-final" onclick="rolarDadosConfirmados()">Rolar Selecionados</button>
        </div>
    </div>

    <div id="overlay-rolagem">
        <div id="quem-rolou-label"></div>
        <div id="container-dados-rolando"></div>
        <button id="btn-fechar-rolagem" onclick="fecharResultadoRolagem()">Fechar Resultado</button>
    </div>

    <div id="grimorio-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-titulo">Escolha uma Carta</h2>
                <button class="close-btn" onclick="fecharGrimorio()">X</button>
            </div>
            <div id="grid-cartas"></div>
        </div>
    </div>

    <div id="decisao-modal" class="modal" style="z-index: 6000;">
        <div class="modal-decisao-content">
            <h3>Gerenciar Carta</h3>
            <div class="carta-preview-decisao" id="preview-decisao"></div>
            <div class="grupo-tokens">
                <span>Tokens:</span>
                <button class="btn-token" onclick="alterarToken(-1)">-</button>
                <span id="label-token-qtd">0</span>
                <button class="btn-token" onclick="alterarToken(1)">+</button>
            </div>
            <div class="grupo-tokens">
                <button class="btn-estado" onclick="definirEstado('curto')">Descanso Curto</button>
                <button class="btn-estado" onclick="definirEstado('longo')">Descanso Longo</button>
            </div>
            <div class="botoes-decisao">
                <button class="btn-usar-carta" id="btn-usar-carta" onclick="usarCarta()" style="display: none;">‚ö° Usar Carta</button>
                <button class="btn-confirmar" onclick="confirmarEdicao()">OK / Voltar</button>
                <button class="btn-reserva" id="btn-para-reserva" onclick="moverParaReserva()" style="display: none;">Para Reserva</button>
                <button class="btn-deck" id="btn-devolver-mao" onclick="devolverParaMao()" style="display: none;">Devolver √† M√£o</button>
                <button class="btn-deck" id="btn-devolver-deck" onclick="devolverAoDeck()" style="display: none;">Devolver ao Deck</button>
            </div>
        </div>
    </div>

    <div id="reserva-modal" class="modal" style="z-index: 6000;">
        <div class="modal-reserva-content">
            <div class="modal-header">
                <h2 id="modal-titulo-reserva">Cartas em Reserva</h2>
                <button class="close-btn" onclick="window.fecharReserva()">X</button>
            </div>
            <div id="grid-reserva"></div>
        </div>
    </div>

    <div id="troca-modal" class="modal" style="z-index: 6100;">
        <div class="modal-decisao-content">
            <h3>Sua m√£o est√° cheia!</h3>
            <p style="color: #aaa; margin: 10px 0;">Escolha qual carta descartar:</p>
            <div id="grid-troca" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 15px 0; max-height: 300px; overflow-y: auto;"></div>
            <div class="botoes-decisao">
                <button class="btn-confirmar" onclick="window.cancelarTroca()">Cancelar</button>
            </div>
        </div>
    </div>

    <script type="module" src="script.js?v=10.2"></script>
    <script type="module">
        // EXPOSI√á√ÉO GLOBAL CR√çTICA PARA DADOS.JS, FICHA.JS e INIMIGOS.JS
        import { getDatabase, ref, push, query, limitToLast, onChildAdded, set, get, remove, onValue, update } from "[https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js](https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js)";
        
        window.db = getDatabase(); 
        window.ref = ref;
        window.push = push;
        window.query = query;
        window.limitToLast = limitToLast;
        window.onChildAdded = onChildAdded;
        window.set = set;
        window.get = get;
        window.remove = remove;
        window.onValue = onValue;
        window.update = update;

        // Inicia escuta de rolagens e inimigos
        // CORRE√á√ÉO DE SYNC: Chama logo ap√≥s carregar
        setTimeout(() => {
            if(window.escutarRolagens) window.escutarRolagens();
        }, 3000);
    </script>
    
    <script src="profissao.js?v=1.0"></script>
    <script src="selecao-classe.js?v=3.0"></script>
    <script src="ficha.js?v=4.0"></script>
    <script src="dados.js?v=2.0"></script>
    <script src="inimigos.js?v=4.0"></script>
</body>
</html>