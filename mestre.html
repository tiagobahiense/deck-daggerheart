<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesa de Jogo - Daggerheart</title>
    <link rel="stylesheet" href="style.css?v=8.0">
    <link rel="stylesheet" href="ficha.css?v=4.0">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        #container-principal {
            display: flex;
            flex: 1;
            overflow: visible;
            gap: 0;
            position: relative;
        }

        #area-jogadores {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: visible;
            border-right: 2px solid var(--gold);
            min-width: 0;
            position: relative;
        }

        #painel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            height: 85vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px 12px 50px 12px;
            align-content: start;
            align-items: start;
        }

        .card-jogador {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--gold);
            border-radius: 6px;
            padding: 5px;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .card-jogador:hover {
            z-index: 50;
        }

        /* Bot√£o de Ficha no Card do Jogador */
        .btn-abrir-ficha-mestre {
            position: absolute;
            top: 2px;
            right: 2px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--gold);
            z-index: 10;
            transition: transform 0.2s;
        }
        .btn-abrir-ficha-mestre:hover {
            transform: scale(1.2);
            text-shadow: 0 0 5px var(--gold);
        }

        .card-jogador .nome {
            font-weight: bold;
            color: var(--gold);
            margin: 0;
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 25px; /* Espa√ßo para o bot√£o da ficha */
        }

        .card-jogador .label {
            font-size: 0.6rem;
            color: #999;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-jogador .grid-mini {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
        }

        #preview-carta-mestre {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 420px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border: 3px solid var(--gold);
            border-radius: 8px;
            z-index: 2000;
            background-color: #000;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            pointer-events: none;
        }

        #controles-mestre {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid var(--gold);
            gap: 10px;
            position: relative;
            z-index: 100;
        }

        #controles-mestre > div {
            display: flex;
            gap: 10px;
        }

        .btn-nav-mestre {
            background: #333;
            color: #fff;
            padding: 8px 15px;
            border: 1px solid #555;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .btn-nav-mestre:hover {
            background: #555;
        }

        /* SIDEBAR ESCUDO */
        #sidebar-escudo {
            width: 220px;
            background: rgba(0, 0, 0, 0.8);
            border-left: 2px solid var(--gold);
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #sidebar-escudo h3 {
            color: var(--gold);
            font-size: 0.9rem;
            margin: 0;
            text-align: center;
        }

        .escudo-topicos {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .btn-topico {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--gold);
            color: #fff;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            text-align: left;
            transition: 0.2s;
        }

        .btn-topico:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: #ffff99;
        }

        /* MODAL ESCUDO */
        #modal-escudo {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 5000;
            justify-content: center;
            align-items: center;
        }

        #modal-escudo.ativo {
            display: flex;
        }

        .modal-escudo-content {
            background: rgba(20, 20, 20, 0.95);
            border: 2px solid var(--gold);
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.9);
            position: relative;
        }

        .modal-escudo-content h2 {
            color: var(--gold);
            margin-top: 0;
        }

        .modal-escudo-content h3 {
            color: #ffff99;
            margin-top: 15px;
        }

        .modal-escudo-content p, .modal-escudo-content li {
            color: #ddd;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .modal-escudo-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .modal-escudo-content li {
            margin: 4px 0;
        }

        .modal-escudo-content code {
            background: rgba(255, 215, 0, 0.1);
            padding: 2px 5px;
            border-radius: 3px;
            color: #ffff99;
        }

        #btn-fechar-escudo {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--gold);
            color: #000;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        #btn-fechar-escudo:hover {
            background: #ffff99;
        }

        #carta-usada-animada {
            position: fixed;
            width: 200px;
            height: 300px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 10px;
            pointer-events: none;
            display: none;
            z-index: 9999;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.8);
        }

        #carta-usada-animada.ativa {
            animation: carta-usar 2.5s ease-in-out forwards;
        }

        @keyframes carta-usar {
            0% { opacity: 1; transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 0px rgba(0, 255, 0, 0)); }
            20% { opacity: 1; transform: scale(1.1) rotate(0deg); filter: drop-shadow(0 0 30px rgba(0, 255, 0, 0.8)); }
            50% { opacity: 1; transform: scale(1.5) rotate(-5deg); filter: drop-shadow(0 0 50px rgba(0, 255, 0, 1)); }
            55% { transform: scale(1.5) rotate(5deg); }
            60% { transform: scale(1.5) rotate(-5deg); }
            65% { transform: scale(1.5) rotate(5deg); }
            70% { transform: scale(1.5) rotate(-3deg); }
            100% { opacity: 0; transform: scale(1.5) rotate(0deg); filter: drop-shadow(0 0 50px rgba(0, 255, 0, 0.5)); }
        }

        @keyframes mini-carta-usar {
            0% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(0, 255, 0, 0)); }
            30% { transform: scale(1.15); filter: drop-shadow(0 0 15px rgba(0, 255, 0, 0.8)); }
            50% { transform: scale(1.2); filter: drop-shadow(0 0 25px rgba(0, 255, 0, 1)); }
            70% { transform: scale(1.15); filter: drop-shadow(0 0 15px rgba(0, 255, 0, 0.8)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 0px rgba(0, 255, 0, 0)); }
        }
    </style>
</head>
<body>
    <div id="preview-carta-mestre"></div>

    <div id="controles-mestre">
        <div>
            <button class="btn-rest curto" onclick="realizarDescanso('curto')">Descanso Curto</button>
            <button class="btn-rest longo" onclick="realizarDescanso('longo')">Descanso Longo</button>
        </div>
        <button class="btn-nav-mestre" onclick="window.location.href='admin.html'">Painel Admin</button>
    </div>

    <div id="container-principal">
        <div id="area-jogadores">
            <div id="painel">
                <p>Carregando jogadores...</p>
            </div>
        </div>

        <div id="sidebar-escudo">
            <h3>üõ°Ô∏è ESCUDO DO MESTRE</h3>
            <div class="escudo-topicos">
                <button class="btn-topico" onclick="exibirTopico('testes')">üé≤ Testes & Dualidade</button>
                <button class="btn-topico" onclick="exibirTopico('recursos')">üíé Recursos do Jogador</button>
                <button class="btn-topico" onclick="exibirTopico('combate')">‚öîÔ∏è Combate</button>
                <button class="btn-topico" onclick="exibirTopico('dano')">ü©∏ Dano & Limiares</button>
                <button class="btn-topico" onclick="exibirTopico('armadura')">üõ°Ô∏è Armadura (PA)</button>
                <button class="btn-topico" onclick="exibirTopico('morte')">‚ò†Ô∏è Morte</button>
                <button class="btn-topico" onclick="exibirTopico('distancia')">üìè Dist√¢ncia & Movimento</button>
                <button class="btn-topico" onclick="exibirTopico('descanso')">üí§ Descanso</button>
                <button class="btn-topico" onclick="exibirTopico('mestre')">üíÄ O Mestre (GM)</button>
            </div>
        </div>
    </div>

    <div id="modal-escudo">
        <div class="modal-escudo-content">
            <button id="btn-fechar-escudo" onclick="fecharEscudo()">√ó</button>
            <div id="escudo-conteudo"></div>
        </div>
    </div>

    <div id="sheet-modal" class="modal">
        <div class="sheet-content">
            
            <div class="sheet-toolbar">
                <button class="tool-btn active" onclick="selecionarFerramenta('texto')" title="Texto (T)">T</button>
                <button class="tool-btn" onclick="selecionarFerramenta('marcador')" title="Marcador (Bolinha)">‚óè</button>
                <div style="height: 1px; background: #444; width: 100%; margin: 5px 0;"></div>
                <button class="tool-btn" onclick="limparPaginaAtual()" title="Limpar P√°gina" style="color: #ff6666;">üóëÔ∏è</button>
            </div>

            <button class="btn-close-sheet" onclick="fecharFicha()" title="Fechar">X</button>
            
            <div class="sheet-container" id="sheet-container">
                <img id="sheet-bg" src="" alt="Ficha">
                <div id="sheet-inputs-layer"></div>
            </div>
            
            <div class="sheet-footer">
                <button class="nav-simple-btn" onclick="mudarPaginaFicha(-1)">‚ùÆ Anterior</button>
                <span id="sheet-page-indicator">P√°gina 1</span>
                <button class="nav-simple-btn" onclick="mudarPaginaFicha(1)">Pr√≥xima ‚ùØ</button>
            </div>
        </div>
    </div>

    <div id="carta-usada-animada" class="carta-tabuleiro-animada"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, get, onChildChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATWkyYE6b3wyz3LdFXAmxKxNQOexa_vUY",
            authDomain: "deck-daggerheart.firebaseapp.com",
            databaseURL: "https://deck-daggerheart-default-rtdb.firebaseio.com",
            projectId: "deck-daggerheart",
            storageBucket: "deck-daggerheart.firebasestorage.app",
            messagingSenderId: "825358776791",
            appId: "1:825358776791:web:ce0ab844f58c60573c7392",
            measurementId: "G-20TB05E9N2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- EXPOR FIREBASE PARA O FICHA.JS ---
        // O ficha.js precisa dessas fun√ß√µes no escopo global para funcionar
        window.db = db;
        window.ref = ref;
        window.set = set;
        window.get = get;
        window.remove = remove;
        window.onValue = onValue;
        // -------------------------------------

        const EMAIL_MESTRE = "tgbahiense@gmail.com";

        window.fazerLogout = function() {
            signOut(auth).then(() => window.location.href = "index.html");
        }

        // Fun√ß√£o para abrir a ficha do jogador pelo Mestre
        window.abrirFichaDoJogador = function(nomePersonagem) {
            console.log("Mestre abrindo ficha de:", nomePersonagem);
            
            // 1. Define globalmente quem √© o "jogador" atual para o ficha.js
            window.nomeJogador = nomePersonagem;

            // 2. Busca a classe do personagem para saber qual imagem carregar
            const slotRef = ref(db, `mesa_rpg/jogadores/${nomePersonagem}/slots/Fundamental`);
            get(slotRef).then(snapshot => {
                if(snapshot.exists() && snapshot.val().profissao) {
                    const profissao = snapshot.val().profissao;
                    
                    // Salva no localStorage para o ficha.js ler
                    localStorage.setItem('profissaoSelecionada', profissao);
                    
                    // Chama a fun√ß√£o do ficha.js para abrir o modal
                    if(typeof window.abrirFichaPersonagem === 'function') {
                        window.abrirFichaPersonagem();
                    } else {
                        alert("Erro: Script da ficha n√£o carregado.");
                    }
                } else {
                    alert(`O personagem ${nomePersonagem} ainda n√£o selecionou uma classe.`);
                }
            }).catch(e => {
                console.error("Erro ao buscar classe:", e);
                alert("Erro ao abrir ficha.");
            });
        };

        window.realizarDescanso = function(tipo) {
            console.log(`üåô Restaurando descanso ${tipo} para todos os jogadores...`);
            const jogadoresRef = ref(db, 'mesa_rpg/jogadores');
            get(jogadoresRef).then(snapshot => {
                if(snapshot.exists()) {
                    const dados = snapshot.val();
                    Object.keys(dados).forEach(nome => {
                        const player = dados[nome];
                        if(player.mao) {
                            let mudou = false;
                            player.mao.forEach(carta => {
                                if(tipo === 'curto' && carta.estado === 'curto') { carta.estado = 'ativo'; mudou = true; }
                                if(tipo === 'longo' && (carta.estado === 'curto' || carta.estado === 'longo')) { carta.estado = 'ativo'; mudou = true; }
                            });
                            if(mudou) set(ref(db, `mesa_rpg/jogadores/${nome}/mao`), player.mao);
                        }
                        if (player.slots) {
                            let mudouSlots = false;
                            Object.keys(player.slots).forEach(k => {
                                const carta = player.slots[k];
                                if (!carta) return;
                                if (tipo === 'curto' && carta.estado === 'curto') { carta.estado = 'ativo'; mudouSlots = true; }
                                if (tipo === 'longo' && (carta.estado === 'curto' || carta.estado === 'longo')) { carta.estado = 'ativo'; mudouSlots = true; }
                            });
                            if (mudouSlots) set(ref(db, `mesa_rpg/jogadores/${nome}/slots`), player.slots);
                        }
                        if (player.reserva && Array.isArray(player.reserva)) {
                            let mudouRes = false;
                            player.reserva.forEach(carta => {
                                if (!carta) return;
                                if (tipo === 'curto' && carta.estado === 'curto') { carta.estado = 'ativo'; mudouRes = true; }
                                if (tipo === 'longo' && (carta.estado === 'curto' || carta.estado === 'longo')) { carta.estado = 'ativo'; mudouRes = true; }
                            });
                            if (mudouRes) set(ref(db, `mesa_rpg/jogadores/${nome}/reserva`), player.reserva);
                        }
                    });
                    console.log('‚ú® Descanso restaurado para todos!');
                }
            }).catch(error => console.error('‚ùå Erro ao restaurar descanso:', error));
        }

        onAuthStateChanged(auth, (user) => {
            if (!user) { window.location.href = "index.html"; return; }
            const currentEmail = user.email.toLowerCase().trim();
            const masterEmail = EMAIL_MESTRE.toLowerCase().trim();
            if (currentEmail !== masterEmail) { window.location.href = "index.html"; return; }
            iniciarPainel();
            configurarListenersDeCartasUsadas();
        });

        function iniciarPainel() {
            const jogadoresRef = ref(db, 'mesa_rpg/jogadores');
            const accountsRef = ref(db, 'mesa_rpg/accounts');
            let nomesDePersonagens = new Set();
            let cacheJogadores = {};

            function render() {
                console.log('üîÑ Render mestre (accounts + jogadores)...');
                const painel = document.getElementById('painel');
                const nomes = Array.from(nomesDePersonagens);
                if (nomes.length === 0) {
                    painel.innerHTML = "<p class='status-vazio'>Nenhum personagem cadastrado.</p>";
                    return;
                }

                painel.innerHTML = "";
                nomes.sort().forEach(nome => {
                    const p = cacheJogadores[nome] || {};
                    const card = document.createElement('div');
                    card.className = 'card-jogador';

                    let htmlMao = "";
                    if(p.mao && p.mao.length > 0) {
                        p.mao.forEach((c, idx) => {
                            let classes = "mini-carta";
                            let tooltip = c.nome;
                            let descansoIcon = "";
                            if(c.estado === 'curto') { classes += " indisponivel"; tooltip += " (Recarga: Descanso Curto)"; descansoIcon = `<div class="icone-descanso-mini icone-descanso-curto-mini"><img src="img/meia-lua.png" alt="Descanso Curto"></div>`; }
                            if(c.estado === 'longo') { classes += " indisponivel"; tooltip += " (Recarga: Descanso Longo)"; descansoIcon = `<div class="icone-descanso-mini icone-descanso-longo-mini"><img src="img/lua-cheia.png" alt="Descanso Longo"></div>`; }
                            let tokensHTML = c.tokens > 0 ? `<div class="token-count">${c.tokens}</div>` : "";
                            htmlMao += `<div class="${classes}" style="background-image: url('${c.caminho}')" title="${tooltip}">${descansoIcon}${tokensHTML}</div>`;
                        });
                    } else { htmlMao = "<span class='status-vazio'>M√£o vazia</span>"; }

                    let htmlSlots = "";
                    if(p.slots) {
                        ['Ancestralidade', 'Comunidade', 'Fundamental', 'Especializacao', 'Maestria'].forEach(key => {
                            if(p.slots[key]) {
                                htmlSlots += `<div class="mini-carta slot-ativo" style="background-image: url('${p.slots[key].caminho}')" title="${key}: ${p.slots[key].nome}"></div>`;
                            }
                        });
                    }
                    if(htmlSlots === "") htmlSlots = "<span class='status-vazio'>Nenhum ativo</span>";

                    let htmlReserva = "";
                    if(p.reserva && p.reserva.length > 0) {
                        htmlReserva = `<div class="label">Reserva (${p.reserva.length})</div>`;
                        let cartasReservaHTML = "";
                        p.reserva.forEach(c => {
                            cartasReservaHTML += `<div class="mini-carta carta-reserva-visual" style="background-image: url('${c.caminho}')" title="Reserva: ${c.nome}"></div>`;
                        });
                        htmlReserva += `<div class="grid-mini">${cartasReservaHTML}</div>`;
                    }

                    // Bot√£o da Ficha do Jogador
                    // AQUI EST√Å A M√ÅGICA: O bot√£o chama abrirFichaDoJogador passando o nome
                    // Tratamento de aspas no nome para o onclick
                    const safeName = nome.replace(/'/g, "\\'");
                    const btnFicha = `<button class="btn-abrir-ficha-mestre" onclick="window.abrirFichaDoJogador('${safeName}')" title="Abrir Ficha de ${nome}">üìù</button>`;

                    let classeTag = '';
                    if(p.slots && p.slots.Fundamental && p.slots.Fundamental.profissao) {
                        const profissao = p.slots.Fundamental.profissao;
                        classeTag = `<span style="background: rgba(212, 175, 55, 0.3); color: #d4af37; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px; border: 1px solid rgba(212, 175, 55, 0.6); font-weight: bold;">${profissao}</span>`;
                    }
                    
                    card.innerHTML = `
                        ${btnFicha}
                        <div class="nome">${nome}${classeTag}</div>
                        <div class="label">M√£o (${p.mao ? p.mao.length : 0})</div>
                        <div class="grid-mini" data-jogador="${nome}">${htmlMao}</div>
                        <div class="label">Mesa (Ativos)</div>
                        <div class="grid-mini">${htmlSlots}</div>
                        ${htmlReserva}
                    `;
                    painel.appendChild(card);
                });
            }

            onValue(accountsRef, (snap) => {
                const setNomes = new Set();
                if (snap.exists()) {
                    snap.forEach(childSnap => {
                        const data = childSnap.val();
                        if (!data || data.status === 'inactive') return;
                        if (data.characters) Object.keys(data.characters).forEach(n => setNomes.add(String(n).toUpperCase()));
                    });
                }
                nomesDePersonagens = setNomes;
                render();
            });

            onValue(jogadoresRef, (snapshot) => {
                cacheJogadores = snapshot.exists() ? (snapshot.val() || {}) : {};
                Object.keys(cacheJogadores || {}).forEach(n => nomesDePersonagens.add(String(n).toUpperCase()));
                render();
            });
        }

        function configurarListenersDeCartasUsadas() {
            const jogadoresRef = ref(db, 'mesa_rpg/jogadores');
            get(jogadoresRef).then(snapshot => {
                if(snapshot.exists()) {
                    const dados = snapshot.val();
                    Object.keys(dados).forEach(nomeJogador => configurarListenerIndividualDoJogador(nomeJogador));
                }
            });
            onChildChanged(jogadoresRef, (snapshot) => {
                configurarListenerIndividualDoJogador(snapshot.key);
            });
        }

        function configurarListenerIndividualDoJogador(nomeJogador) {
            const cartaUsadaRef = ref(db, `mesa_rpg/jogadores/${nomeJogador}/cartaUsada`);
            onValue(cartaUsadaRef, (snapshot) => {
                if(snapshot.exists()) {
                    animarCartaEspecifica(nomeJogador, snapshot.val());
                }
            });
        }

        function animarCartaEspecifica(nomeJogador, cartaUsada) {
            const gridMao = document.querySelector(`[data-jogador="${nomeJogador}"]`);
            if(!gridMao) return;
            const cartas = gridMao.querySelectorAll('.mini-carta');
            let cartaEncontrada = null;
            for(let carta of cartas) {
                const bgImage = carta.style.backgroundImage;
                if(bgImage) {
                    const caminhoExtraido = bgImage.replace(/url\(['"]?([^'")]+)['"]?\)/g, '$1');
                    if(caminhoExtraido === cartaUsada.caminho || caminhoExtraido.includes(cartaUsada.caminho.split('/').pop())) {
                        cartaEncontrada = carta;
                        break;
                    }
                }
            }
            if(cartaEncontrada) {
                cartaEncontrada.style.animation = 'none';
                void cartaEncontrada.offsetWidth;
                cartaEncontrada.style.animation = 'mini-carta-usar 0.8s ease-out';
                setTimeout(() => { cartaEncontrada.style.animation = 'none'; }, 800);
            }
        }

        // Fun√ß√µes do Escudo (Mantidas resumidas para n√£o estourar limite)
        const topicos = {
            testes: { titulo: "üé≤ TESTES", conteudo: "<h2>üé≤ TESTES & DUALIDADE</h2><p>2d12 (Esperan√ßa+Medo). Se Esperan√ßa > Medo = Ganha Esperan√ßa. Se Medo > Esperan√ßa = GM ganha Medo.</p>" },
            recursos: { titulo: "üíé RECURSOS", conteudo: "<h2>üíé RECURSOS</h2><p>Esperan√ßa: +1d6, Tag Team. Fadiga: Custo de habilidade, Dano.</p>" },
            combate: { titulo: "‚öîÔ∏è COMBATE", conteudo: "<h2>‚öîÔ∏è COMBATE</h2><p>Role contra Evas√£o. Dano vs Limiares. Dist√¢ncias: C-a-C, Muito Pr√≥ximo, Pr√≥ximo, Distante.</p>" },
            dano: { titulo: "ü©∏ DANO", conteudo: "<h2>ü©∏ DANO</h2><p>Menor (1PV), Maior (2PV), Grave (3PV). Armor reduz.</p>" },
            armadura: { titulo: "üõ°Ô∏è ARMADURA", conteudo: "<h2>üõ°Ô∏è ARMADURA</h2><p>Queime slots de armadura para reduzir dano recebido.</p>" },
            morte: { titulo: "‚ò†Ô∏è MORTE", conteudo: "<h2>‚ò†Ô∏è MORTE</h2><p>Op√ß√µes ao cair: Arriscar, Evitar (Cicatriz), Sacrif√≠cio.</p>" },
            distancia: { titulo: "üìè DIST√ÇNCIA", conteudo: "<h2>üìè DIST√ÇNCIA</h2><p>Melee, Very Close, Close, Far, Very Far.</p>" },
            descanso: { titulo: "üí§ DESCANSO", conteudo: "<h2>üí§ DESCANSO</h2><p>Curto: Repara Armor, cura um pouco. Longo: Full reset.</p>" },
            mestre: { titulo: "üíÄ GM", conteudo: "<h2>üíÄ O MESTRE</h2><p>Fa√ßa movimentos quando eles falham ou rolam com Medo.</p>" }
        };

        window.exibirTopico = function(id) {
            if(topicos[id]) {
                document.getElementById('escudo-conteudo').innerHTML = topicos[id].conteudo;
                document.getElementById('modal-escudo').classList.add('ativo');
            }
        }
        window.fecharEscudo = function() { document.getElementById('modal-escudo').classList.remove('ativo'); }
        document.getElementById('modal-escudo').addEventListener('click', function(e) { if(e.target===this) fecharEscudo(); });

        document.addEventListener('mouseover', (e) => {
            const carta = e.target.closest('.mini-carta');
            if (carta && !carta.classList.contains('status-vazio')) {
                const preview = document.getElementById('preview-carta-mestre');
                if (preview && carta.style.backgroundImage) {
                    preview.style.backgroundImage = carta.style.backgroundImage;
                    preview.style.display = 'flex';
                }
            }
        });
        document.addEventListener('mouseout', (e) => {
            if (e.target.closest('.mini-carta')) document.getElementById('preview-carta-mestre').style.display = 'none';
        });
    </script>

    <script src="ficha.js?v=4.0"></script>
</body>
</html>