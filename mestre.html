<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mestre - Daggerheart</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        * { user-select: none; -webkit-user-drag: none; box-sizing: border-box; }
        body { background: #111; color: #d4af37; font-family: 'MedievalSharp', cursive; margin: 0; padding: 20px; }
        
        #login-screen-mestre {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('img/background_epico.png') no-repeat center center/cover;
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .start-content {
            background: rgba(0, 0, 0, 0.85); padding: 40px;
            border: 2px solid #d4af37; border-radius: 15px;
            text-align: center; box-shadow: 0 0 50px rgba(0, 0, 0, 0.8); width: 350px;
        }
        .input-login {
            display: block; width: 90%; margin: 15px auto; padding: 10px;
            font-size: 1rem; border-radius: 5px; border: none; text-align: center;
        }
        .btn-entrar {
            background: #8b0000; color: #fff; border: 2px solid #ff4444; padding: 10px 30px;
            font-family: inherit; font-size: 1.2rem; cursor: pointer; border-radius: 5px; margin-top: 10px;
        }
        .btn-entrar:hover { filter: brightness(1.2); }

        #app-mestre { display: none; }

        h1 { text-align: center; border-bottom: 1px solid #333; padding-bottom: 20px; }
        
        #controles-mestre { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .btn-rest {
            padding: 10px 20px; font-family: inherit; font-size: 1rem; cursor: pointer; border: none; border-radius: 5px; color: #fff; font-weight: bold;
        }
        .btn-rest.curto { background: #f57c00; }
        .btn-rest.longo { background: #d32f2f; }
        .btn-rest:hover { filter: brightness(1.2); }

        #painel { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        
        .card-jogador {
            background: #1a1a1a; border: 1px solid #444; border-radius: 8px; width: 320px; padding: 15px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); position: relative;
        }
        
        .nome { font-size: 1.4rem; color: #fff; text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .label { font-size: 0.8rem; color: #888; text-transform: uppercase; margin-top: 5px; border-bottom: 1px dashed #333; }
        .grid-mini { display: flex; flex-wrap: wrap; gap: 5px; min-height: 40px; }
        
        .mini-carta {
            width: 50px; height: 75px; background-size: contain; background-repeat: no-repeat; background-position: center; border: 1px solid #333; border-radius: 4px; transition: 0.2s; cursor: pointer; background-color: #000; position: relative;
        }
        .mini-carta:hover { transform: scale(4); z-index: 100; border-color: gold; box-shadow: 0 0 20px #000; }
        .mini-carta:hover::after {
            content: attr(title); position: absolute; top: -20px; left: 0; background: #000; padding: 2px 5px; font-size: 0.5rem; white-space: nowrap; z-index: 101; pointer-events: none;
        }

        .indisponivel { filter: grayscale(100%) brightness(50%); border-color: #555; }
        .indisponivel:hover { filter: grayscale(0); }

        .token-count {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 18px; height: 18px; background: #fff; color: #000; 
            border-radius: 50%; font-size: 0.7rem; display: flex; 
            align-items: center; justify-content: center; 
            border: 1px solid #000; font-weight: bold; z-index: 10;
        }

        .carta-reserva-visual { opacity: 0.7; filter: grayscale(0.6); pointer-events: none; }
        .carta-reserva-visual:hover { opacity: 1; filter: grayscale(0); }
        .slot-ativo { border-color: #d4af37; box-shadow: 0 0 5px rgba(212, 175, 55, 0.3); pointer-events: none; }
        .status-vazio { font-size: 0.7rem; color: #444; font-style: italic; padding: 10px; }

        .btn-banir { margin-top: 15px; background-color: #3e0000; color: #ff6666; border: 1px solid #500; padding: 8px; cursor: pointer; font-family: inherit; border-radius: 4px; transition: 0.2s; font-size: 0.8rem; }
        .btn-banir:hover { background-color: #800; color: white; border-color: red; }
    </style>
</head>
<body>

    <div id="login-screen-mestre">
        <div class="start-content">
            <h1>Acesso do Narrador</h1>
            <input type="text" id="mestre-login" placeholder="Login" class="input-login">
            <input type="password" id="mestre-pass" placeholder="Senha" class="input-login">
            <button class="btn-entrar" onclick="verificarCredenciais()">Entrar</button>
            <br>
            <button onclick="window.location.href='index.html'" style="background:transparent; border:1px solid #666; font-size:0.8rem; margin-top:15px; color:#aaa;">Voltar</button>
        </div>
    </div>

    <div id="app-mestre">
        <h1>VisÃ£o do Narrador</h1>
        
        <div id="controles-mestre">
            <button class="btn-rest curto" onclick="realizarDescanso('curto')">Restaurar Descanso Curto</button>
            <button class="btn-rest longo" onclick="realizarDescanso('longo')">Restaurar Descanso Longo</button>
        </div>

        <div id="painel">Conectando ao GrimÃ³rio...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATWkyYE6b3wyz3LdFXAmxKxNQOexa_vUY",
            authDomain: "deck-daggerheart.firebaseapp.com",
            databaseURL: "https://deck-daggerheart-default-rtdb.firebaseio.com",
            projectId: "deck-daggerheart",
            storageBucket: "deck-daggerheart.firebasestorage.app",
            messagingSenderId: "825358776791",
            appId: "1:825358776791:web:ce0ab844f58c60573c7392",
            measurementId: "G-20TB05E9N2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('dragstart', event => event.preventDefault());

        window.verificarCredenciais = function() {
            const l = document.getElementById('mestre-login').value;
            const s = document.getElementById('mestre-pass').value;
            
            if (l === 'tgzinho2207' && s === 'Nicknick@1') {
                document.getElementById('login-screen-mestre').style.display = 'none';
                document.getElementById('app-mestre').style.display = 'block';
            } else {
                alert("Acesso Negado.");
            }
        }

        window.removerJogador = function(nome) {
            if(confirm(`Tem certeza que deseja remover ${nome} da mesa?`)) {
                remove(ref(db, `mesa_rpg/jogadores/${nome}`));
            }
        }

        window.alternarEstadoCarta = async function(nomeJogador, cardIndex) {
            const playerRef = ref(db, `mesa_rpg/jogadores/${nomeJogador}/mao/${cardIndex}`);
            const snapshot = await get(playerRef);
            if(snapshot.exists()) {
                let carta = snapshot.val();
                let novoEstado = 'ativo';
                
                if(carta.estado === 'ativo' || !carta.estado) novoEstado = 'curto';
                else if(carta.estado === 'curto') novoEstado = 'longo';
                else if(carta.estado === 'longo') novoEstado = 'ativo';

                carta.estado = novoEstado;
                set(playerRef, carta);
            }
        }

        window.realizarDescanso = function(tipo) {
            const jogadoresRef = ref(db, 'mesa_rpg/jogadores');
            get(jogadoresRef).then(snapshot => {
                if(snapshot.exists()) {
                    const dados = snapshot.val();
                    Object.keys(dados).forEach(nome => {
                        const player = dados[nome];
                        if(player.mao) {
                            let mudou = false;
                            player.mao.forEach(carta => {
                                if(tipo === 'curto' && carta.estado === 'curto') {
                                    carta.estado = 'ativo';
                                    mudou = true;
                                }
                                if(tipo === 'longo' && (carta.estado === 'curto' || carta.estado === 'longo')) {
                                    carta.estado = 'ativo';
                                    mudou = true;
                                }
                            });
                            if(mudou) {
                                set(ref(db, `mesa_rpg/jogadores/${nome}/mao`), player.mao);
                            }
                        }
                    });
                }
            });
        }

        const jogadoresRef = ref(db, 'mesa_rpg/jogadores');

        onValue(jogadoresRef, (snapshot) => {
            const painel = document.getElementById('painel');
            const dados = snapshot.val();
            
            if(!dados) { 
                painel.innerHTML = "<p class='status-vazio'>Nenhum jogador conectado.</p>"; 
                return; 
            }
            
            painel.innerHTML = ""; 
            
            Object.keys(dados).forEach(nome => {
                const p = dados[nome];
                const card = document.createElement('div');
                card.className = 'card-jogador';
                
                let htmlMao = "";
                if(p.mao && p.mao.length > 0) {
                    p.mao.forEach((c, idx) => {
                        let classes = "mini-carta";
                        let tooltip = c.nome;
                        
                        if(c.estado === 'curto') { classes += " indisponivel"; tooltip += " (Recarga: Descanso Curto)"; }
                        if(c.estado === 'longo') { classes += " indisponivel"; tooltip += " (Recarga: Descanso Longo)"; }

                        let tokensHTML = "";
                        if(c.tokens > 0) tokensHTML = `<div class="token-count">${c.tokens}</div>`;

                        htmlMao += `<div class="${classes}" style="background-image: url('${c.caminho}')" title="${tooltip}" onclick="alternarEstadoCarta('${nome}', ${idx})">${tokensHTML}</div>`;
                    });
                } else {
                    htmlMao = "<span class='status-vazio'>MÃ£o vazia</span>";
                }

                let htmlSlots = "";
                if(p.slots) {
                    const ordem = ['Ancestralidade', 'Comunidade', 'Fundamental', 'Especializacao', 'Maestria'];
                    ordem.forEach(key => {
                        if(p.slots[key]) {
                            htmlSlots += `<div class="mini-carta slot-ativo" style="background-image: url('${p.slots[key].caminho}')" title="${key}: ${p.slots[key].nome}"></div>`;
                        }
                    });
                }
                if(htmlSlots === "") htmlSlots = "<span class='status-vazio'>Nenhum ativo</span>";

                let htmlReserva = "";
                if(p.reserva && p.reserva.length > 0) {
                     htmlReserva = `<div class="label">Reserva (${p.reserva.length})</div>`;
                     let cartasReservaHTML = "";
                     p.reserva.forEach(c => {
                         cartasReservaHTML += `<div class="mini-carta carta-reserva-visual" style="background-image: url('${c.caminho}')" title="Reserva: ${c.nome}"></div>`;
                     });
                     htmlReserva += `<div class="grid-mini">${cartasReservaHTML}</div>`;
                }

                card.innerHTML = `
                    <div class="nome">${nome}</div>
                    <div class="label">MÃ£o (${p.mao ? p.mao.length : 0})</div>
                    <div class="grid-mini">${htmlMao}</div>
                    <div class="label">Mesa (Ativos)</div>
                    <div class="grid-mini">${htmlSlots}</div>
                    ${htmlReserva}
                    <button class="btn-banir" onclick="removerJogador('${nome}')">ðŸ’€ Remover da Mesa</button>
                `;
                
                painel.appendChild(card);
            });
        });
    </script>
</body>
</html>