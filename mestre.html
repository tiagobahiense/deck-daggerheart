<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesa de Jogo - Daggerheart (GM)</title>
    <link rel="stylesheet" href="style.css?v=8.0">
    <link rel="stylesheet" href="ficha.css?v=4.0">
    <link rel="stylesheet" href="dados.css?v=2.0">
    <link rel="stylesheet" href="inimigos.css?v=3.0"> <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        body { display: flex; height: 100vh; flex-direction: column; background-color: #050505; }
        
        /* LAYOUT DE 3 COLUNAS */
        #container-principal { 
            display: flex; 
            flex: 1; 
            overflow: hidden; /* Importante para o scroll interno */
            gap: 0; 
        }
        
        /* 1. JOGADORES (ESQUERDA - 25%) */
        #area-jogadores { 
            width: 350px;
            flex-shrink: 0;
            display: flex; 
            flex-direction: column; 
            border-right: 2px solid var(--gold); 
            background: #0a0a0a;
        }
        
        #painel { 
            padding: 10px; 
            overflow-y: auto; 
            height: 100%;
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }

        /* Card Jogador Compacto para Caber na Coluna */
        .card-jogador { 
            width: 100%; 
            background: rgba(20,20,20,0.9); 
            border: 1px solid #444;
        }

        /* 2. √ÅREA DE BATALHA (CENTRO - FLEX√çVEL) */
        #area-batalha-gm {
            flex-grow: 1;
            background: url('img/background_epico.png') no-repeat center center;
            background-size: cover;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #titulo-batalha {
            background: rgba(0,0,0,0.8);
            color: var(--gold);
            text-align: center;
            padding: 5px;
            font-family: 'MedievalSharp', cursive;
            border-bottom: 1px solid var(--gold);
        }

        /* Container dos Inimigos dentro da Batalha */
        #area-inimigos {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            justify-content: center;
            gap: 15px;
        }

        /* 3. ESCUDO E DADOS (DIREITA - 25%) */
        #sidebar-escudo { 
            width: 280px; 
            flex-shrink: 0;
            background: #0f0f0f; 
            border-left: 2px solid var(--gold); 
            padding: 10px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }

        /* Ajustes Gerais */
        #controles-mestre { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background: #111; border-bottom: 2px solid var(--gold); }
        .btn-rest { font-size: 0.8rem; padding: 5px 10px; }
        
        /* Modal Criar */
        .modal-criar-content { background: #1a1a1a; width: 450px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .form-full { grid-column: 1 / -1; }
        input, textarea { width: 100%; box-sizing: border-box; background: #222; border: 1px solid #444; color: white; padding: 5px; }
        
        /* Preview Card */
        #preview-carta-mestre { display: none; position: fixed; top: 50%; left: 50%; width: 300px; height: 450px; z-index: 9999; transform: translate(-50%, -50%); border: 2px solid var(--gold); background: #000; pointer-events: none; }
    </style>
</head>
<body>

    <div id="preview-carta-mestre"></div>

    <div id="controles-mestre">
        <div>
            <button class="btn-rest curto" onclick="realizarDescanso('curto')">üåô Curto</button>
            <button class="btn-rest longo" onclick="realizarDescanso('longo')">üåï Longo</button>
        </div>
        <div>
             <button class="btn-rest" style="background: #444; border: 1px solid var(--gold);" onclick="abrirCriadorInimigo()">üëæ Novo Inimigo</button>
             <button class="btn-rest" style="background: #330000; border: 1px solid red;" onclick="removerTodosInimigos()">üóëÔ∏è Limpar</button>
        </div>
        <div>
            <div id="btn-abrir-dados" onclick="abrirSeletorDados()" style="position:static; width:40px; height:30px; font-size:1.2rem;">üé≤</div>
        </div>
    </div>

    <div id="container-principal">
        
        <div id="area-jogadores">
            <h3 style="color:#aaa; text-align:center; margin:5px 0; border-bottom:1px solid #333;">JOGADORES</h3>
            <div id="painel">
                <p style="text-align:center; color:#666;">Carregando...</p>
            </div>
        </div>

        <div id="area-batalha-gm">
            <div id="titulo-batalha">CAMPO DE BATALHA</div>
            <div id="area-inimigos"></div>
        </div>

        <div id="sidebar-escudo">
            <h3 style="color:var(--gold); text-align:center; border-bottom:1px solid #333; padding-bottom:5px; margin-top:0;">ESCUDO GM</h3>
            <div class="escudo-topicos">
                <button class="btn-topico" onclick="exibirTopico('testes')">üé≤ Testes & Dualidade</button>
                <button class="btn-topico" onclick="exibirTopico('recursos')">üíé Recursos</button>
                <button class="btn-topico" onclick="exibirTopico('combate')">‚öîÔ∏è Combate</button>
                <button class="btn-topico" onclick="exibirTopico('dano')">ü©∏ Dano</button>
                <button class="btn-topico" onclick="exibirTopico('morte')">‚ò†Ô∏è Morte</button>
                <button class="btn-topico" onclick="exibirTopico('mestre')">üíÄ Moves do GM</button>
            </div>
            <hr style="border-color:#333;">
            <button class="btn-nav-mestre" onclick="window.location.href='admin.html'">‚öôÔ∏è Admin</button>
        </div>
    </div>

    <div id="modal-criar-inimigo">
        <div class="modal-criar-content">
            <h2 style="color:var(--gold); text-align:center; margin-top:0;">Invocar Inimigo</h2>
            
            <div class="form-grid">
                <div class="form-group form-full">
                    <label>Nome</label>
                    <input type="text" id="new-enemy-name" placeholder="Ex: Esqueleto">
                </div>
                
                <div class="form-group form-full">
                    <label>Imagem (Upload ou Link)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="new-enemy-img" placeholder="URL ou Upload..." style="flex:1">
                        <label for="upload-file-input" style="background:#333; border:1px solid #555; padding:5px; cursor:pointer;">üìÅ</label>
                        <input type="file" id="upload-file-input" accept="image/*" style="display:none" onchange="processarUploadImagem()">
                        <img id="preview-img-mini" style="width:30px; height:30px; display:none; border:1px solid #555;">
                    </div>
                </div>

                <div class="form-group">
                    <label>PV Max</label>
                    <input type="number" id="new-enemy-pv" value="4">
                </div>
                <div class="form-group">
                    <label>Estresse (PF)</label>
                    <input type="number" id="new-enemy-pf" value="0">
                </div>

                <div class="form-group">
                    <label>Dificuldade</label>
                    <input type="number" id="new-enemy-dif" value="10">
                </div>
                <div class="form-group">
                    <label>Ataque</label>
                    <input type="text" id="new-enemy-atk" value="+1">
                </div>
                
                <div class="form-group form-full">
                    <label>Dano e Habilidades</label>
                    <textarea id="new-enemy-desc" rows="3" placeholder="Dano: 1d6..."></textarea>
                </div>
                
                <input type="hidden" id="new-enemy-limiares" value="-">
                <input type="hidden" id="new-enemy-dmg" value="-">
            </div>

            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn-rolar-final" style="background:#4CAF50; padding:8px;" onclick="salvarNovoInimigo()">Criar</button>
                <button class="btn-rolar-final" style="background:#f44336; padding:8px;" onclick="fecharCriadorInimigo()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-selecao-dados" onclick="if(event.target===this) fecharSeletorDados()">
        <div class="dados-content">
            <div class="dados-header">Rolagem</div>
            <div class="dualidade-box">
                <span style="color:#ddd; font-size:0.8rem;">Teste (2d12)</span>
                <button class="btn-dualidade" onclick="adicionarDualidade()">‚ö° Dualidade</button>
            </div>
            <hr style="border-top:1px solid #444; width:100%;">
            <div class="grid-dados">
                <div class="dado-control"><span class="dado-label">d20</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d20',-1)">-</button><span id="count-d20" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d20',1)">+</button></div></div>
                </div>
            <button class="btn-rolar-final" onclick="rolarDadosConfirmados()">Rolar</button>
        </div>
    </div>

    <div id="overlay-rolagem">
        <div id="quem-rolou-label"></div>
        <div id="container-dados-rolando"></div>
        <button id="btn-fechar-rolagem" onclick="fecharResultadoRolagem()">Fechar</button>
    </div>

    <div id="modal-escudo">
        <div class="modal-escudo-content">
            <button id="btn-fechar-escudo" onclick="fecharEscudo()">√ó</button>
            <div id="escudo-conteudo"></div>
        </div>
    </div>

    <div id="sheet-modal" class="modal">
        <div class="sheet-content">
            <div class="sheet-toolbar">
                <button class="tool-btn active" onclick="selecionarFerramenta('texto')">T</button>
                <button class="tool-btn" onclick="selecionarFerramenta('marcador')">‚óè</button>
            </div>
            <button class="btn-close-sheet" onclick="fecharFicha()">X</button>
            <div class="sheet-container" id="sheet-container"><img id="sheet-bg"><div id="sheet-inputs-layer"></div></div>
            <div class="sheet-footer"><button class="nav-simple-btn" onclick="mudarPaginaFicha(-1)">‚ùÆ</button><span id="sheet-page-indicator">1</span><button class="nav-simple-btn" onclick="mudarPaginaFicha(1)">‚ùØ</button></div>
        </div>
    </div>

    <script type="module">
        // --- SETUP FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, get, onChildChanged, push, query, limitToLast, onChildAdded, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATWkyYE6b3wyz3LdFXAmxKxNQOexa_vUY",
            authDomain: "deck-daggerheart.firebaseapp.com",
            databaseURL: "https://deck-daggerheart-default-rtdb.firebaseio.com",
            projectId: "deck-daggerheart",
            storageBucket: "deck-daggerheart.firebasestorage.app",
            messagingSenderId: "825358776791",
            appId: "1:825358776791:web:ce0ab844f58c60573c7392",
            measurementId: "G-20TB05E9N2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // Exporta√ß√µes globais
        window.db = db; window.ref = ref; window.set = set; window.get = get; window.remove = remove;
        window.onValue = onValue; window.push = push; window.update = update;
        window.query = query; window.limitToLast = limitToLast; window.onChildAdded = onChildAdded;
        
        window.nomeJogador = "Mestre"; // Identidade

        window.abrirFichaDoJogador = function(nome) {
            window.nomeJogador = nome;
            get(ref(db, `mesa_rpg/jogadores/${nome}/slots/Fundamental`)).then(snap => {
                if(snap.exists() && snap.val().profissao) {
                    localStorage.setItem('profissaoSelecionada', snap.val().profissao);
                    if(window.abrirFichaPersonagem) window.abrirFichaPersonagem();
                } else alert("Jogador sem classe.");
            });
        };

        // Fun√ß√µes de painel e escudo... (Resumidas para caber no bloco, use a l√≥gica do anterior)
        // ... (A l√≥gica de renderizar cards, descanso e escudo √© id√™ntica ao anterior)
        
        // Inicializadores
        onAuthStateChanged(auth, user => {
            if(!user || user.email !== "tgbahiense@gmail.com") window.location.href="index.html";
            // Inicia sistemas
            iniciarPainelJogadores();
            setTimeout(() => {
                if(window.iniciarSistemaInimigos) window.iniciarSistemaInimigos(); // Inimigos na coluna do meio
                if(window.escutarRolagens) window.escutarRolagens();
            }, 1000);
        });

        // Fun√ß√£o de renderizar jogadores (Colocar dentro de iniciarPainelJogadores)
        function iniciarPainelJogadores() {
             // ... Copie a l√≥gica de renderiza√ß√£o do painel da resposta anterior ...
             // Mas garanta que o appendChild seja no 'painel' que agora est√° na coluna da esquerda
             const painel = document.getElementById('painel');
             // (Resto do c√≥digo de onValue dos jogadores/accounts)
        }

        // T√≥picos do Escudo (Coloque aqui o objeto 'topicos' completo da resposta anterior)
        // ...
    </script>
    
    <script src="ficha.js?v=4.0"></script>
    <script src="dados.js?v=2.0"></script>
    <script src="inimigos.js?v=3.0"></script>
</body>
</html>