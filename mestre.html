<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesa de Jogo - Daggerheart</title>
    <link rel="stylesheet" href="style.css?v=8.0">
    <link rel="stylesheet" href="ficha.css?v=4.0">
    <link rel="stylesheet" href="dados.css?v=2.0">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        body { display: flex; height: 100vh; flex-direction: column; background-color: #050505; }
        #container-principal { display: flex; flex: 1; overflow: visible; gap: 0; position: relative; }
        #area-jogadores { flex: 1; display: flex; flex-direction: column; overflow: visible; border-right: 2px solid var(--gold); min-width: 0; position: relative; }
        #painel { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; height: 85vh; overflow-y: auto; overflow-x: hidden; padding: 20px; align-content: start; align-items: start; }
        
        .card-jogador { background: rgba(10, 10, 10, 0.85); border: 1px solid var(--gold); border-radius: 8px; padding: 10px; position: relative; z-index: 1; display: flex; flex-direction: column; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); transition: transform 0.2s, border-color 0.2s; }
        .card-jogador:hover { z-index: 50; border-color: #ffe066; transform: translateY(-2px); }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px; gap: 10px; }
        .nome-container { display: flex; flex-direction: column; overflow: hidden; }
        .nome { font-weight: bold; color: var(--gold); margin: 0; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tag-classe { font-size: 0.65rem; color: #ccc; background: rgba(255, 255, 255, 0.1); padding: 1px 6px; border-radius: 4px; width: fit-content; margin-top: 2px; }
        
        .btn-abrir-ficha-mestre { background: var(--gold); color: #000; border: none; border-radius: 20px; padding: 4px 12px; font-family: 'MedievalSharp', cursive; font-size: 0.8rem; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5); transition: all 0.2s; white-space: nowrap; flex-shrink: 0; }
        .btn-abrir-ficha-mestre:hover { background: #fff; transform: scale(1.05); box-shadow: 0 0 10px var(--gold); }
        
        .label { font-size: 0.7rem; color: #888; margin: 2px 0; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px dashed #333; }
        .card-jogador .grid-mini { display: flex; flex-wrap: wrap; gap: 4px; min-height: 40px; }
        
        #preview-carta-mestre { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; height: 480px; background-size: contain; background-repeat: no-repeat; background-position: center; border: 3px solid var(--gold); border-radius: 12px; z-index: 2000; background-color: rgba(0, 0, 0, 0.95); box-shadow: 0 0 50px rgba(255, 215, 0, 0.3); pointer-events: none; }
        #preview-carta-mestre .token-count { width: 40px; height: 40px; font-size: 1.4rem; border: 2px solid #000; box-shadow: 0 2px 5px #000; top: -15px; }
        #preview-carta-mestre .icone-descanso-mini img { filter: drop-shadow(0 0 5px #000); width: 100px; height: 100px; }
        #preview-carta-mestre .icone-descanso-mini { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        
        #controles-mestre { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: rgba(0, 0, 0, 0.7); border-bottom: 2px solid var(--gold); gap: 10px; position: relative; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #controles-mestre > div { display: flex; gap: 10px; }
        .btn-nav-mestre { background: #333; color: #fff; padding: 8px 15px; border: 1px solid #555; border-radius: 5px; text-decoration: none; font-size: 0.9rem; cursor: pointer; font-family: 'MedievalSharp', cursive; }
        .btn-nav-mestre:hover { background: #555; border-color: var(--gold); }
        
        #sidebar-escudo { width: 240px; background: rgba(15, 15, 15, 0.95); border-left: 2px solid var(--gold); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; box-shadow: -5px 0 20px rgba(0,0,0,0.5); }
        #sidebar-escudo h3 { color: var(--gold); font-size: 1rem; margin: 0 0 10px 0; text-align: center; text-transform: uppercase; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .btn-topico { background: rgba(255, 255, 255, 0.05); border: 1px solid #444; color: #ddd; padding: 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; text-align: left; transition: 0.2s; font-family: inherit; }
        .btn-topico:hover { background: rgba(212, 175, 55, 0.15); border-color: var(--gold); color: #fff; transform: translateX(3px); }
        
        #modal-escudo { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 5000; justify-content: center; align-items: center; }
        #modal-escudo.ativo { display: flex; }
        .modal-escudo-content { background: #1a1a1a; border: 2px solid var(--gold); border-radius: 10px; padding: 30px; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 50px rgba(0, 0, 0, 0.9); position: relative; }
        .modal-escudo-content h2 { color: var(--gold); margin-top: 0; }
        .modal-escudo-content h3 { color: #ffff99; margin-top: 15px; }
        .modal-escudo-content p, .modal-escudo-content li { color: #ddd; line-height: 1.6; font-size: 0.95rem; }
        .modal-escudo-content ul { margin: 8px 0; padding-left: 20px; }
        .modal-escudo-content li { margin: 4px 0; }
        .modal-escudo-content code { background: rgba(255, 215, 0, 0.1); padding: 2px 5px; border-radius: 3px; color: #ffff99; font-family: monospace; }
        #btn-fechar-escudo { position: absolute; top: 15px; right: 15px; background: var(--gold); color: #000; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        #btn-fechar-escudo:hover { background: #fff; }
        
        #carta-usada-animada { position: fixed; width: 200px; height: 300px; background-size: contain; background-repeat: no-repeat; background-position: center; border-radius: 10px; pointer-events: none; display: none; z-index: 9999; box-shadow: 0 0 30px rgba(0, 255, 0, 0.8); }
        #carta-usada-animada.ativa { animation: carta-usar 2.5s ease-in-out forwards; }
        @keyframes carta-usar { 0% { opacity: 1; transform: scale(1) rotate(0deg); } 20% { opacity: 1; transform: scale(1.1); } 50% { opacity: 1; transform: scale(1.5) rotate(-5deg); } 55% { transform: scale(1.5) rotate(5deg); } 100% { opacity: 0; transform: scale(1.5); } }
        @keyframes mini-carta-usar { 0% { transform: scale(1); } 30% { transform: scale(1.15); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div id="preview-carta-mestre"></div>

    <div id="controles-mestre">
        <div>
            <button class="btn-rest curto" onclick="realizarDescanso('curto')">Descanso Curto</button>
            <button class="btn-rest longo" onclick="realizarDescanso('longo')">Descanso Longo</button>
        </div>
        <button class="btn-nav-mestre" onclick="window.location.href='admin.html'">Painel Admin</button>
    </div>

    <div id="container-principal">
        <div id="area-jogadores">
            <div id="painel">
                <p>Carregando jogadores...</p>
            </div>
        </div>

        <div id="sidebar-escudo">
            <h3>üõ°Ô∏è ESCUDO DO MESTRE</h3>
            <div class="escudo-topicos">
                <button class="btn-topico" onclick="exibirTopico('testes')">üé≤ Testes & Dualidade</button>
                </div>
        </div>
    </div>

    <div id="modal-escudo">
        <div class="modal-escudo-content">
            <button id="btn-fechar-escudo" onclick="fecharEscudo()">√ó</button>
            <div id="escudo-conteudo"></div>
        </div>
    </div>

    <div id="sheet-modal" class="modal">
        <div class="sheet-content">
            <div class="sheet-toolbar">
                <button class="tool-btn active" onclick="selecionarFerramenta('texto')" title="Texto (T)">T</button>
                <button class="tool-btn" onclick="selecionarFerramenta('marcador')" title="Marcador (Bolinha)">‚óè</button>
                <div style="height: 1px; background: #444; width: 100%; margin: 5px 0;"></div>
                <button class="tool-btn" onclick="limparPaginaAtual()" title="Limpar P√°gina" style="color: #ff6666;">üóëÔ∏è</button>
            </div>
            <button class="btn-close-sheet" onclick="fecharFicha()" title="Fechar">X</button>
            <div class="sheet-container" id="sheet-container">
                <img id="sheet-bg" src="" alt="Ficha">
                <div id="sheet-inputs-layer"></div>
            </div>
            <div class="sheet-footer">
                <button class="nav-simple-btn" onclick="mudarPaginaFicha(-1)">‚ùÆ Anterior</button>
                <span id="sheet-page-indicator">P√°gina 1</span>
                <button class="nav-simple-btn" onclick="mudarPaginaFicha(1)">Pr√≥xima ‚ùØ</button>
            </div>
        </div>
    </div>
    
    <div id="btn-abrir-dados" onclick="abrirSeletorDados()" title="Rolar Dados">üé≤</div>

    <div id="modal-selecao-dados" onclick="if(event.target===this) fecharSeletorDados()">
        <div class="dados-content">
            <div class="dados-header">Rolagem de Dados</div>
            <div class="dualidade-box">
                <span style="color:#ddd; font-size: 0.9rem;">Teste de A√ß√£o (2d12)</span>
                <button class="btn-dualidade" onclick="adicionarDualidade()">‚ö° Rolar Dualidade</button>
            </div>
            <hr style="border: 0; border-top: 1px solid #444; width: 100%;">
            <div class="grid-dados">
                <div class="dado-control"><span class="dado-label">d4</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d4', -1)">-</button><span id="count-d4" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d4', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d6</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d6', -1)">-</button><span id="count-d6" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d6', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d8</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d8', -1)">-</button><span id="count-d8" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d8', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d10</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d10', -1)">-</button><span id="count-d10" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d10', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d12</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d12', -1)">-</button><span id="count-d12" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d12', 1)">+</button></div></div>
                <div class="dado-control"><span class="dado-label">d20</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d20', -1)">-</button><span id="count-d20" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d20', 1)">+</button></div></div>
            </div>
            <button class="btn-rolar-final" onclick="rolarDadosConfirmados()">Rolar Selecionados</button>
        </div>
    </div>

    <div id="overlay-rolagem">
        <div id="quem-rolou-label"></div>
        <div id="container-dados-rolando"></div>
        <button id="btn-fechar-rolagem" onclick="fecharResultadoRolagem()">Fechar Resultado</button>
    </div>

    <div id="carta-usada-animada" class="carta-tabuleiro-animada"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, get, onChildChanged, push, query, limitToLast, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATWkyYE6b3wyz3LdFXAmxKxNQOexa_vUY",
            authDomain: "deck-daggerheart.firebaseapp.com",
            databaseURL: "https://deck-daggerheart-default-rtdb.firebaseio.com",
            projectId: "deck-daggerheart",
            storageBucket: "deck-daggerheart.firebasestorage.app",
            messagingSenderId: "825358776791",
            appId: "1:825358776791:web:ce0ab844f58c60573c7392",
            measurementId: "G-20TB05E9N2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // --- EXPOR FIREBASE PARA FICHA.JS E DADOS.JS ---
        window.db = db;
        window.ref = ref;
        window.set = set;
        window.get = get;
        window.remove = remove;
        window.onValue = onValue;
        window.push = push;
        window.query = query;
        window.limitToLast = limitToLast;
        window.onChildAdded = onChildAdded;
        
        // Define o nome do jogador como Mestre para os scripts externos
        window.nomeJogador = "Mestre"; 
        // ------------------------------------------------

        const EMAIL_MESTRE = "tgbahiense@gmail.com";

        window.fazerLogout = function() {
            signOut(auth).then(() => window.location.href = "index.html");
        }

        // Fun√ß√£o para abrir a ficha do jogador pelo Mestre
        window.abrirFichaDoJogador = function(nomePersonagem) {
            // MUDA O CONTEXTO GLOBAL DO FICHA.JS PARA O PERSONAGEM CLICADO
            window.nomeJogador = nomePersonagem;
            
            const slotRef = ref(db, `mesa_rpg/jogadores/${nomePersonagem}/slots/Fundamental`);
            get(slotRef).then(snapshot => {
                if(snapshot.exists() && snapshot.val().profissao) {
                    localStorage.setItem('profissaoSelecionada', snapshot.val().profissao);
                    if(typeof window.abrirFichaPersonagem === 'function') {
                        window.abrirFichaPersonagem();
                    }
                } else {
                    alert(`O personagem ${nomePersonagem} ainda n√£o selecionou uma classe.`);
                }
            });
        };

        window.realizarDescanso = function(tipo) {
            const jogadoresRef = ref(db, 'mesa_rpg/jogadores');
            get(jogadoresRef).then(snapshot => {
                if(snapshot.exists()) {
                    const dados = snapshot.val();
                    Object.keys(dados).forEach(nome => {
                        const player = dados[nome];
                        const resetCartas = (lista, path) => {
                            if(!lista) return;
                            let listChanged = false;
                            lista.forEach(carta => {
                                if(!carta) return;
                                if(tipo === 'curto' && carta.estado === 'curto') { carta.estado = 'ativo'; listChanged = true; }
                                if(tipo === 'longo' && (carta.estado === 'curto' || carta.estado === 'longo')) { carta.estado = 'ativo'; listChanged = true; }
                            });
                            if(listChanged) set(ref(db, `mesa_rpg/jogadores/${nome}/${path}`), lista);
                        };
                        resetCartas(player.mao, 'mao');
                        resetCartas(player.reserva, 'reserva');
                        if(player.slots) {
                            let slotsChanged = false;
                            Object.keys(player.slots).forEach(k => {
                                const c = player.slots[k];
                                if(c && ((tipo==='curto' && c.estado==='curto') || (tipo==='longo' && (c.estado==='curto'||c.estado==='longo')))) {
                                    c.estado = 'ativo'; slotsChanged = true;
                                }
                            });
                            if(slotsChanged) set(ref(db, `mesa_rpg/jogadores/${nome}/slots`), player.slots);
                        }
                    });
                }
            });
        }

        onAuthStateChanged(auth, (user) => {
            if (!user || user.email.toLowerCase().trim() !== EMAIL_MESTRE.toLowerCase().trim()) { window.location.href = "index.html"; return; }
            iniciarPainel();
            configurarListenersDeCartasUsadas();
            
            // INICIA ESCUTA DE DADOS
            setTimeout(() => {
                if(window.escutarRolagens) window.escutarRolagens();
            }, 2000);
        });

        function iniciarPainel() {
            const jogadoresRef = ref(db, 'mesa_rpg/jogadores');
            const accountsRef = ref(db, 'mesa_rpg/accounts');
            let nomesDePersonagens = new Set();
            let cacheJogadores = {};

            function render() {
                const painel = document.getElementById('painel');
                const nomes = Array.from(nomesDePersonagens);
                if (nomes.length === 0) { painel.innerHTML = "<p>Nenhum personagem.</p>"; return; }
                painel.innerHTML = "";
                nomes.sort().forEach(nome => {
                    const p = cacheJogadores[nome] || {};
                    const card = document.createElement('div');
                    card.className = 'card-jogador';
                    let htmlMao = "";
                    if(p.mao && p.mao.length > 0) {
                        p.mao.forEach((c) => {
                            let classes = "mini-carta"; let tooltip = c.nome; let extraHTML = "";
                            if(c.estado === 'curto') { classes += " indisponivel"; tooltip += " (Recarga: Curto)"; extraHTML += `<div class="icone-descanso-mini"><img src="img/meia-lua.png"></div>`; }
                            if(c.estado === 'longo') { classes += " indisponivel"; tooltip += " (Recarga: Longo)"; extraHTML += `<div class="icone-descanso-mini"><img src="img/lua-cheia.png"></div>`; }
                            if(c.tokens > 0) { extraHTML += `<div class="token-count">${c.tokens}</div>`; }
                            htmlMao += `<div class="${classes}" style="background-image: url('${c.caminho}')" title="${tooltip}">${extraHTML}</div>`;
                        });
                    } else { htmlMao = "<span class='status-vazio'>M√£o vazia</span>"; }
                    let htmlSlots = ""; let classeNome = "";
                    if(p.slots) {
                        ['Ancestralidade', 'Comunidade', 'Fundamental', 'Especializacao', 'Maestria'].forEach(key => {
                            if(p.slots[key]) {
                                htmlSlots += `<div class="mini-carta slot-ativo" style="background-image: url('${p.slots[key].caminho}')" title="${key}: ${p.slots[key].nome}"></div>`;
                                if(key === 'Fundamental' && p.slots[key].profissao) classeNome = p.slots[key].profissao;
                            }
                        });
                    }
                    if(htmlSlots === "") htmlSlots = "<span class='status-vazio'>Nenhum ativo</span>";
                    let htmlReserva = "";
                    if(p.reserva && p.reserva.length > 0) {
                        htmlReserva = `<div class="label">Reserva (${p.reserva.length})</div>`;
                        let cartasReservaHTML = "";
                        p.reserva.forEach(c => { cartasReservaHTML += `<div class="mini-carta carta-reserva-visual" style="background-image: url('${c.caminho}')" title="Reserva: ${c.nome}"></div>`; });
                        htmlReserva += `<div class="grid-mini">${cartasReservaHTML}</div>`;
                    }
                    const safeName = nome.replace(/'/g, "\\'");
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="nome-container"><div class="nome">${nome}</div>${classeNome ? `<div class="tag-classe">${classeNome}</div>` : ''}</div>
                            <button class="btn-abrir-ficha-mestre" onclick="window.abrirFichaDoJogador('${safeName}')" title="Abrir Ficha">üìÑ Ficha</button>
                        </div>
                        <div class="label">M√£o (${p.mao ? p.mao.length : 0})</div><div class="grid-mini" data-jogador="${nome}">${htmlMao}</div>
                        <div class="label">Mesa (Ativos)</div><div class="grid-mini">${htmlSlots}</div>${htmlReserva}
                    `;
                    painel.appendChild(card);
                });
            }
            onValue(accountsRef, (snap) => {
                const setNomes = new Set();
                if (snap.exists()) { snap.forEach(childSnap => { const data = childSnap.val(); if (!data || data.status === 'inactive') return; if (data.characters) Object.keys(data.characters).forEach(n => setNomes.add(String(n).toUpperCase())); }); }
                nomesDePersonagens = setNomes; render();
            });
            onValue(jogadoresRef, (snapshot) => {
                cacheJogadores = snapshot.exists() ? (snapshot.val() || {}) : {};
                Object.keys(cacheJogadores || {}).forEach(n => nomesDePersonagens.add(String(n).toUpperCase()));
                render();
            });
        }

        function configurarListenersDeCartasUsadas() {
            const jogadoresRef = ref(db, 'mesa_rpg/jogadores');
            get(jogadoresRef).then(snapshot => {
                if(snapshot.exists()) { Object.keys(snapshot.val()).forEach(nome => configurarListenerIndividualDoJogador(nome)); }
            });
            onChildChanged(jogadoresRef, (snapshot) => configurarListenerIndividualDoJogador(snapshot.key));
        }

        function configurarListenerIndividualDoJogador(nomeJogador) {
            onValue(ref(db, `mesa_rpg/jogadores/${nomeJogador}/cartaUsada`), (snapshot) => {
                if(snapshot.exists()) animarCartaEspecifica(nomeJogador, snapshot.val());
            });
        }

        function animarCartaEspecifica(nomeJogador, cartaUsada) {
            const gridMao = document.querySelector(`[data-jogador="${nomeJogador}"]`);
            if(!gridMao) return;
            const cartas = gridMao.querySelectorAll('.mini-carta');
            let cartaEncontrada = null;
            for(let carta of cartas) {
                const bg = carta.style.backgroundImage;
                if(bg && (bg.includes(cartaUsada.caminho) || bg.includes(cartaUsada.caminho.split('/').pop()))) { cartaEncontrada = carta; break; }
            }
            if(cartaEncontrada) {
                cartaEncontrada.style.animation = 'mini-carta-usar 0.8s ease-out';
                setTimeout(() => cartaEncontrada.style.animation = 'none', 800);
            }
        }

        // --- CONTE√öDO DO ESCUDO DO MESTRE (COMPLETO) ---
        const topicos = {
            testes: {
                titulo: "üé≤ TESTES & DUALIDADE",
                conteudo: `
                    <h2>üé≤ TESTES & DUALIDADE</h2>
                    <h3>Rolagem Padr√£o</h3>
                    <ul>
                        <li><strong>Role:</strong> <code>2d12 (Esperan√ßa + Medo) + Atributo</code></li>
                        <li><strong>Cr√≠tico:</strong> Dados iguais (ex: 1,1 ou 12,12). Sucesso autom√°tico + Ganha Esperan√ßa.</li>
                    </ul>
                    <h3>Resultados</h3>
                    <ul>
                        <li><strong>Sucesso com Esperan√ßa:</strong> Total ‚â• Dificuldade & Esperan√ßa > Medo. <br><em>A√ß√£o funciona e ganha 1 Esperan√ßa.</em></li>
                        <li><strong>Sucesso com Medo:</strong> Total ‚â• Dificuldade & Medo > Esperan√ßa. <br><em>A√ß√£o funciona, mas GM ganha 1 Medo.</em></li>
                        <li><strong>Falha com Esperan√ßa:</strong> Total < Dificuldade & Esperan√ßa > Medo. <br><em>Falha, mas ganha 1 Esperan√ßa.</em></li>
                        <li><strong>Falha com Medo:</strong> Total < Dificuldade & Medo > Esperan√ßa. <br><em>Falha e GM ganha 1 Medo ou faz movimento.</em></li>
                    </ul>
                `
            },
            recursos: {
                titulo: "üíé RECURSOS DO JOGADOR",
                conteudo: `
                    <h2>üíé RECURSOS DO JOGADOR</h2>
                    <h3>Esperan√ßa</h3>
                    <ul>
                        <li><strong>Ganho:</strong> Sucesso com Esperan√ßa ou Cr√≠tico.</li>
                        <li><strong>Gastos:</strong>
                            <ul>
                                <li><strong>Experi√™ncia:</strong> Use uma carta de Experi√™ncia.</li>
                                <li><strong>Ajudar:</strong> Gaste 1 para dar +1d6 (ou +2d6 com v√≠nculo) a um aliado.</li>
                            </ul>
                        </li>
                    </ul>
                    <h3>Estresse (Fadiga)</h3>
                    <ul>
                        <li>Usada para ativar habilidades ou absorver consequ√™ncias menores.</li>
                        <li>Se encher, o pr√≥ximo dano vai direto para PV.</li>
                    </ul>
                `
            },
            combate: {
                titulo: "‚öîÔ∏è COMBATE",
                conteudo: `
                    <h2>‚öîÔ∏è COMBATE</h2>
                    <h3>Ataque</h3>
                    <ul>
                        <li><strong>Teste:</strong> Atributo da arma vs <strong>Dificuldade (Evas√£o do Inimigo)</strong>.</li>
                        <li><strong>Vantagem:</strong> +1d6 no total.</li>
                        <li><strong>Desvantagem:</strong> -1d6 no total.</li>
                    </ul>
                    <h3>Dano</h3>
                    <ul>
                        <li><strong>Dados:</strong> Base da arma (ex: d8) + Cartas de Dano.</li>
                        <li><strong>Cr√≠tico:</strong> Adicione o valor m√°ximo dos dados ao total rolado.</li>
                    </ul>
                `
            },
            dano: {
                titulo: "ü©∏ DANO & LIMIARES",
                conteudo: `
                    <h2>ü©∏ DANO & LIMIARES</h2>
                    <p>O dano sofrido √© comparado aos limiares do personagem:</p>
                    <ul>
                        <li><strong>Abaixo do Menor:</strong> 0 PV (Arranh√£o).</li>
                        <li><strong>Menor:</strong> 1 PV (Machucado).</li>
                        <li><strong>Maior:</strong> 2 PV (Ferida Grave).</li>
                        <li><strong>Severo:</strong> 3 PV (Mortal).</li>
                    </ul>
                `
            },
            armadura: {
                titulo: "üõ°Ô∏è ARMADURA (PA)",
                conteudo: `
                    <h2>üõ°Ô∏è ARMADURA (PA)</h2>
                    <ul>
                        <li>Gaste <strong>slots de Armadura</strong> para reduzir o dano recebido.</li>
                        <li>A quantidade reduzida depende do tipo de armadura equipada.</li>
                        <li>Slots gastos s√≥ recuperam em Descanso ou Reparo.</li>
                    </ul>
                `
            },
            morte: {
                titulo: "‚ò†Ô∏è MORTE",
                conteudo: `
                    <h2>‚ò†Ô∏è MORTE</h2>
                    <p>Se marcar o √∫ltimo PV, o personagem cai. Escolha:</p>
                    <ul>
                        <li><strong>Arriscar Tudo:</strong> Role Fear die. Se falhar, morre. Se passar, levanta com 1 PV.</li>
                        <li><strong>Evitar a Morte:</strong> Fica inconsciente e ganha uma Cicatriz.</li>
                        <li><strong>Sacrif√≠cio Glorioso:</strong> Morre realizando um feito imposs√≠vel (Sucesso Cr√≠tico Autom√°tico).</li>
                    </ul>
                `
            },
            distancia: {
                titulo: "üìè DIST√ÇNCIA & MOVIMENTO",
                conteudo: `
                    <h2>üìè DIST√ÇNCIA & MOVIMENTO</h2>
                    <ul>
                        <li><strong>Melee:</strong> Adjacente.</li>
                        <li><strong>Very Close:</strong> Ao alcance do bra√ßo/arma longa.</li>
                        <li><strong>Close:</strong> Alguns passos (mesma sala).</li>
                        <li><strong>Far:</strong> Precisa gritar/correr (outro lado do campo).</li>
                        <li><strong>Very Far:</strong> Apenas armas de longo alcance/magia.</li>
                    </ul>
                `
            },
            descanso: {
                titulo: "üí§ DESCANSO",
                conteudo: `
                    <h2>üí§ DESCANSO</h2>
                    <h3>Curto</h3>
                    <ul>
                        <li>Pode reparar Armadura.</li>
                        <li>Pode curar PV ou limpar Estresse (role 1d4 + atributo).</li>
                    </ul>
                    <h3>Longo</h3>
                    <ul>
                        <li>Recupera <strong>todos</strong> PV, Estresse e Armadura.</li>
                        <li>Reseta habilidades di√°rias.</li>
                        <li>GM ganha Medo baseado na seguran√ßa do local.</li>
                    </ul>
                `
            },
            mestre: {
                titulo: "üíÄ O MESTRE (GM)",
                conteudo: `
                    <h2>üíÄ O MESTRE (GM)</h2>
                    <h3>Quando o GM Age?</h3>
                    <ul>
                        <li>Quando os jogadores falham.</li>
                        <li>Quando rolam <strong>Com Medo</strong>.</li>
                        <li>Quando olham para voc√™ esperando algo acontecer (Oportunidade de Ouro).</li>
                    </ul>
                    <h3>Medo</h3>
                    <ul>
                        <li>Use Medo para ativar habilidades especiais de monstros ou complicar a cena.</li>
                        <li>Cada Medo gasto = 1 Token de A√ß√£o do GM.</li>
                    </ul>
                `
            }
        };
        window.exibirTopico = function(id) { if(topicos[id]) { document.getElementById('escudo-conteudo').innerHTML = topicos[id].conteudo; document.getElementById('modal-escudo').classList.add('ativo'); } }
        window.fecharEscudo = function() { document.getElementById('modal-escudo').classList.remove('ativo'); }
        document.getElementById('modal-escudo').addEventListener('click', function(e) { if(e.target===this) fecharEscudo(); });

        document.addEventListener('mouseover', (e) => {
            const carta = e.target.closest('.mini-carta');
            if (carta && !carta.classList.contains('status-vazio')) {
                const preview = document.getElementById('preview-carta-mestre');
                if (preview && carta.style.backgroundImage) {
                    preview.style.backgroundImage = carta.style.backgroundImage;
                    preview.innerHTML = carta.innerHTML;
                    preview.style.display = 'flex';
                }
            }
        });
        document.addEventListener('mouseout', (e) => { if (e.target.closest('.mini-carta')) document.getElementById('preview-carta-mestre').style.display = 'none'; });
    </script>
    
    <script src="ficha.js?v=4.0"></script>
    <script src="dados.js?v=2.0"></script>
</body>
</html>