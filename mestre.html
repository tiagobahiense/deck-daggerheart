<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesa de Jogo - Daggerheart (GM)</title>
    <link rel="stylesheet" href="style.css?v=8.0">
    <link rel="stylesheet" href="ficha.css?v=5.0">
    <link rel="stylesheet" href="dados.css?v=2.0">
    <link rel="stylesheet" href="inimigos.css?v=3.6">
    <link rel="stylesheet" href="medo.css?v=1.1">
    <link rel="stylesheet" href="npcs.css">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        body { display: flex; height: 100vh; flex-direction: column; background-color: #050505; margin: 0; overflow: hidden; }
        
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; display: flex; align-items: center; justify-content: center; color: var(--gold); font-family: 'MedievalSharp', cursive; font-size: 2rem; }

        #container-principal { display: flex; flex: 1; overflow: hidden; gap: 0; }
        
        /* 1. JOGADORES (ESQUERDA) */
        #area-jogadores { width: 350px; flex-shrink: 0; display: flex; flex-direction: column; border-right: 2px solid var(--gold); background: #0a0a0a; }
        #painel { padding: 10px; overflow-y: auto; height: 100%; display: flex; flex-direction: column; gap: 10px; }
        
        .card-jogador { width: 100%; background: rgba(20,20,20,0.9); border: 1px solid #444; border-radius:8px; padding:8px; box-sizing: border-box; }
        .card-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:5px; }
        
        /* Nome e Status */
        .nome-wrapper { display: flex; align-items: center; gap: 8px; }
        .nome { color: var(--gold); font-weight: bold; font-size: 0.9rem; }
        .tag-classe { font-size: 0.65rem; color: #aaa; background: #222; padding: 1px 4px; border-radius: 4px; }
        
        /* Bolinha de Status */
        .status-dot {
            width: 10px; height: 10px; border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 5px rgba(0,0,0,0.8);
            transition: background-color 0.3s;
        }
        .status-online { background-color: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .status-offline { background-color: #ff0000; opacity: 0.4; }

        .btn-abrir-ficha-mestre { background: var(--gold); color: #000; border: none; border-radius: 15px; padding: 2px 8px; font-weight: bold; cursor: pointer; font-size: 0.75rem; margin-left:5px; }
        .btn-expandir-mesa { background: #333; color: #ccc; border: 1px solid #555; width: 100%; padding: 4px; cursor: pointer; font-size: 0.75rem; margin-top:5px; border-radius: 4px; }
        .btn-expandir-mesa:hover { background: #444; color: #fff; }
        .mesa-expandida { display: none; margin-top: 5px; border-top: 1px dashed #444; padding-top: 5px; }
        .mesa-expandida.ativo { display: block; }
        .grid-mini { display: flex; flex-wrap: wrap; gap: 4px; min-height: 40px; }

        /* 2. √ÅREA DE BATALHA (CENTRO) */
        #area-batalha-gm { flex-grow: 1; background: url('img/background_epico.png') no-repeat center center; background-size: cover; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        #titulo-batalha { background: rgba(0,0,0,0.8); color: var(--gold); text-align: center; padding: 5px; font-family: 'MedievalSharp', cursive; border-bottom: 1px solid var(--gold); }
        #area-inimigos { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-wrap: wrap; align-content: flex-start; justify-content: center; gap: 15px; }

        /* 3. ESCUDO E DADOS (DIREITA) */
        #sidebar-escudo { width: 280px; flex-shrink: 0; background: #0f0f0f; border-left: 2px solid var(--gold); padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .escudo-topicos { display: flex; flex-direction: column; gap: 5px; }
        .btn-topico { background: #222; border: 1px solid #444; color: #ddd; padding: 8px; text-align: left; cursor: pointer; border-radius: 5px; transition: 0.2s; }
        .btn-topico:hover { border-color: var(--gold); background: #333; }

        /* Controles Gerais */
        #controles-mestre { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background: #111; border-bottom: 2px solid var(--gold); z-index: 100; }
        .btn-rest { font-size: 0.8rem; padding: 5px 10px; cursor: pointer; color: white; border-radius: 4px; border:none; }
        .curto { background: #f57c00; } .longo { background: #d32f2f; }
        .btn-nav-mestre { background: #333; color: #fff; padding: 5px 10px; border: 1px solid #555; cursor: pointer; border-radius: 4px; }
        
        /* Bot√£o Refresh */
        .btn-refresh { background: none; border: 1px solid #555; color: #aaa; cursor: pointer; width: 30px; height: 30px; border-radius: 50%; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .btn-refresh:hover { color: var(--gold); border-color: var(--gold); transform: rotate(180deg); }
        .spin-anim { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Modal Criar */
        #modal-criar-inimigo { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9000; align-items: center; justify-content: center; }
        .modal-criar-content { background: #1a1a1a; width: 450px; padding: 20px; border: 2px solid var(--gold); border-radius: 10px; display: flex; flex-direction: column; gap: 10px; max-height:90vh; overflow-y:auto; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .form-full { grid-column: 1 / -1; }
        input, textarea { width: 100%; box-sizing: border-box; background: #222; border: 1px solid #444; color: white; padding: 5px; }
        
        /* Preview Card */
        #preview-carta-mestre { display: none; position: fixed; top: 50%; left: 50%; width: 320px; height: 480px; z-index: 9999; transform: translate(-50%, -50%); border: 3px solid var(--gold); background: #000; pointer-events: none; background-size: contain; background-repeat: no-repeat; background-position: center; box-shadow: 0 0 60px rgba(255,215,0,0.4); border-radius: 10px; }
        #preview-carta-mestre .token-count { position: absolute; top: -10px; right: -10px; background: #000; border: 2px solid #fff; color: #fff; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; }
        
        /* Modal Escudo */
        #modal-escudo { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center; }
        #modal-escudo.ativo { display: flex; }
        .modal-escudo-content { background: #1a1a1a; padding: 30px; border: 2px solid var(--gold); max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative; color: #ddd; border-radius: 10px; font-size: 0.95rem; line-height: 1.5; }
        .modal-escudo-content h2 { color:var(--gold); margin-top:0; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .modal-escudo-content h3 { color:#ffff99; margin-top:20px; margin-bottom: 5px; border-bottom: 1px solid #333; display: inline-block;}
        .modal-escudo-content ul { padding-left: 20px; margin-top: 5px; }
        .modal-escudo-content li { margin-bottom: 5px; color: #ccc; }
        .modal-escudo-content strong { color: #fff; }
        .modal-escudo-content p { margin: 5px 0; }
        
        #btn-fechar-escudo { position: absolute; top: 10px; right: 10px; background: var(--gold); border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; z-index: 10; }

        /* Slots e Cartas Visuais */
        .mini-carta { width: 50px; height: 70px; background-size: cover; background-position: center; border: 1px solid #555; border-radius: 4px; position: relative; cursor: help; }
        .mini-carta.indisponivel { filter: grayscale(100%); opacity: 0.5; }
        .icone-descanso-mini { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 20px; height: 20px; }
        .icone-descanso-mini img { width: 100%; height: 100%; }
        .token-count { position: absolute; bottom: -5px; right: -5px; background: var(--gold); color: black; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        
        .slot-ativo { width: 40px; height: 40px; background-size: cover; background-position: center; border-radius: 50%; border: 1px solid var(--gold); cursor: help; }
        .carta-reserva-visual { width: 40px; height: 56px; background-size: cover; border: 1px dashed #666; opacity: 0.7; }
    </style>
</head>
<body>
    
    <div id="loading-screen">Carregando Mesa...</div>

    <div id="medo-overlay-msg"></div>

    <div id="preview-carta-mestre"></div>

    <audio id="sound-medo-add"><source src="audio/sound-recolhe-medo.mp3" type="audio/mpeg"></audio>
    <audio id="sound-medo-use"><source src="audio/sound-usa-medo.mp3" type="audio/mpeg"></audio>

    <div id="controles-mestre">
        <div style="display:flex; gap:10px;">
            <button class="btn-rest curto" onclick="realizarDescanso('curto')">üåô Curto</button>
            <button class="btn-rest longo" onclick="realizarDescanso('longo')">üåï Longo</button>
        </div>

        <div style="display:flex; gap:10px;">
             <button class="btn-rest" style="background: #444; border: 1px solid var(--gold);" onclick="abrirCriadorInimigo()">üëæ Novo Inimigo</button>
             
             <button class="btn-rest" style="background: #2c3e50; border: 1px solid #4682B4;" onclick="abrirCriadorNPC()">üë§ Novo NPC</button> 
             
             <button class="btn-rest" style="background: #330000; border: 1px solid red;" onclick="removerTodosInimigos()">üóëÔ∏è Limpar</button>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn-refresh" onclick="atualizarSincronia()" title="Ressincronizar Mesa">üîÑ</button>
            <div id="btn-abrir-dados" onclick="abrirSeletorDados()" style="position:static; width:40px; height:30px; font-size:1.2rem; display:flex; align-items:center; justify-content:center; cursor:pointer;">üé≤</div>
            <button class="btn-nav-mestre" onclick="window.location.href='admin.html'">‚öôÔ∏è Admin</button>
        </div>
    </div>

    <div id="container-principal">
        
        <div id="area-jogadores">
            <h3 style="color:#aaa; text-align:center; margin:5px 0; border-bottom:1px solid #333;">JOGADORES</h3>
            <div id="painel">
                <p style="text-align:center; color:#666;">Carregando...</p>
            </div>
        </div>

        <div id="area-batalha-gm">
            <div id="titulo-batalha">CAMPO DE BATALHA</div>
            <div id="area-inimigos"></div>
            
            <div id="gm-npc-preview-modal"></div>

            <div id="gm-npc-list-container">
                <div class="npc-list-header">
                    <span>Lista de NPCs</span>
                    <span onclick="abrirCriadorNPC()" style="cursor:pointer; font-size:1.2rem;">+</span>
                </div>
                <div id="npc-list-scroll" class="npc-list-scroll">
                    </div>
            </div>
        </div>

        <div id="sidebar-escudo">
            
            <div id="medo-container">
                <div class="medo-header">
                    <span class="medo-titulo">MEDO</span>
                    <div class="medo-botoes">
                        <button class="btn-medo btn-add" onclick="adicionarMedo()">Adicionar</button>
                        <button class="btn-medo btn-use" onclick="usarMedo()">Usar</button>
                    </div>
                </div>
                <div id="medo-tokens-grid"></div>
            </div>

            <h3 style="color:var(--gold); text-align:center; border-bottom:1px solid #333; padding-bottom:5px; margin-top:20px;">ESCUDO GM</h3>
            <div class="escudo-topicos">
                <button class="btn-topico" onclick="exibirTopico('testes')">üé≤ Testes & Dualidade</button>
                <button class="btn-topico" onclick="exibirTopico('recursos')">üíé Recursos</button>
                <button class="btn-topico" onclick="exibirTopico('combate')">‚öîÔ∏è Combate</button>
                <button class="btn-topico" onclick="exibirTopico('dano')">ü©∏ Dano</button>
                <button class="btn-topico" onclick="exibirTopico('armadura')">üõ°Ô∏è Armadura</button>
                <button class="btn-topico" onclick="exibirTopico('morte')">‚ò†Ô∏è Morte</button>
                <button class="btn-topico" onclick="exibirTopico('distancia')">üìè Dist√¢ncia</button>
                <button class="btn-topico" onclick="exibirTopico('descanso')">üí§ Descanso</button>
                <button class="btn-topico" onclick="exibirTopico('mestre')">üíÄ Moves do GM</button>
            </div>
        </div>
    </div>

    <div id="modal-criar-inimigo"><div class="modal-criar-content"><h2 style="color:var(--gold); text-align:center; margin-top:0;">Invocar Inimigo</h2><div class="form-grid"><div class="form-group form-full"><label>Nome</label><input type="text" id="new-enemy-name" placeholder="Ex: Lobo Atroz"></div><div class="form-group form-full"><label>Imagem</label><div style="display:flex; gap:5px;"><input type="text" id="new-enemy-img" placeholder="URL ou Upload..." style="flex:1"><label for="upload-file-input" style="background:#333; border:1px solid #555; padding:5px; cursor:pointer; color:white;">üìÅ</label><input type="file" id="upload-file-input" accept="image/*" style="display:none" onchange="processarUploadImagem()"><img id="preview-img-mini" style="width:30px; height:30px; display:none; border:1px solid #555;"></div></div><div class="form-group"><label>PV Max</label><input type="number" id="new-enemy-pv" value="4"></div><div class="form-group"><label>Estresse (PF)</label><input type="number" id="new-enemy-pf" value="0"></div><div class="form-group"><label>Dificuldade</label><input type="number" id="new-enemy-dif" value="12"></div><div class="form-group"><label>Ataque</label><input type="text" id="new-enemy-atk" value="+2"></div><div class="form-group"><label>Dano</label><input type="text" id="new-enemy-dmg" value="1d6+2"></div><div class="form-group"><label>Limiares</label><input type="text" id="new-enemy-limiares" placeholder="5/10"></div><div class="form-group form-full"><label>Habilidades</label><textarea id="new-enemy-desc" rows="3"></textarea></div></div><div style="display:flex; gap:10px; margin-top:10px;"><button class="btn-rest btn-invocar" style="background:#4CAF50; flex:1;" onclick="salvarNovoInimigo()">Invocar</button><button class="btn-rest" style="background:#f44336; flex:1;" onclick="fecharCriadorInimigo()">Cancelar</button></div></div></div>
    
    <div id="modal-criar-npc" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9000; align-items:center; justify-content:center;">
        <div class="modal-criar-content" style="background:#1a1a1a; padding:20px; border:2px solid var(--gold); border-radius:10px; width:450px;">
            <h2 style="color:var(--gold); text-align:center; margin-top:0;">Criar NPC</h2>
            
            <div class="form-grid">
                <div class="form-group form-full">
                    <label>Nome do NPC</label>
                    <input type="text" id="new-npc-name" placeholder="Ex: Estalajadeiro Bob">
                </div>
                
                <div class="form-group form-full">
                    <label>Imagem (PNG sem fundo)</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="file" id="npc-upload-input" accept="image/*" style="display:none" onchange="processarUploadNPC()">
                        <label for="npc-upload-input" style="background:#333; border:1px solid #777; padding:8px; cursor:pointer; color:white; flex:1; text-align:center;">üìÅ Escolher Imagem</label>
                        <input type="hidden" id="new-npc-img-data">
                        <img id="preview-npc-mini" style="width:40px; height:40px; display:none; border:1px solid #555; object-fit:contain;">
                    </div>
                </div>

                <div class="form-group form-full">
                    <label style="color:#00ff00;">Descri√ß√£o para Jogadores</label>
                    <textarea id="new-npc-desc-player" rows="3" class="input-desc-player" placeholder="O que eles veem?"></textarea>
                </div>

                <div class="form-group form-full">
                    <label style="color:#ff9999;">Notas do Mestre (Privado)</label>
                    <textarea id="new-npc-desc-gm" rows="3" class="input-desc-gm" placeholder="Segredos, voz, personalidade..."></textarea>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-rest" style="background:#4CAF50; flex:1;" onclick="salvarNovoNPC()">Salvar NPC</button>
                <button class="btn-rest" style="background:#f44336; flex:1;" onclick="fecharCriadorNPC()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-selecao-dados" onclick="if(event.target===this) fecharSeletorDados()"><div class="dados-content"><div class="dados-header">Rolagem</div><div class="dualidade-box"><span style="color:#ddd; font-size:0.8rem;">Teste (2d12)</span><button class="btn-dualidade" onclick="adicionarDualidade()">‚ö° Dualidade</button></div><hr style="border-top:1px solid #444; width:100%;"><div class="grid-dados"><div class="dado-control"><span class="dado-label">d4</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d4', -1)">-</button><span id="count-d4" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d4', 1)">+</button></div></div><div class="dado-control"><span class="dado-label">d6</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d6', -1)">-</button><span id="count-d6" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d6', 1)">+</button></div></div><div class="dado-control"><span class="dado-label">d8</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d8', -1)">-</button><span id="count-d8" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d8', 1)">+</button></div></div><div class="dado-control"><span class="dado-label">d10</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d10', -1)">-</button><span id="count-d10" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d10', 1)">+</button></div></div><div class="dado-control"><span class="dado-label">d12</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d12', -1)">-</button><span id="count-d12" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d12', 1)">+</button></div></div><div class="dado-control"><span class="dado-label">d20</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d20', -1)">-</button><span id="count-d20" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d20', 1)">+</button></div></div></div><button class="btn-rolar-final" onclick="rolarDadosConfirmados()">Rolar</button></div></div>
    <div id="overlay-rolagem"><div id="quem-rolou-label"></div><div id="container-dados-rolando"></div><button id="btn-fechar-rolagem" onclick="fecharResultadoRolagem()">Fechar Resultado</button></div>
    
    <div id="modal-escudo"><div class="modal-escudo-content"><button id="btn-fechar-escudo" onclick="fecharEscudo()">√ó</button><div id="escudo-conteudo"></div></div></div>
    
    <div id="sheet-modal" class="modal"><div class="sheet-content"><div class="sheet-toolbar"><button class="tool-btn active" onclick="selecionarFerramenta('texto')">T</button><button class="tool-btn" onclick="selecionarFerramenta('marcador')">‚óè</button><button class="tool-btn" onclick="limparPaginaAtual()" style="color:#f66;">üóëÔ∏è</button></div><button class="btn-close-sheet" onclick="fecharFicha()">X</button><div class="sheet-container" id="sheet-container"><img id="sheet-bg"><div id="sheet-inputs-layer"></div></div><div class="sheet-footer"><button class="nav-simple-btn" onclick="mudarPaginaFicha(-1)">‚ùÆ</button><span id="sheet-page-indicator">1</span><button class="nav-simple-btn" onclick="mudarPaginaFicha(1)">‚ùØ</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, get, onChildChanged, push, query, limitToLast, onChildAdded, update, off, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut, browserSessionPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATWkyYE6b3wyz3LdFXAmxKxNQOexa_vUY",
            authDomain: "deck-daggerheart.firebaseapp.com",
            databaseURL: "https://deck-daggerheart-default-rtdb.firebaseio.com",
            projectId: "deck-daggerheart",
            storageBucket: "deck-daggerheart.firebasestorage.app",
            messagingSenderId: "825358776791",
            appId: "1:825358776791:web:ce0ab844f58c60573c7392",
            measurementId: "G-20TB05E9N2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        setPersistence(auth, browserSessionPersistence).catch(console.error);

        window.db = db; window.ref = ref; window.set = set; window.get = get; window.remove = remove;
        window.onValue = onValue; window.push = push; window.update = update; window.off = off; window.onDisconnect = onDisconnect;
        window.query = query; window.limitToLast = limitToLast; window.onChildAdded = onChildAdded;
        
        window.nomeJogador = "Mestre";
        const EMAIL_MESTRE = "tgbahiense@gmail.com";

        window.fazerLogout = function() {
            signOut(auth).then(() => window.location.href = "index.html");
        }

        window.abrirFichaDoJogador = function(nome) {
            window.nomeJogador = nome;
            get(ref(db, `mesa_rpg/jogadores/${nome}/slots/Fundamental`)).then(snap => {
                if(snap.exists() && snap.val().profissao) {
                    localStorage.setItem('profissaoSelecionada', snap.val().profissao);
                    if(window.abrirFichaPersonagem) window.abrirFichaPersonagem();
                } else alert("Jogador sem classe.");
            });
        };

        window.toggleMesaJogador = function(nome) {
            const el = document.getElementById(`mesa-${nome}`);
            if(el) el.classList.toggle('ativo');
        };

        window.atualizarSincronia = function() {
            const btn = document.querySelector('.btn-refresh');
            if(btn) btn.classList.add('spin-anim');
            document.getElementById('painel').innerHTML = '<p style="color:#666;text-align:center">Ressincronizando...</p>';
            document.getElementById('area-inimigos').innerHTML = '';
            
            iniciarMonitoramentoPresenca();
            iniciarPainelJogadores();

            if(window.iniciarSistemaInimigos) window.iniciarSistemaInimigos();
            if(window.iniciarSistemaMedo) window.iniciarSistemaMedo();
            if(window.escutarRolagens) window.escutarRolagens();

            setTimeout(() => { if(btn) btn.classList.remove('spin-anim'); }, 1000);
        };

        let presencaCache = {};
        function iniciarMonitoramentoPresenca() {
            onValue(ref(db, 'mesa_rpg/presenca'), (snap) => {
                presencaCache = snap.val() || {};
                document.querySelectorAll('.card-jogador').forEach(card => {
                    const nomeEl = card.querySelector('.nome');
                    if (nomeEl) {
                        const nome = nomeEl.textContent.trim();
                        atualizarBolinhaPresenca(card, nome);
                    }
                });
            });
        }

        function atualizarBolinhaPresenca(cardElement, nomePersonagem) {
            const oldDot = cardElement.querySelector('.status-dot');
            if(oldDot) oldDot.remove();
            const dot = document.createElement('span');
            dot.className = 'status-dot';
            const isOnline = Object.keys(presencaCache).some(k => k.toUpperCase() === nomePersonagem.toUpperCase());
            dot.classList.add(isOnline ? 'status-online' : 'status-offline');
            const nomeWrapper = cardElement.querySelector('.nome-wrapper');
            if(nomeWrapper) nomeWrapper.appendChild(dot);
        }

        function iniciarPainelJogadores() {
            const jogadoresRef = ref(db, 'mesa_rpg/jogadores');
            const accountsRef = ref(db, 'mesa_rpg/accounts');
            let nomesDePersonagens = new Set();
            let cacheJogadores = {};

            function render() {
                const painel = document.getElementById('painel');
                if(!painel) return;
                painel.innerHTML = "";
                const nomes = Array.from(nomesDePersonagens).sort();
                if (nomes.length === 0) { painel.innerHTML = "<p style='color:#666;text-align:center'>Vazio.</p>"; return; }

                nomes.forEach(nome => {
                    const p = cacheJogadores[nome] || {};
                    const card = document.createElement('div');
                    card.className = 'card-jogador';
                    const safeName = nome.replace(/'/g, "\\'");

                    let htmlMao = "";
                    if(p.mao && p.mao.length > 0) {
                        p.mao.forEach(c => {
                            let cl = "mini-carta"; let tt = c.nome; let ex = "";
                            if(c.estado==='curto') { cl+=" indisponivel"; ex+=`<div class="icone-descanso-mini"><img src="img/meia-lua.png"></div>`; }
                            if(c.estado==='longo') { cl+=" indisponivel"; ex+=`<div class="icone-descanso-mini"><img src="img/lua-cheia.png"></div>`; }
                            if(c.tokens>0) ex+=`<div class="token-count">${c.tokens}</div>`;
                            htmlMao += `<div class="${cl}" style="background-image: url('${c.caminho}')" title="${tt}">${ex}</div>`;
                        });
                    } else { htmlMao = "<span style='font-size:0.7rem; color:#666'>Vazia</span>"; }

                    let htmlMesa = "";
                    if(p.slots) {
                        ['Ancestralidade', 'Comunidade', 'Fundamental', 'Especializacao', 'Maestria'].forEach(k => {
                            if(p.slots[k]) htmlMesa += `<div class="mini-carta slot-ativo" style="background-image: url('${p.slots[k].caminho}')" title="${k}"></div>`;
                        });
                    }
                    if(p.reserva && p.reserva.length > 0) {
                        p.reserva.forEach(c => htmlMesa += `<div class="mini-carta carta-reserva-visual" style="background-image: url('${c.caminho}')" title="Reserva"></div>`);
                    }
                    if(htmlMesa === "") htmlMesa = "<span style='font-size:0.7rem; color:#666'>Nada na mesa.</span>";

                    let classeNome = "";
                    if(p.slots && p.slots.Fundamental && p.slots.Fundamental.profissao) classeNome = p.slots.Fundamental.profissao;

                    card.innerHTML = `
                        <div class="card-header">
                            <div class="nome-wrapper">
                                <div class="nome">${nome}</div>
                                ${classeNome ? `<div class="tag-classe">${classeNome}</div>` : ''}
                            </div>
                            <button class="btn-abrir-ficha-mestre" onclick="window.abrirFichaDoJogador('${safeName}')">üìù</button>
                        </div>
                        <div class="label">M√£o</div><div class="grid-mini" data-jogador="${nome}">${htmlMao}</div>
                        <button class="btn-expandir-mesa" onclick="window.toggleMesaJogador('${safeName}')">üìÇ Ver Mesa</button>
                        <div id="mesa-${nome}" class="mesa-expandida">
                            <div class="label">Mesa & Reserva</div>
                            <div class="grid-mini">${htmlMesa}</div>
                        </div>
                    `;
                    painel.appendChild(card);
                    atualizarBolinhaPresenca(card, nome);
                });
            }

            onValue(accountsRef, (snap) => {
                const setNomes = new Set();
                if (snap.exists()) { snap.forEach(c => { const d = c.val(); if (d.status !== 'inactive' && d.characters) Object.keys(d.characters).forEach(n => setNomes.add(String(n).toUpperCase())); }); }
                nomesDePersonagens = setNomes; render();
            });
            onValue(jogadoresRef, (snap) => {
                cacheJogadores = snap.exists() ? snap.val() : {};
                Object.keys(cacheJogadores).forEach(n => nomesDePersonagens.add(String(n).toUpperCase()));
                render();
            });
            onChildChanged(jogadoresRef, (snap) => {
                const n = snap.key; const d = snap.val();
                
                // CORRE√á√ÉO: S√≥ anima se a carta foi usada nos √∫ltimos 2 segundos
                if(d.cartaUsada && (Date.now() - d.cartaUsada.timestamp < 2000)) {
                    animarCartaEspecifica(n, d.cartaUsada);
                }
            });
        }

        // --- CONTE√öDO DO ESCUDO (RICAMENTE FORMATADO) ---
        const topicos = {
            testes: {
                titulo: "üé≤ TESTES & DUALIDADE",
                conteudo: `
                    <h2>üé≤ TESTES & DUALIDADE</h2>
                    <h3>Rolagem Padr√£o</h3>
                    <p><code>2d12 (Esperan√ßa + Medo) + Atributo + B√¥nus</code></p>
                    <p><strong>Cr√≠tico:</strong> Dados iguais (ex: 6 e 6) = Sucesso Autom√°tico e ganha Esperan√ßa.</p>
                    
                    <h3>Resultados</h3>
                    <ul>
                        <li><strong>Sucesso com Esperan√ßa:</strong> Total ‚â• Dificuldade, e dado de Esperan√ßa > Medo.<br><span style="color:#d4af37">Ganha +1 Esperan√ßa.</span></li>
                        <li><strong>Sucesso com Medo:</strong> Total ‚â• Dificuldade, e dado de Medo > Esperan√ßa.<br><span style="color:#bd6ceb">GM ganha +1 Medo ou faz um movimento.</span></li>
                        <li><strong>Falha:</strong> Total < Dificuldade.<br><span style="color:#ff6666">GM faz um movimento.</span></li>
                    </ul>
                `
            },
            recursos: {
                titulo: "üíé RECURSOS",
                conteudo: `
                    <h2>üíé RECURSOS</h2>
                    <h3>Esperan√ßa</h3>
                    <p><strong>Ganho:</strong> Ao rolar Sucesso com Esperan√ßa.</p>
                    <p><strong>Gastos:</strong></p>
                    <ul>
                        <li><strong>Experi√™ncia (+1 Esp):</strong> Adicione +1d6 a qualquer rolagem (antes ou depois).</li>
                        <li><strong>Ajudar (+1 Esp):</strong> Adicione +1d6 (ou +1d8 se tiver v√≠nculo) para um aliado.</li>
                        <li><strong>Tag Team (+2 Esp):</strong> Realize um ataque combinado.</li>
                    </ul>
                    
                    <h3>Fadiga (PF)</h3>
                    <p><strong>Uso:</strong> Pagar custo de habilidades ou absorver consequ√™ncias menores.</p>
                    <p><strong>Sem PF?</strong> Se n√£o tiver espa√ßo, marque <strong>PV</strong> (Dano) em vez disso.</p>
                `
            },
            combate: {
                titulo: "‚öîÔ∏è COMBATE",
                conteudo: `
                    <h2>‚öîÔ∏è COMBATE</h2>
                    <h3>Ataque</h3>
                    <ul>
                        <li><strong>Teste:</strong> Atributo da arma vs <strong>Evas√£o</strong> do alvo.</li>
                        <li><strong>Vantagem:</strong> Role +1d6 e some ao total.</li>
                        <li><strong>Desvantagem:</strong> Role -1d6 e subtraia do total.</li>
                    </ul>
                    <h3>Dano</h3>
                    <p>Se acertar, role os dados de dano da arma/magia.</p>
                    <p>O alvo compara o dano com seus <strong>Limiares</strong>.</p>
                `
            },
            dano: {
                titulo: "ü©∏ DANO",
                conteudo: `
                    <h2>ü©∏ DANO & SA√öDE</h2>
                    <h3>N√≠veis de Dano</h3>
                    <ul>
                        <li><strong>Menor (1-PV):</strong> Dano abaixo do limiar Maior.</li>
                        <li><strong>Maior (2-PV):</strong> Dano entre Maior e Grave.</li>
                        <li><strong>Grave (3-PV):</strong> Dano acima do limiar Grave.</li>
                    </ul>
                    <h3>Resist√™ncias</h3>
                    <ul>
                        <li><strong>Resist√™ncia:</strong> Reduz o dano √† metade (arredondado para cima).</li>
                        <li><strong>Imunidade:</strong> Reduz o dano a zero.</li>
                    </ul>
                `
            },
            armadura: {
                titulo: "üõ°Ô∏è ARMADURA",
                conteudo: `
                    <h2>üõ°Ô∏è ARMADURA (PA)</h2>
                    <p>Gaste <strong>1 Slot de Armadura</strong> para reduzir a severidade do dano em <strong>1 n√≠vel</strong>.</p>
                    <ul>
                        <li>Grave (3) ‚ûù Maior (2)</li>
                        <li>Maior (2) ‚ûù Menor (1)</li>
                        <li>Menor (1) ‚ûù Nenhum (0)</li>
                    </ul>
                    <p><strong>Limite:</strong> Apenas 1 uso de armadura por ataque recebido.</p>
                `
            },
            morte: {
                titulo: "‚ò†Ô∏è MORTE",
                conteudo: `
                    <h2>‚ò†Ô∏è MORTE</h2>
                    <p>Quando marcar o <strong>√∫ltimo ponto de vida</strong>, o jogador deve escolher:</p>
                    <ul>
                        <li><strong>Arriscar Tudo:</strong> Role um teste de Medo. Se falhar, morre. Se passar, age imediatamente.</li>
                        <li><strong>Evitar a Morte:</strong> O personagem apaga, fica fora da cena e ganha uma <strong>Cicatriz</strong> permanente.</li>
                        <li><strong>Sacrif√≠cio Glorioso:</strong> O personagem morre, mas realiza uma √∫ltima a√ß√£o com Sucesso Cr√≠tico autom√°tico.</li>
                    </ul>
                `
            },
            distancia: {
                titulo: "üìè DIST√ÇNCIA",
                conteudo: `
                    <h2>üìè DIST√ÇNCIA & ALCANCE</h2>
                    <ul>
                        <li><strong>Corpo a Corpo:</strong> Adjacente (ao alcance da m√£o).</li>
                        <li><strong>Muito Pr√≥ximo:</strong> At√© 3 metros / quadrados.</li>
                        <li><strong>Pr√≥ximo:</strong> At√© 10 metros (arremesso de faca).</li>
                        <li><strong>Distante:</strong> At√© 30 metros (tiro de arco).</li>
                        <li><strong>Muito Distante:</strong> Al√©m de 30 metros (visual).</li>
                    </ul>
                `
            },
            descanso: {
                titulo: "üí§ DESCANSO",
                conteudo: `
                    <h2>üí§ DESCANSO</h2>
                    <h3>Descanso Curto</h3>
                    <ul>
                        <li>Pode trocar cartas de Loadout.</li>
                        <li>Realize <strong>2 a√ß√µes</strong> dentre:
                            <ul>
                                <li>Curar: Role 1d4 + Patamar (recupera PV).</li>
                                <li>Reparar: Role 1d4 + Patamar (recupera PA).</li>
                                <li>Desestressar: Role 1d4 + Patamar (limpa PF).</li>
                                <li>Investigar/Preparar: Ganhe 1 Esperan√ßa.</li>
                            </ul>
                        </li>
                    </ul>
                    <h3>Descanso Longo</h3>
                    <p>Recupera <strong>TUDO</strong> (PV, PA, PF). Reseta Esperan√ßa para 2.</p>
                `
            },
            mestre: {
                titulo: "üíÄ GM",
                conteudo: `
                    <h2>üíÄ O MESTRE</h2>
                    <p>Voc√™ n√£o rola dados (exceto dano ou sorte). Os jogadores rolam tudo.</p>
                    <h3>Fa√ßa um Movimento quando:</h3>
                    <ul>
                        <li>Um jogador falhar na rolagem.</li>
                        <li>Um jogador rolar com Medo (voc√™ pode pegar 1 Medo OU fazer um movimento).</li>
                        <li>Os jogadores olharem para voc√™ esperando algo acontecer.</li>
                    </ul>
                `
            }
        };

        window.exibirTopico = function(id) { if(topicos[id]) { document.getElementById('escudo-conteudo').innerHTML = topicos[id].conteudo; document.getElementById('modal-escudo').classList.add('ativo'); } }
        window.fecharEscudo = function() { document.getElementById('modal-escudo').classList.remove('ativo'); }
        document.getElementById('modal-escudo').addEventListener('click', function(e) { if(e.target===this) fecharEscudo(); });

        onAuthStateChanged(auth, u => {
            document.getElementById('loading-screen').style.display = 'none';
            if(!u || u.email.toLowerCase().trim() !== EMAIL_MESTRE.toLowerCase().trim()) { window.location.href="index.html"; return; }
            iniciarMonitoramentoPresenca();
            iniciarPainelJogadores();
            
            function loadScript(src) {
                const script = document.createElement('script');
                script.src = src + "?t=" + Date.now();
                document.body.appendChild(script);
            }
            loadScript("ficha.js");
            loadScript("dados.js");
            loadScript("inimigos.js");
            loadScript("medo.js");
            loadScript("npcs.js"); // <--- ADICIONADO

            setTimeout(() => {
                if(window.iniciarSistemaInimigos) window.iniciarSistemaInimigos();
                if(window.iniciarSistemaMedo) window.iniciarSistemaMedo();
                if(window.escutarRolagens) window.escutarRolagens();
                
                // INICIAR NPCS
                if(window.carregarListaNPCs) window.carregarListaNPCs();
                if(window.monitorarNPCAtivo) window.monitorarNPCAtivo(); // Opcional no mestre, mas bom pra garantir
            }, 1000);
        });

        document.addEventListener('mouseover', (e) => {
            const c = e.target.closest('.mini-carta, .slot-ativo, .carta-reserva-visual');
            if (c && !c.classList.contains('status-vazio')) {
                const p = document.getElementById('preview-carta-mestre');
                let bg = c.style.backgroundImage;
                if (!bg || bg === 'none') bg = window.getComputedStyle(c).backgroundImage;
                if (bg && bg !== 'none') {
                    p.style.backgroundImage = bg;
                    p.innerHTML = c.classList.contains('mini-carta') ? c.innerHTML : '';
                    p.style.display = 'flex';
                }
            }
        });
        
        document.addEventListener('mouseout', (e) => { 
            if (e.target.closest('.mini-carta, .slot-ativo, .carta-reserva-visual')) {
                document.getElementById('preview-carta-mestre').style.display = 'none';
            }
        });

        window.realizarDescanso = function(t){ get(ref(db,'mesa_rpg/jogadores')).then(s=>{if(s.exists()){Object.keys(s.val()).forEach(n=>{const p=s.val()[n]; if(p.mao){let m=false;p.mao.forEach(c=>{if(c&&(t==='longo'||c.estado==='curto')){c.estado='ativo';m=true}});if(m)set(ref(db,`mesa_rpg/jogadores/${n}/mao`),p.mao)} if(p.slots){let m=false;Object.keys(p.slots).forEach(k=>{if(p.slots[k]&&(t==='longo'||p.slots[k].estado==='curto')){p.slots[k].estado='ativo';m=true}});if(m)set(ref(db,`mesa_rpg/jogadores/${n}/slots`),p.slots)}})}})};
        function animarCartaEspecifica(n,c){const g=document.querySelector(`[data-jogador="${n}"]`);if(!g)return;const i=g.querySelectorAll('.mini-carta');i.forEach(e=>{if(e.style.backgroundImage.includes(c.caminho.split('/').pop())){e.style.transform="scale(1.2)";e.style.boxShadow="0 0 15px gold";setTimeout(()=>{e.style.transform="";e.style.boxShadow=""},1000)}});const p=document.getElementById('preview-carta-mestre');p.style.backgroundImage=`url('${c.caminho}')`;p.style.display='block';setTimeout(()=>p.style.display='none',3000)};
    </script>
</body>
</html>