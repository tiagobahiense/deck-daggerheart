<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mestre - Daggerheart</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        /* PROTE√á√ÉO: Bloqueia sele√ß√£o e arrasto na tela do mestre tamb√©m */
        * {
            user-select: none;
            -webkit-user-drag: none;
        }
        
        body { 
            background: #111; 
            color: #d4af37; 
            font-family: 'MedievalSharp', cursive; 
            margin: 0; 
            padding: 20px; 
        }
        h1 { 
            text-align: center; 
            border-bottom: 1px solid #333; 
            padding-bottom: 20px; 
        }
        #painel { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            justify-content: center; 
        }
        
        .card-jogador {
            background: #1a1a1a; 
            border: 1px solid #444; 
            border-radius: 8px;
            width: 320px; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            position: relative;
        }
        
        .nome { 
            font-size: 1.4rem; 
            color: #fff; 
            text-align: center; 
            border-bottom: 1px solid #333; 
            padding-bottom: 5px; 
        }
        
        .label { 
            font-size: 0.8rem; 
            color: #888; 
            text-transform: uppercase; 
            margin-top: 5px; 
            border-bottom: 1px dashed #333;
        }
        
        .grid-mini { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 5px; 
            min-height: 40px;
        }
        
        .mini-carta {
            width: 50px; 
            height: 75px; 
            background-size: contain; 
            background-repeat: no-repeat;
            background-position: center; 
            border: 1px solid #333; 
            border-radius: 4px;
            transition: 0.2s; 
            cursor: help;
            background-color: #000;
            pointer-events: none; /* Imagem segura, o mouse atravessa */
        }
        
        .mini-carta:hover { 
            transform: scale(4); 
            z-index: 100; 
            border-color: gold; 
            box-shadow: 0 0 20px #000; 
        }
        
        .carta-reserva-visual {
            opacity: 0.7;
            filter: grayscale(0.6);
        }
        .carta-reserva-visual:hover {
            opacity: 1;
            filter: grayscale(0);
        }
        
        .slot-ativo { 
            border-color: #d4af37; 
            box-shadow: 0 0 5px rgba(212, 175, 55, 0.3);
        }

        .status-vazio {
            font-size: 0.7rem;
            color: #444;
            font-style: italic;
            padding: 10px;
        }

        .btn-banir {
            margin-top: 15px;
            background-color: #3e0000;
            color: #ff6666;
            border: 1px solid #500;
            padding: 8px;
            cursor: pointer;
            font-family: inherit;
            border-radius: 4px;
            transition: 0.2s;
            font-size: 0.8rem;
        }
        .btn-banir:hover {
            background-color: #800;
            color: white;
            border-color: red;
        }
    </style>
</head>
<body>
    <h1>Vis√£o do Narrador</h1>
    <div id="painel">Conectando ao Grim√≥rio...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATWkyYE6b3wyz3LdFXAmxKxNQOexa_vUY",
            authDomain: "deck-daggerheart.firebaseapp.com",
            databaseURL: "https://deck-daggerheart-default-rtdb.firebaseio.com",
            projectId: "deck-daggerheart",
            storageBucket: "deck-daggerheart.firebasestorage.app",
            messagingSenderId: "825358776791",
            appId: "1:825358776791:web:ce0ab844f58c60573c7392",
            measurementId: "G-20TB05E9N2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- SEGURAN√áA NA TELA DO MESTRE ---
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('dragstart', event => event.preventDefault());
        // ------------------------------------

        window.removerJogador = function(nome) {
            if(confirm(`Tem certeza que deseja remover ${nome} da mesa? Isso apagar√° as cartas dele.`)) {
                remove(ref(db, `mesa_rpg/jogadores/${nome}`))
                    .then(() => console.log(`${nome} removido.`))
                    .catch((error) => console.error("Erro ao remover:", error));
            }
        }

        const jogadoresRef = ref(db, 'mesa_rpg/jogadores');

        onValue(jogadoresRef, (snapshot) => {
            const painel = document.getElementById('painel');
            const dados = snapshot.val();
            
            if(!dados) { 
                painel.innerHTML = "<p class='status-vazio'>Nenhum jogador conectado no momento.</p>"; 
                return; 
            }
            
            painel.innerHTML = ""; 
            
            Object.keys(dados).forEach(nome => {
                const p = dados[nome];
                const card = document.createElement('div');
                card.className = 'card-jogador';
                
                let htmlMao = "";
                if(p.mao && p.mao.length > 0) {
                    p.mao.forEach(c => {
                        htmlMao += `<div class="mini-carta" style="background-image: url('${c.caminho}')" title="${c.nome}"></div>`;
                    });
                } else {
                    htmlMao = "<span class='status-vazio'>M√£o vazia</span>";
                }

                let htmlSlots = "";
                if(p.slots) {
                    const ordem = ['Ancestralidade', 'Comunidade', 'Fundamental', 'Especializacao', 'Maestria'];
                    ordem.forEach(key => {
                        if(p.slots[key]) {
                            htmlSlots += `<div class="mini-carta slot-ativo" style="background-image: url('${p.slots[key].caminho}')" title="${key}: ${p.slots[key].nome}"></div>`;
                        }
                    });
                }
                if(htmlSlots === "") htmlSlots = "<span class='status-vazio'>Nenhum ativo</span>";

                let htmlReserva = "";
                if(p.reserva && p.reserva.length > 0) {
                     htmlReserva = `<div class="label">Reserva (${p.reserva.length})</div>`;
                     let cartasReservaHTML = "";
                     p.reserva.forEach(c => {
                         cartasReservaHTML += `<div class="mini-carta carta-reserva-visual" style="background-image: url('${c.caminho}')" title="Reserva: ${c.nome}"></div>`;
                     });
                     htmlReserva += `<div class="grid-mini">${cartasReservaHTML}</div>`;
                }

                card.innerHTML = `
                    <div class="nome">${nome}</div>
                    
                    <div class="label">M√£o (${p.mao ? p.mao.length : 0})</div>
                    <div class="grid-mini">${htmlMao}</div>
                    
                    <div class="label">Mesa (Ativos)</div>
                    <div class="grid-mini">${htmlSlots}</div>
                    
                    ${htmlReserva}

                    <button class="btn-banir" onclick="removerJogador('${nome}')">üíÄ Remover da Mesa</button>
                `;
                
                painel.appendChild(card);
            });
        });
    </script>
</body>
</html>