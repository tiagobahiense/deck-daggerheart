<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesa de Jogo - Daggerheart (GM)</title>
    <link rel="stylesheet" href="style.css?v=8.0">
    <link rel="stylesheet" href="ficha.css?v=5.0">
    <link rel="stylesheet" href="dados.css?v=2.0">
    <link rel="stylesheet" href="inimigos.css?v=3.6">
    <link rel="stylesheet" href="medo.css?v=1.0">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        body { display: flex; height: 100vh; flex-direction: column; background-color: #050505; margin: 0; overflow: hidden; }
        
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; display: flex; align-items: center; justify-content: center; color: var(--gold); font-family: 'MedievalSharp', cursive; font-size: 2rem; }

        #container-principal { display: flex; flex: 1; overflow: hidden; }
        
        #painel-lateral { width: 300px; background: #111; border-right: 2px solid var(--gold); display: flex; flex-direction: column; overflow-y: auto; padding: 10px; z-index: 10; }
        
        #tabuleiro-central { flex: 1; position: relative; background: url('img/background_epico.png') no-repeat center center/cover; overflow: hidden; }

        /* Estilos dos Jogadores (P√≠lulas) */
        .jogador-card { background: rgba(0,0,0,0.8); border: 1px solid #444; border-radius: 8px; margin-bottom: 10px; padding: 10px; cursor: pointer; transition: 0.2s; }
        .jogador-card:hover { border-color: var(--gold); background: rgba(50,50,50,0.8); }
        .jogador-card.ativo { border: 2px solid var(--gold); box-shadow: 0 0 10px var(--gold); }
        .nome-jogador { font-weight: bold; color: var(--gold); font-size: 1.1rem; display: flex; justify-content: space-between; }
        
        /* Grid de Jogadores no Tabuleiro */
        #grid-jogadores { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            padding: 20px; 
            height: 100%; 
            overflow-y: auto;
            align-content: flex-start;
        }

        .mesa-jogador {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #555;
            border-radius: 10px;
            padding: 15px;
            min-height: 250px;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .mesa-jogador.offline { opacity: 0.5; border-color: #333; }
        
        .area-cartas-jogador { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; }
        .mini-carta { 
            width: 60px; height: 84px; background-size: cover; border-radius: 4px; border: 1px solid #fff; cursor: zoom-in; 
            position: relative;
        }
        .mini-carta.em-uso { box-shadow: 0 0 15px #00ff00; border-color: #00ff00; animation: pulso 1s infinite; }
        
        /* Slots */
        .slots-jogador { display: flex; gap: 5px; margin-bottom: 5px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .slot-ativo { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #555; background-size: cover; background-position: center; cursor: help; }

        /* Preview Grande */
        #preview-carta-mestre {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 350px; height: 500px; background-size: contain; background-repeat: no-repeat;
            z-index: 10000; display: none; border: 3px solid var(--gold); background-color: #000;
            pointer-events: none;
        }

        @keyframes pulso { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="loading-screen">Carregando Grim√≥rio do Mestre...</div>
    <div id="preview-carta-mestre"></div>
    <div id="medo-overlay-msg"></div>

    <audio id="sound-medo-add"><source src="audio/sound-recolhe-medo.mp3" type="audio/mpeg"></audio>
    <audio id="sound-medo-use"><source src="audio/sound-usa-medo.mp3" type="audio/mpeg"></audio>

    <div id="container-principal">
        <aside id="painel-lateral">
            <h2 style="color:var(--gold); text-align:center;">Painel do Narrador</h2>
            <button onclick="window.location.href='admin.html'" style="width:100%; padding:8px; margin-bottom:15px; cursor:pointer;">‚öôÔ∏è Admin Contas</button>
            <button onclick="realizarDescanso('curto')" style="width:100%; padding:8px; margin-bottom:5px; cursor:pointer; background:#333; color:#fff;">üåô Descanso Curto (Todos)</button>
            <button onclick="realizarDescanso('longo')" style="width:100%; padding:8px; margin-bottom:15px; cursor:pointer; background:#111; color:var(--gold); border:1px solid var(--gold);">üåï Descanso Longo (Todos)</button>
            
            <div id="medo-container"></div> <h3 style="margin-top:20px; border-bottom:1px solid #555;">Jogadores Online</h3>
            <div id="lista-lateral-jogadores"></div>
        </aside>

        <main id="tabuleiro-central">
            <div id="grid-jogadores"></div>
            
            <div style="position: absolute; bottom: 20px; right: 20px;">
                <button id="btn-abrir-dados" onclick="abrirSeletorDados()" style="font-size:2rem; background:none; border:none; cursor:pointer;">üé≤</button>
            </div>
        </main>
    </div>

    <div id="modal-selecao-dados" onclick="if(event.target===this) fecharSeletorDados()"><div class="dados-content"><div class="dados-header">Rolagem GM</div><div class="dualidade-box"><span style="color:#ddd; font-size:0.8rem;">Teste (2d12)</span><button class="btn-dualidade" onclick="adicionarDualidade()">‚ö° Dualidade</button></div><hr style="border-top:1px solid #444; width:100%;"><div class="grid-dados"><div class="dado-control"><span class="dado-label">d4</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d4', -1)">-</button><span id="count-d4" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d4', 1)">+</button></div></div><div class="dado-control"><span class="dado-label">d6</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d6', -1)">-</button><span id="count-d6" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d6', 1)">+</button></div></div><div class="dado-control"><span class="dado-label">d8</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d8', -1)">-</button><span id="count-d8" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d8', 1)">+</button></div></div><div class="dado-control"><span class="dado-label">d10</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d10', -1)">-</button><span id="count-d10" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d10', 1)">+</button></div></div><div class="dado-control"><span class="dado-label">d12</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d12', -1)">-</button><span id="count-d12" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d12', 1)">+</button></div></div><div class="dado-control"><span class="dado-label">d20</span><div class="dado-btn-group"><button class="btn-qty" onclick="alterarQtdDado('d20', -1)">-</button><span id="count-d20" class="dado-count">0</span><button class="btn-qty" onclick="alterarQtdDado('d20', 1)">+</button></div></div></div><button class="btn-rolar-final" onclick="rolarDadosConfirmados()">Rolar</button></div></div>
    <div id="overlay-rolagem"><div id="quem-rolou-label"></div><div id="container-dados-rolando"></div><button id="btn-fechar-rolagem" onclick="fecharResultadoRolagem()">Fechar</button></div>

    <script type="module" src="script.js?v=11.0"></script>
    <script>
        function loadScript(src) {
            const script = document.createElement('script');
            script.src = src + "?t=" + Date.now();
            document.body.appendChild(script);
        }
        window.addEventListener('load', () => {
            setTimeout(() => {
                window.nomeJogador = "Mestre"; // Identifica como GM
                loadScript("dados.js");
                loadScript("inimigos.js");
                loadScript("medo.js");
                document.getElementById('loading-screen').style.display = 'none';
                
                // Iniciar monitoramento
                if(window.iniciarSistemaMedo) window.iniciarSistemaMedo();
                if(window.escutarRolagens) window.escutarRolagens();
                
                // Monitorar Jogadores
                if(window.ref && window.db) {
                    window.onValue(window.ref(window.db, 'mesa_rpg/jogadores'), (snap) => {
                        renderizarMesa(snap.val());
                        renderizarListaLateral(snap.val());
                    });
                    
                    window.onValue(window.ref(window.db, 'mesa_rpg/presenca'), (snap) => {
                        window.presencaOnline = snap.val() || {};
                    });
                }
            }, 1000);
        });

        function renderizarMesa(jogadores) {
            const grid = document.getElementById('grid-jogadores');
            grid.innerHTML = '';
            if(!jogadores) return;

            Object.keys(jogadores).forEach(nome => {
                const dados = jogadores[nome];
                const isOnline = window.presencaOnline && window.presencaOnline[nome];
                
                const card = document.createElement('div');
                card.className = `mesa-jogador ${isOnline ? '' : 'offline'}`;
                
                let slotsHtml = '<div class="slots-jogador">';
                if(dados.slots) {
                    Object.keys(dados.slots).forEach(k => {
                        if(dados.slots[k]) slotsHtml += `<div class="slot-ativo" style="background-image:url('${dados.slots[k].caminho_perfil || dados.slots[k].caminho}')" title="${k}"></div>`;
                    });
                }
                slotsHtml += '</div>';

                let cartasHtml = '<div class="area-cartas-jogador">';
                if(dados.mao) {
                    dados.mao.forEach(c => {
                        cartasHtml += `<div class="mini-carta lazy-card" style="background-image:url('${c.caminho}')" onmouseover="verCartaGrande('${c.caminho}')"></div>`;
                    });
                }
                cartasHtml += '</div>';

                // Verifica Carta Usada Recentemente
                if(dados.cartaUsada && (Date.now() - dados.cartaUsada.timestamp < 5000)) {
                    animarCartaEspecifica(nome, dados.cartaUsada);
                }

                card.innerHTML = `<div class="nome-jogador">${nome} ${isOnline ? 'üü¢' : 'üî¥'}</div>${slotsHtml}${cartasHtml}`;
                grid.appendChild(card);
            });
        }

        function renderizarListaLateral(jogadores) {
            const lista = document.getElementById('lista-lateral-jogadores');
            lista.innerHTML = '';
            if(!jogadores) return;
            Object.keys(jogadores).forEach(nome => {
                const div = document.createElement('div');
                div.className = 'jogador-card';
                div.innerText = nome;
                lista.appendChild(div);
            });
        }

        window.verCartaGrande = function(src) {
            const p = document.getElementById('preview-carta-mestre');
            p.style.backgroundImage = `url('${src}')`;
            p.style.display = 'block';
        }
        
        document.addEventListener('mouseout', (e) => { 
            if (e.target.closest('.mini-carta, .slot-ativo, .carta-reserva-visual')) {
                document.getElementById('preview-carta-mestre').style.display = 'none';
            }
        });

        // Fun√ß√µes de Descanso e Anima√ß√£o de Carta (Reutilizadas para economizar espa√ßo - j√° estavam corretas no bloco anterior)
        window.realizarDescanso = function(t){ get(ref(db,'mesa_rpg/jogadores')).then(s=>{if(s.exists()){Object.keys(s.val()).forEach(n=>{const p=s.val()[n]; if(p.mao){let m=false;p.mao.forEach(c=>{if(c&&(t==='longo'||c.estado==='curto')){c.estado='ativo';m=true}});if(m)set(ref(db,`mesa_rpg/jogadores/${n}/mao`),p.mao)} if(p.slots){let m=false;Object.keys(p.slots).forEach(k=>{if(p.slots[k]&&(t==='longo'||p.slots[k].estado==='curto')){p.slots[k].estado='ativo';m=true}});if(m)set(ref(db,`mesa_rpg/jogadores/${n}/slots`),p.slots)}})}})};
        function animarCartaEspecifica(n,c){const g=document.querySelector(`[data-jogador="${n}"]`);if(!g)return;const i=g.querySelectorAll('.mini-carta');i.forEach(el=>{if(el.style.backgroundImage.includes(encodeURI(c.caminho))){el.classList.add('em-uso');setTimeout(()=>el.classList.remove('em-uso'),3000)}})}
    </script>
</body>
</html>