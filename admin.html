<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Daggerheart</title>
    <link rel="stylesheet" href="style.css?v=8.0">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        .inactive-account {
            opacity: 0.6;
            border: 1px solid #ff6666;
        }
        .inactive-account .player-email {
            color: #ff9999;
        }
        #inactive-users-list {
            margin-top: 30px;
            border-top: 1px solid #555;
            padding-top: 20px;
        }
        .reactivate-btn {
            background: #2e8b57 !important;
            border-color: #2e8b57 !important;
        }
        .reactivate-btn:hover {
            background: #3cb371 !important;
        }

        /* MODAL TROCAR SENHA */
        #modal-trocar-senha {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 5000;
            justify-content: center;
            align-items: center;
        }

        #modal-trocar-senha.ativo {
            display: flex;
        }

        .modal-senha-content {
            background: rgba(20, 20, 20, 0.95);
            border: 2px solid var(--gold);
            border-radius: 10px;
            padding: 30px;
            max-width: 400px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.9);
            position: relative;
        }

        .modal-senha-content h2 {
            color: var(--gold);
            margin-top: 0;
            text-align: center;
        }

        .modal-senha-content .input-group {
            margin: 15px 0;
        }

        .modal-senha-content input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gold);
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            box-sizing: border-box;
        }

        .modal-senha-content input::placeholder {
            color: #999;
        }

        .modal-senha-content .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-senha-content button {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--gold);
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .modal-senha-content .btn-confirmar {
            background: #4CAF50;
            color: #fff;
        }

        .modal-senha-content .btn-confirmar:hover {
            background: #45a049;
        }

        .modal-senha-content .btn-cancelar {
            background: #f44336;
            color: #fff;
        }

        .modal-senha-content .btn-cancelar:hover {
            background: #da190b;
        }

        #btn-fechar-modal-senha {
            position: absolute;
            top: 10px;
            right: 15px;
            background: var(--gold);
            color: #000;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #btn-fechar-modal-senha:hover {
            background: #ffff99;
        }
    </style>
</head>
<body>

    <div id="access-denied-screen">
        <h1 style="color: red;">ACESSO NEGADO</h1>
        <p>Voc√™ est√° logado, mas n√£o como Narrador.</p>
        <div class="debug-box" id="debug-text">
            Verificando credenciais...
        </div>
        <button class="btn-voltar" onclick="fazerLogout()" style="margin-top: 20px; border-color: red; color: red;">SAIR E TENTAR NOVAMENTE</button>
    </div>

    <div id="admin-container" style="display: none;">
        <div class="admin-header">
            <h1>Gest√£o da Mesa</h1>
            <div>
                <button class="btn-nav" onclick="window.location.href='mestre.html'">Ir para o Tabuleiro</button>
                <button class="btn-nav" onclick="abrirModalTrocarSenha()" style="background: #4CAF50;">üîê Trocar Minha Senha</button>
                <button class="btn-nav" onclick="verificarStatusContas()" style="background: #FF9800; font-size: 0.8rem;">üîç Debug Contas</button>
                <button class="btn-nav" onclick="fazerLogout()">Sair</button>
            </div>
        </div>

        <div style="display: flex; gap: 40px; align-items: flex-start; justify-content: center; flex-wrap: wrap;">

            <div class="admin-box" style="width: 300px; padding: 20px;">
                <h3>Criar Novo Jogador</h3>

                <div class="input-group">
                    <input type="email" id="new-user-email" placeholder="Email do Jogador" class="input-login">
                </div>
                <div class="input-group">
                    <input type="password" id="new-user-pass" placeholder="Senha" class="input-login">
                    <span class="toggle-password" onclick="togglePassword('new-user-pass')">üëÅÔ∏è</span>
                </div>

                <button class="btn-main" onclick="criarUsuario()">Criar Conta</button>
            </div>

            <div style="flex-grow: 1; min-width: 300px;">
                <h3 style="text-align: center; color: var(--gold);">Contas Ativas</h3>
                <div id="users-list" class="admin-grid">
                    <p>Carregando...</p>
                </div>

                <h3 style="text-align: center; color: #ff9999; margin-top: 30px;">Contas Inativas</h3>
                <div id="inactive-users-list" class="admin-grid">
                    <p>Carregando...</p>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signOut, onAuthStateChanged, browserSessionPersistence, setPersistence, fetchSignInMethodsForEmail, updatePassword, sendPasswordResetEmail, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATWkyYE6b3wyz3LdFXAmxKxNQOexa_vUY",
            authDomain: "deck-daggerheart.firebaseapp.com",
            databaseURL: "https://deck-daggerheart-default-rtdb.firebaseio.com",
            projectId: "deck-daggerheart",
            storageBucket: "deck-daggerheart.firebasestorage.app",
            messagingSenderId: "825358776791",
            appId: "1:825358776791:web:ce0ab844f58c60573c7392",
            measurementId: "G-20TB05E9N2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        // Auth secund√°rio para criar usu√°rios sem derrubar a sess√£o do Mestre
        const secondaryApp = initializeApp(firebaseConfig, "secondary");
        const secondaryAuth = getAuth(secondaryApp);

        const EMAIL_MESTRE = "tgbahiense@gmail.com";

        // Configura persist√™ncia do login
        setPersistence(auth, browserSessionPersistence)
            .then(() => {
                console.log("Persist√™ncia de autentica√ß√£o configurada com sucesso.");
                // Flag para evitar m√∫ltiplas verifica√ß√µes durante cria√ß√£o de usu√°rio
                let isCreatingUser = false;
                
                onAuthStateChanged(auth, user => {
                    // Ignora mudan√ßas durante a cria√ß√£o de usu√°rio (previne falsos positivos)
                    if (isCreatingUser) {
                        console.log("‚è≥ Mudan√ßa de auth ignorada (cria√ß√£o de usu√°rio em progresso)");
                        return;
                    }
                    
                    const deniedScreen = document.getElementById('access-denied-screen');
                    const debugText = document.getElementById('debug-text');
                    const adminContainer = document.getElementById('admin-container');

                    console.log("onAuthStateChanged chamado. Usu√°rio:", user ? user.email : "Nenhum");

                    if (!user) {
                        deniedScreen.style.display = 'flex';
                        debugText.innerHTML = "Nenhum usu√°rio logado. <br>Por favor, fa√ßa login.";
                        adminContainer.style.display = 'none';
                        return;
                    }

                    const currentEmail = user.email.toLowerCase().trim();
                    const masterEmail = EMAIL_MESTRE.toLowerCase().trim();

                    if (currentEmail !== masterEmail) {
                        deniedScreen.style.display = 'flex';
                        adminContainer.style.display = 'none';
                        debugText.innerHTML = `
                            <p><strong>DIAGN√ìSTICO:</strong></p>
                            <p>Logado como: <span style="color: white">${currentEmail}</span></p>
                            <p>Mestre esperado: <span style="color: yellow">${masterEmail}</span></p>
                            <p>UID: ${user.uid}</p>
                        `;
                    } else {
                        deniedScreen.style.display = 'none';
                        adminContainer.style.display = 'block';
                        carregarUsuarios();
                        carregarUsuariosInativos();
                    }
                });
            })
            .catch((error) => {
                console.error("Erro ao definir persist√™ncia:", error);
                document.getElementById('debug-text').innerHTML = "Erro ao carregar autentica√ß√£o. Consulte o console.";
            });

        window.togglePassword = function(id) {
            const input = document.getElementById(id);
            input.type = input.type === "password" ? "text" : "password";
        }

        window.fazerLogout = function() {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            });
        }

        // Vari√°vel para guardar o estado do mestre antes de criar usu√°rio
        let mestreSessionBackup = null;

        window.criarUsuario = function() {
            const email = document.getElementById('new-user-email').value;
            const pass = document.getElementById('new-user-pass').value;

            if(!email || !pass) return alert("Preencha tudo");

            // Guarda o estado atual do mestre ANTES de criar
            const currentUser = auth.currentUser;
            if (!currentUser || currentUser.email !== EMAIL_MESTRE) {
                alert("‚ö†Ô∏è Voc√™ n√£o est√° logado como mestre!");
                return;
            }
            mestreSessionBackup = { email: currentUser.email, uid: currentUser.uid };

            // Verifica se o e-mail j√° existe no Realtime Database como inativo
            get(ref(db, 'mesa_rpg/accounts_inactive')).then(snapshot => {
                if (snapshot.exists()) {
                    const inactiveAccounts = snapshot.val();
                    if (inactiveAccounts[email]) {
                        alert("Este e-mail j√° foi usado e est√° inativo. Reative a conta antes de us√°-lo novamente.");
                        return;
                    }
                }

                // Verifica se o e-mail j√° existe no Firebase Auth
                fetchSignInMethodsForEmail(auth, email)
                    .then((signInMethods) => {
                        if (signInMethods.length > 0) {
                            alert("Este e-mail j√° est√° registrado. Use outro e-mail.");
                            return;
                        }

                        // Verifica tamb√©m se j√° existe no Realtime Database
                        get(ref(db, 'mesa_rpg/accounts')).then(accountsSnap => {
                            if (accountsSnap.exists()) {
                                const accounts = accountsSnap.val();
                                const emailJaExiste = Object.values(accounts).some(acc => acc.email === email);
                                if (emailJaExiste) {
                                    alert("Este e-mail j√° est√° registrado. Use outro e-mail.");
                                    return;
                                }
                            }

                            // Marca que estamos criando usu√°rio (evita falsos positivos no onAuthStateChanged)
                            isCreatingUser = true;
                            
                            // IMPORTANTE: Usa secondaryAuth para criar usu√°rio, N√ÉO o auth principal do mestre
                            // Isso evita que a sess√£o do mestre seja derrubada
                            createUserWithEmailAndPassword(secondaryAuth, email, pass)
                            .then((cred) => {
                                const uid = cred.user.uid;
                                // Salva no Realtime Database (pode usar db do auth principal)
                                return set(ref(db, `mesa_rpg/accounts/${uid}`), {
                                    email: email,
                                    characters: {},
                                    status: 'active'
                                }).then(() => {
                                    // Faz logout do secondaryAuth imediatamente
                                    return signOut(secondaryAuth).catch(() => {});
                                }).then(() => {
                                    // Desmarca flag ap√≥s um pequeno delay para permitir que onAuthStateChanged se estabilize
                                    setTimeout(() => {
                                        isCreatingUser = false;
                                        
                                        // Verifica se o auth principal ainda est√° como mestre
                                        const currentAuthUser = auth.currentUser;
                                        if (!currentAuthUser || currentAuthUser.email !== EMAIL_MESTRE) {
                                            console.warn("‚ö†Ô∏è Sess√£o do mestre foi afetada! Recarregando p√°gina...");
                                            alert("‚ö†Ô∏è A sess√£o foi afetada. A p√°gina ser√° recarregada.\n\nPor favor, fa√ßa login novamente como mestre.");
                                            window.location.reload();
                                            return;
                                        }
                                        
                                        // Tudo OK, continua normalmente
                                        alert("‚úÖ Usu√°rio criado: " + email);
                                        document.getElementById('new-user-email').value = "";
                                        document.getElementById('new-user-pass').value = "";
                                        carregarUsuarios();
                                    }, 500);
                                });
                            })
                            .catch((error) => {
                                // Limpa qualquer sess√£o residual do secondaryAuth
                                signOut(secondaryAuth).catch(() => {});
                                
                                // Desmarca flag
                                setTimeout(() => {
                                    isCreatingUser = false;
                                    
                                    // Verifica se o auth principal ainda est√° OK
                                    const currentAuthUser = auth.currentUser;
                                    if (!currentAuthUser || currentAuthUser.email !== EMAIL_MESTRE) {
                                        console.warn("‚ö†Ô∏è Sess√£o do mestre foi afetada ap√≥s erro!");
                                        alert("‚ö†Ô∏è A sess√£o foi afetada. A p√°gina ser√° recarregada.\n\nPor favor, fa√ßa login novamente como mestre.");
                                        window.location.reload();
                                        return;
                                    }
                                    
                                    let msg = "Erro ao criar: " + error.message;
                                    if (error.code === 'auth/email-already-in-use') {
                                        msg = "Este e-mail j√° est√° em uso.";
                                    } else if (error.code === 'auth/invalid-email') {
                                        msg = "E-mail inv√°lido.";
                                    } else if (error.code === 'auth/weak-password') {
                                        msg = "Senha muito fraca. Use pelo menos 6 caracteres.";
                                    }
                                    alert(msg);
                                }, 500);
                            });
                        }).catch((error) => {
                            alert("Erro ao verificar contas: " + error.message);
                        });
                    })
                    .catch((error) => {
                        alert("Erro ao verificar e-mail: " + error.message);
                    });
            });
        }

        function carregarUsuarios() {
            onValue(ref(db, 'mesa_rpg/accounts'), snapshot => {
                const list = document.getElementById('users-list');
                list.innerHTML = "";

                if(!snapshot.exists()) { list.innerHTML = "<p>Nenhuma conta encontrada.</p>"; return; }

                snapshot.forEach(childSnap => {
                    const uid = childSnap.key;
                    const data = childSnap.val();
                    if (data.status === 'inactive') return; // N√£o mostra contas inativas

                    const chars = data.characters ? Object.keys(data.characters) : [];
                    const charCount = chars.length;
                    const charLimit = 3;
                    const isAtLimit = charCount >= charLimit;

                    // Buscar classes de todos os personagens
                    const buscarClasse = async (charName) => {
                        try {
                            const charSlotRef = ref(db, `mesa_rpg/jogadores/${charName}/slots/Fundamental`);
                            const charSlotSnap = await get(charSlotRef);
                            if (charSlotSnap.exists() && charSlotSnap.val().profissao) {
                                const profissao = charSlotSnap.val().profissao;
                                return `<span style="background: rgba(212, 175, 55, 0.3); color: #d4af37; padding: 3px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px; border: 1px solid rgba(212, 175, 55, 0.6); font-weight: bold;">${profissao}</span>`;
                            }
                        } catch (e) {
                            console.error(`Erro ao buscar classe de ${charName}:`, e);
                        }
                        return '';
                    };
                    
                    // Construir HTML dos personagens com suas classes
                    let countColor = charCount >= 3 ? '#ff6b6b' : charCount >= 2 ? '#ffa94d' : '#4CAF50';
                    Promise.all(chars.map(async charName => {
                        const classeTag = await buscarClasse(charName);
                        return `<li>${charName}${classeTag} <button class="btn-banir" onclick="removerPerfil('${uid}', '${charName}')">üíÄ Remover Perfil</button></li>`;
                    })).then(htmls => {
                        const charHtml = htmls.join('');
                        const div = document.createElement('div');
                        div.className = 'player-card-admin';
                        div.innerHTML = `
                            <div class="player-email">
                                ${data.email}
                                <div style="margin-top: 8px; font-size: 0.85rem; color: ${countColor}; font-weight: bold;">
                                    üìä Personagens: ${charCount}/${charLimit}
                                </div>
                                ${isAtLimit ? `<div style="margin-top: 5px; font-size: 0.75rem; color: #ff6b6b;">‚ö†Ô∏è Limite atingido! Remova um personagem para criar novo.</div>` : ''}
                            </div>
                            <ul class="char-list" style="list-style: none; padding: 0;">
                                ${charHtml || '<li style="font-style:italic">Sem personagens</li>'}
                            </ul>
                            <button class="btn-main" onclick="abrirTrocarSenha('${uid}', '${data.email}')" style="margin-right: 5px;">üîê Trocar Senha</button>
                            <button class="btn-banir" onclick="removerConta('${uid}', '${data.email}')">üíÄ Desativar Conta</button>
                        `;
                        list.appendChild(div);
                    });
                });
            });
        }

        function carregarUsuariosInativos() {
            onValue(ref(db, 'mesa_rpg/accounts'), snapshot => {
                const list = document.getElementById('inactive-users-list');
                list.innerHTML = "";

                if(!snapshot.exists()) { list.innerHTML = "<p>Nenhuma conta inativa encontrada.</p>"; return; }

                let hasInactive = false;
                snapshot.forEach(childSnap => {
                    const uid = childSnap.key;
                    const data = childSnap.val();
                    if (data.status !== 'inactive') return;

                    hasInactive = true;
                    const chars = data.characters ? Object.keys(data.characters) : [];

                    let charHtml = "";
                    chars.forEach(charName => {
                        charHtml += `<li>${charName}</li>`;
                    });

                    const div = document.createElement('div');
                    div.className = 'player-card-admin inactive-account';
                    div.innerHTML = `
                        <div class="player-email">
                            ${data.email}
                            <button class="btn-banir reactivate-btn" onclick="reativarConta('${uid}', '${data.email}')">‚úÖ Reativar Conta</button>
                        </div>
                        <ul class="char-list" style="list-style: none; padding: 0;">
                            ${charHtml || '<li style="font-style:italic">Sem personagens</li>'}
                        </ul>
                    `;
                    list.appendChild(div);
                });

                if (!hasInactive) list.innerHTML = "<p>Nenhuma conta inativa encontrada.</p>";
            });
        }

        window.removerPerfil = function(uid, charName) {
            if (confirm(`Tem certeza que deseja remover o perfil "${charName}"?`)) {
                remove(ref(db, `mesa_rpg/jogadores/${charName}`))
                    .then(() => {
                        const userRef = ref(db, `mesa_rpg/accounts/${uid}/characters/${charName}`);
                        return remove(userRef);
                    })
                    .then(() => {
                        alert(`Perfil "${charName}" removido com sucesso!`);
                        carregarUsuarios();
                    })
                    .catch((error) => {
                        alert(`Erro ao remover perfil: ${error.message}`);
                        console.error("Erro detalhado:", error);
                    });
            }
        };

        window.removerConta = function(uid, email) {
            if (confirm(`Tem certeza que deseja desativar a conta "${email}" e DELETAR PERMANENTEMENTE TODOS os seus personagens?`)) {
                // Primeiro, remove todos os personagens da conta
                get(ref(db, `mesa_rpg/accounts/${uid}/characters`))
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            const chars = snapshot.val();
                            const promises = [];
                            Object.keys(chars).forEach(charName => {
                                // Remove completamente o personagem do banco de dados
                                promises.push(remove(ref(db, `mesa_rpg/jogadores/${charName}`)));
                            });
                            return Promise.all(promises);
                        }
                        return Promise.resolve();
                    })
                    .then(() => {
                        // Remove a lista de personagens da conta
                        return remove(ref(db, `mesa_rpg/accounts/${uid}/characters`));
                    })
                    .then(() => {
                        // Marca a conta como inativa no Realtime Database
                        return update(ref(db, `mesa_rpg/accounts/${uid}`), { status: 'inactive' });
                    })
                    .then(() => {
                        alert(`Conta "${email}" foi desativada e TODOS os seus personagens foram permanentemente deletados!`);
                        carregarUsuarios();
                        carregarUsuariosInativos();
                    })
                    .catch((error) => {
                        alert(`Erro ao desativar conta: ${error.message}`);
                        console.error("Erro detalhado:", error);
                    });
            }
        };

        window.reativarConta = function(uid, email) {
            if (confirm(`Tem certeza que deseja reativar a conta "${email}"? A conta volta zerada, sem personagem.`)) {
                update(ref(db, `mesa_rpg/accounts/${uid}`), { status: 'active' })
                    .then(() => {
                        // Limpa a lista de personagens (conta volta zerada)
                        return remove(ref(db, `mesa_rpg/accounts/${uid}/characters`));
                    })
                    .then(() => {
                        // Remove da lista de inativos (se existir)
                        return remove(ref(db, `mesa_rpg/accounts_inactive/${email}`));
                    })
                    .then(() => {
                        alert(`Conta "${email}" foi reativada com sucesso! (Sem personagem)`);
                        carregarUsuarios();
                        carregarUsuariosInativos();
                    })
                    .catch((error) => {
                        alert(`Erro ao reativar conta: ${error.message}`);
                        console.error("Erro detalhado:", error);
                    });
            }
        };

        window.abrirTrocarSenha = function(uid, email) {
            if (confirm(`Deseja enviar um link de redefini√ß√£o de senha para ${email}?\n\nUm email ser√° enviado com as instru√ß√µes para trocar a senha.`)) {
                // Envia um email de reset de senha para a conta especificada
                sendPasswordResetEmail(auth, email)
                    .then(() => {
                        alert(`‚úÖ Email de redefini√ß√£o de senha foi enviado para ${email}!\n\nO usu√°rio pode clicar no link do email para criar uma nova senha.`);
                    })
                    .catch((error) => {
                        alert(`‚ùå Erro ao enviar email: ${error.message}`);
                        console.error("Erro detalhado:", error);
                    });
            }
        };

        window.abrirModalTrocarSenha = function() {
            document.getElementById('modal-trocar-senha').classList.add('ativo');
        };

        window.fecharModalTrocarSenha = function() {
            document.getElementById('modal-trocar-senha').classList.remove('ativo');
            document.getElementById('senha-atual').value = '';
            document.getElementById('senha-nova').value = '';
            document.getElementById('senha-nova-confirmacao').value = '';
        };

        window.confirmarTrocarSenha = async function() {
            const senhaAtual = document.getElementById('senha-atual').value;
            const senhaNova = document.getElementById('senha-nova').value;
            const senhaConfirmacao = document.getElementById('senha-nova-confirmacao').value;

            if (!senhaAtual || !senhaNova || !senhaConfirmacao) {
                alert('‚ùå Preencha todos os campos!');
                return;
            }

            if (senhaNova !== senhaConfirmacao) {
                alert('‚ùå As novas senhas n√£o conferem!');
                return;
            }

            if (senhaNova.length < 6) {
                alert('‚ùå A nova senha deve ter no m√≠nimo 6 caracteres!');
                return;
            }

            try {
                const user = auth.currentUser;
                if (!user) {
                    alert('‚ùå Voc√™ n√£o est√° autenticado!');
                    return;
                }

                // Tenta re-autenticar com a senha atual para valid√°-la
                const email = user.email;
                const credential = await signInWithEmailAndPassword(auth, email, senhaAtual);
                
                // Se conseguiu fazer login, temos a permiss√£o para trocar a senha
                await updatePassword(user, senhaNova);
                
                alert('‚úÖ Senha alterada com sucesso!');
                fecharModalTrocarSenha();
            } catch (error) {
                if (error.code === 'auth/wrong-password') {
                    alert('‚ùå Senha atual incorreta!');
                } else if (error.code === 'auth/user-mismatch') {
                    alert('‚ùå Erro de autentica√ß√£o. Tente fazer logout e login novamente.');
                } else {
                    alert(`‚ùå Erro: ${error.message}`);
                }
                console.error("Erro detalhado:", error);
            }
        };

        // Fechar modal ao clicar fora
        document.getElementById('modal-trocar-senha').addEventListener('click', function(e) {
            if(e.target === this) {
                fecharModalTrocarSenha();
            }
        });

        window.verificarStatusContas = function() {
            get(ref(db, 'mesa_rpg/accounts')).then(snapshot => {
                console.log("=== DEBUG - VERIFICA√á√ÉO DE CONTAS ===");
                if(!snapshot.exists()) {
                    console.log("‚ùå Nenhuma conta encontrada no banco de dados!");
                    return;
                }

                const contas = snapshot.val();
                Object.keys(contas).forEach(uid => {
                    const conta = contas[uid];
                    console.log(`\nüìß Email: ${conta.email}`);
                    console.log(`   Status: ${conta.status || 'n√£o definido'}`);
                    console.log(`   Personagens: ${conta.characters ? Object.keys(conta.characters).join(', ') || 'nenhum' : 'nenhum'}`);
                    console.log(`   UID: ${uid}`);
                });

                alert("‚úÖ Verifica√ß√£o de contas exibida no console (F12). Verifique o status de cada conta.");
            }).catch(err => {
                console.error("Erro ao verificar contas:", err);
                alert("‚ùå Erro ao verificar contas: " + err.message);
            });
        };
    </script>

    <!-- MODAL TROCAR SENHA -->
    <div id="modal-trocar-senha">
        <div class="modal-senha-content">
            <button id="btn-fechar-modal-senha" onclick="fecharModalTrocarSenha()">√ó</button>
            <h2>üîê Trocar Minha Senha</h2>
            
            <div class="input-group">
                <input type="password" id="senha-atual" placeholder="Senha Atual" class="input-login">
            </div>
            <div class="input-group">
                <input type="password" id="senha-nova" placeholder="Nova Senha" class="input-login">
            </div>
            <div class="input-group">
                <input type="password" id="senha-nova-confirmacao" placeholder="Confirmar Nova Senha" class="input-login">
            </div>

            <div class="btn-group">
                <button class="btn-confirmar" onclick="confirmarTrocarSenha()">‚úÖ Confirmar</button>
                <button class="btn-cancelar" onclick="fecharModalTrocarSenha()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>
</body>
</html>
