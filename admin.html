<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Daggerheart</title>
    <link rel="stylesheet" href="style.css?v=8.0">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
</head>
<body>

    <div id="access-denied-screen">
        <h1 style="color: red;">ACESSO NEGADO</h1>
        <p>Voc√™ est√° logado, mas n√£o como Narrador.</p>
        <div class="debug-box" id="debug-text">
            Verificando credenciais...
        </div>
        <button class="btn-voltar" onclick="fazerLogout()" style="margin-top: 20px; border-color: red; color: red;">SAIR E TENTAR NOVAMENTE</button>
    </div>

    <div id="admin-container" style="display: none;">
        <div class="admin-header">
            <h1>Gest√£o da Mesa</h1>
            <div>
                <button class="btn-nav" onclick="window.location.href='mestre.html'">Ir para o Tabuleiro</button>
                <button class="btn-nav" onclick="fazerLogout()">Sair</button>
            </div>
        </div>

        <div style="display: flex; gap: 40px; align-items: flex-start; justify-content: center; flex-wrap: wrap;">

            <div class="admin-box" style="width: 300px; padding: 20px;">
                <h3>Criar Novo Jogador</h3>

                <div class="input-group">
                    <input type="email" id="new-user-email" placeholder="Email do Jogador" class="input-login">
                </div>
                <div class="input-group">
                    <input type="password" id="new-user-pass" placeholder="Senha" class="input-login">
                    <span class="toggle-password" onclick="togglePassword('new-user-pass')">üëÅÔ∏è</span>
                </div>

                <button class="btn-main" onclick="criarUsuario()">Criar Conta</button>
            </div>

            <div style="flex-grow: 1; min-width: 300px;">
                <h3 style="text-align: center; color: var(--gold);">Contas Ativas</h3>
                <div id="users-list" class="admin-grid">
                    <p>Carregando...</p>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signOut, onAuthStateChanged, browserSessionPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATWkyYE6b3wyz3LdFXAmxKxNQOexa_vUY",
            authDomain: "deck-daggerheart.firebaseapp.com",
            databaseURL: "https://deck-daggerheart-default-rtdb.firebaseio.com",
            projectId: "deck-daggerheart",
            storageBucket: "deck-daggerheart.firebasestorage.app",
            messagingSenderId: "825358776791",
            appId: "1:825358776791:web:ce0ab844f58c60573c7392",
            measurementId: "G-20TB05E9N2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const EMAIL_MESTRE = "tgbahiense@gmail.com";

        // Configura persist√™ncia do login
        setPersistence(auth, browserSessionPersistence)
            .then(() => {
                console.log("Persist√™ncia de autentica√ß√£o configurada com sucesso.");
                // Escuta o estado de autentica√ß√£o somente ap√≥s a persist√™ncia estar configurada
                onAuthStateChanged(auth, user => {
                    const deniedScreen = document.getElementById('access-denied-screen');
                    const debugText = document.getElementById('debug-text');
                    const adminContainer = document.getElementById('admin-container');

                    console.log("onAuthStateChanged chamado. Usu√°rio:", user ? user.email : "Nenhum");

                    if (!user) {
                        deniedScreen.style.display = 'flex';
                        debugText.innerHTML = "Nenhum usu√°rio logado. <br>Por favor, fa√ßa login.";
                        adminContainer.style.display = 'none';
                        return;
                    }

                    const currentEmail = user.email.toLowerCase().trim();
                    const masterEmail = EMAIL_MESTRE.toLowerCase().trim();

                    if (currentEmail !== masterEmail) {
                        deniedScreen.style.display = 'flex';
                        adminContainer.style.display = 'none';
                        debugText.innerHTML = `
                            <p><strong>DIAGN√ìSTICO:</strong></p>
                            <p>Logado como: <span style="color: white">${currentEmail}</span></p>
                            <p>Mestre esperado: <span style="color: yellow">${masterEmail}</span></p>
                            <p>UID: ${user.uid}</p>
                        `;
                    } else {
                        deniedScreen.style.display = 'none';
                        adminContainer.style.display = 'block';
                        carregarUsuarios();
                    }
                });
            })
            .catch((error) => {
                console.error("Erro ao definir persist√™ncia:", error);
                document.getElementById('debug-text').innerHTML = "Erro ao carregar autentica√ß√£o. Consulte o console.";
            });

        window.togglePassword = function(id) {
            const input = document.getElementById(id);
            input.type = input.type === "password" ? "text" : "password";
        }

        window.fazerLogout = function() {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            });
        }

        window.criarUsuario = function() {
            const email = document.getElementById('new-user-email').value;
            const pass = document.getElementById('new-user-pass').value;

            if(!email || !pass) return alert("Preencha tudo");

            createUserWithEmailAndPassword(auth, email, pass)
                .then((cred) => {
                    const uid = cred.user.uid;
                    set(ref(db, `mesa_rpg/accounts/${uid}`), {
                        email: email,
                        characters: {}
                    });
                    alert("Usu√°rio criado: " + email);
                    document.getElementById('new-user-email').value = "";
                    document.getElementById('new-user-pass').value = "";
                })
                .catch((error) => {
                    alert("Erro ao criar: " + error.message);
                });
        }

        function carregarUsuarios() {
            onValue(ref(db, 'mesa_rpg/accounts'), snapshot => {
                const list = document.getElementById('users-list');
                list.innerHTML = "";

                if(!snapshot.exists()) { list.innerHTML = "<p>Nenhuma conta encontrada.</p>"; return; }

                snapshot.forEach(childSnap => {
                    const data = childSnap.val();
                    const chars = data.characters ? Object.keys(data.characters) : [];

                    let charHtml = "";
                    chars.forEach(charName => {
                        charHtml += `
                            <li>
                                ${charName}
                                <button class="btn-reset-hand" onclick="resetarMao('${charName}')">Resetar M√£o</button>
                            </li>
                        `;
                    });

                    const div = document.createElement('div');
                    div.className = 'player-card-admin';
                    div.innerHTML = `
                        <div class="player-email">${data.email}</div>
                        <ul class="char-list" style="list-style: none; padding: 0;">
                            ${charHtml || '<li style="font-style:italic">Sem personagens</li>'}
                        </ul>
                    `;
                    list.appendChild(div);
                });
            });
        }

        window.resetarMao = function(charName) {
            if(confirm(`Apagar m√£o e reserva de ${charName}?`)) {
                set(ref(db, `mesa_rpg/jogadores/${charName}/mao`), []);
                set(ref(db, `mesa_rpg/jogadores/${charName}/reserva`), []);
                alert("M√£o resetada.");
            }
        }
    </script>
</body>
</html>
