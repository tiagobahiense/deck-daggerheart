<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Daggerheart</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
</head>
<body>

    <div id="admin-container">
        <div class="admin-header">
            <h1>Gestão da Mesa</h1>
            <div>
                <button class="btn-nav" onclick="window.location.href='mestre.html'">Ir para o Tabuleiro</button>
                <button class="btn-nav" onclick="fazerLogout()">Sair</button>
            </div>
        </div>

        <div style="display: flex; gap: 40px; align-items: flex-start; justify-content: center;">
            
            <div class="admin-box" style="width: 300px; padding: 20px;">
                <h3>Criar Novo Jogador</h3>
                <input type="email" id="new-user-email" placeholder="Email do Jogador" class="input-login">
                <input type="password" id="new-user-pass" placeholder="Senha" class="input-login">
                <button class="btn-main" onclick="criarUsuario()">Criar Conta</button>
            </div>

            <div style="flex-grow: 1;">
                <h3 style="text-align: center; color: var(--gold);">Contas Ativas</h3>
                <div id="users-list" class="admin-grid">
                    <p>Carregando...</p>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATWkyYE6b3wyz3LdFXAmxKxNQOexa_vUY",
            authDomain: "deck-daggerheart.firebaseapp.com",
            databaseURL: "https://deck-daggerheart-default-rtdb.firebaseio.com",
            projectId: "deck-daggerheart",
            storageBucket: "deck-daggerheart.firebasestorage.app",
            messagingSenderId: "825358776791",
            appId: "1:825358776791:web:ce0ab844f58c60573c7392",
            measurementId: "G-20TB05E9N2"
        };

        const app = initializeApp(firebaseConfig, "primary");
        const auth = getAuth(app);
        const db = getDatabase(app);
        const secondaryApp = initializeApp(firebaseConfig, "Secondary");
        const secondaryAuth = getAuth(secondaryApp);

        const EMAIL_MESTRE = "mestre@rpg.com";

        onAuthStateChanged(auth, user => {
            if(!user || user.email !== EMAIL_MESTRE) {
                window.location.href = 'index.html';
            } else {
                carregarUsuarios();
            }
        });

        window.fazerLogout = function() {
            signOut(auth).then(() => window.location.href = 'index.html');
        }

        window.criarUsuario = function() {
            const email = document.getElementById('new-user-email').value;
            const pass = document.getElementById('new-user-pass').value;
            
            if(!email || !pass) return alert("Preencha tudo");

            createUserWithEmailAndPassword(secondaryAuth, email, pass)
                .then((cred) => {
                    const uid = cred.user.uid;
                    set(ref(db, `mesa_rpg/accounts/${uid}`), {
                        email: email,
                        characters: {}
                    });
                    signOut(secondaryAuth); 
                    alert("Usuário criado: " + email);
                    document.getElementById('new-user-email').value = "";
                    document.getElementById('new-user-pass').value = "";
                })
                .catch((error) => {
                    alert("Erro ao criar: " + error.message);
                });
        }

        function carregarUsuarios() {
            onValue(ref(db, 'mesa_rpg/accounts'), snapshot => {
                const list = document.getElementById('users-list');
                list.innerHTML = "";
                
                if(!snapshot.exists()) { list.innerHTML = "<p>Nenhuma conta encontrada.</p>"; return; }

                snapshot.forEach(childSnap => {
                    const uid = childSnap.key;
                    const data = childSnap.val();
                    const chars = data.characters ? Object.keys(data.characters) : [];

                    let charHtml = "";
                    chars.forEach(charName => {
                        charHtml += `
                            <li>
                                ${charName} 
                                <button class="btn-reset-hand" onclick="resetarMao('${charName}')">Resetar Mão</button>
                            </li>
                        `;
                    });

                    const div = document.createElement('div');
                    div.className = 'player-card-admin';
                    div.innerHTML = `
                        <div class="player-email">${data.email}</div>
                        <ul class="char-list" style="list-style: none; padding: 0;">
                            ${charHtml || '<li style="font-style:italic">Sem personagens</li>'}
                        </ul>
                    `;
                    list.appendChild(div);
                });
            });
        }

        window.resetarMao = function(charName) {
            if(confirm(`Apagar mão e reserva de ${charName}?`)) {
                set(ref(db, `mesa_rpg/jogadores/${charName}/mao`), []);
                set(ref(db, `mesa_rpg/jogadores/${charName}/reserva`), []);
                alert("Mão resetada.");
            }
        }
    </script>
</body>
</html>