<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Daggerheart</title>
    <link rel="stylesheet" href="style.css?v=8.0">
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        .inactive-account { opacity: 0.6; border: 1px solid #ff6666; }
        .inactive-account .player-email { color: #ff9999; }
        #inactive-users-list { margin-top: 30px; border-top: 1px solid #555; padding-top: 20px; }
        .reactivate-btn { background: #2e8b57 !important; border-color: #2e8b57 !important; }
        .reactivate-btn:hover { background: #3cb371 !important; }
        #modal-trocar-senha { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 5000; justify-content: center; align-items: center; }
        #modal-trocar-senha.ativo { display: flex; }
        .modal-senha-content { background: rgba(20, 20, 20, 0.95); border: 2px solid var(--gold); border-radius: 10px; padding: 30px; max-width: 400px; box-shadow: 0 0 40px rgba(0, 0, 0, 0.9); position: relative; }
        .modal-senha-content h2 { color: var(--gold); margin-top: 0; text-align: center; }
        .modal-senha-content .input-group { margin: 15px 0; }
        .modal-senha-content input { width: 100%; padding: 10px; border: 1px solid var(--gold); border-radius: 5px; background: rgba(0, 0, 0, 0.5); color: #fff; box-sizing: border-box; }
        .modal-senha-content .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .modal-senha-content button { flex: 1; padding: 10px; border: 1px solid var(--gold); border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .modal-senha-content .btn-confirmar { background: #4CAF50; color: #fff; }
        .modal-senha-content .btn-cancelar { background: #f44336; color: #fff; }
        #btn-fechar-modal-senha { position: absolute; top: 10px; right: 15px; background: var(--gold); color: #000; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="access-denied-screen">
        <h1 style="color: red;">ACESSO NEGADO</h1>
        <p>Voc√™ est√° logado, mas n√£o como Narrador.</p>
        <div class="debug-box" id="debug-text">Verificando credenciais...</div>
        <button class="btn-voltar" onclick="fazerLogout()" style="margin-top: 20px; border-color: red; color: red;">SAIR E TENTAR NOVAMENTE</button>
    </div>

    <div id="admin-container" style="display: none;">
        <div class="admin-header">
            <h1>Gest√£o da Mesa</h1>
            <div>
                <button class="btn-nav" onclick="window.location.href='mestre.html'">Ir para o Tabuleiro</button>
                <button class="btn-nav" onclick="abrirModalTrocarSenha()" style="background: #4CAF50;">üîê Trocar Minha Senha</button>
                <button class="btn-nav" onclick="fazerLogout()">Sair</button>
            </div>
        </div>

        <div style="display: flex; gap: 40px; align-items: flex-start; justify-content: center; flex-wrap: wrap;">
            <div class="admin-box" style="width: 300px; padding: 20px;">
                <h3>Criar Novo Jogador</h3>
                <div class="input-group"><input type="email" id="new-user-email" placeholder="Email do Jogador" class="input-login"></div>
                <div class="input-group"><input type="password" id="new-user-pass" placeholder="Senha" class="input-login"><span class="toggle-password" onclick="togglePassword('new-user-pass')">üëÅÔ∏è</span></div>
                <button class="btn-main" onclick="criarUsuario()">Criar Conta</button>
            </div>

            <div style="flex-grow: 1; min-width: 300px;">
                <h3 style="text-align: center; color: var(--gold);">Contas Ativas</h3>
                <div id="users-list" class="admin-grid"><p>Carregando...</p></div>
                <h3 style="text-align: center; color: #ff9999; margin-top: 30px;">Contas Inativas</h3>
                <div id="inactive-users-list" class="admin-grid"><p>Carregando...</p></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, createUserWithEmailAndPassword, signOut, onAuthStateChanged, browserSessionPersistence, inMemoryPersistence, setPersistence, fetchSignInMethodsForEmail, updatePassword, sendPasswordResetEmail, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyATWkyYE6b3wyz3LdFXAmxKxNQOexa_vUY",
            authDomain: "deck-daggerheart.firebaseapp.com",
            databaseURL: "https://deck-daggerheart-default-rtdb.firebaseio.com",
            projectId: "deck-daggerheart",
            storageBucket: "deck-daggerheart.firebasestorage.app",
            messagingSenderId: "825358776791",
            appId: "1:825358776791:web:ce0ab844f58c60573c7392",
            measurementId: "G-20TB05E9N2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        let isCreatingUser = false;

        const secondaryApp = initializeApp(firebaseConfig, "secondary-auth-creator");
        const secondaryAuth = getAuth(secondaryApp);
        setPersistence(secondaryAuth, inMemoryPersistence).catch(() => setPersistence(secondaryAuth, browserSessionPersistence));

        const EMAIL_MESTRE = "tgbahiense@gmail.com";

        setPersistence(auth, browserSessionPersistence).then(() => {
            onAuthStateChanged(auth, user => {
                if (isCreatingUser) return;
                const deniedScreen = document.getElementById('access-denied-screen');
                const adminContainer = document.getElementById('admin-container');

                if (!user || user.email.toLowerCase().trim() !== EMAIL_MESTRE.toLowerCase().trim()) {
                    deniedScreen.style.display = 'flex';
                    adminContainer.style.display = 'none';
                    if(!user) document.getElementById('debug-text').innerHTML = "Nenhum usu√°rio logado.";
                } else {
                    deniedScreen.style.display = 'none';
                    adminContainer.style.display = 'block';
                    carregarUsuarios();
                    carregarUsuariosInativos();
                }
            });
        });

        window.togglePassword = function(id) {
            const input = document.getElementById(id);
            input.type = input.type === "password" ? "text" : "password";
        }

        window.fazerLogout = function() {
            signOut(auth).then(() => window.location.href = 'index.html');
        }

        window.criarUsuario = function() {
            const email = document.getElementById('new-user-email').value;
            const pass = document.getElementById('new-user-pass').value;
            if(!email || !pass) return alert("Preencha tudo");

            isCreatingUser = true;
            createUserWithEmailAndPassword(secondaryAuth, email, pass).then((cred) => {
                const uid = cred.user.uid;
                set(ref(db, `mesa_rpg/accounts/${uid}`), { email: email, characters: {}, status: 'active' }).then(() => {
                    setTimeout(() => signOut(secondaryAuth).then(() => { isCreatingUser = false; alert("Criado!"); carregarUsuarios(); }), 500);
                });
            }).catch((error) => { isCreatingUser = false; alert("Erro: " + error.message); });
        }

        function carregarUsuarios() {
            onValue(ref(db, 'mesa_rpg/accounts'), snapshot => {
                const list = document.getElementById('users-list');
                list.innerHTML = "";
                if(!snapshot.exists()) { list.innerHTML = "<p>Vazio</p>"; return; }
                snapshot.forEach(childSnap => {
                    const uid = childSnap.key;
                    const data = childSnap.val();
                    if (data.status === 'inactive') return;
                    
                    const chars = data.characters ? Object.keys(data.characters) : [];
                    let charHtml = "";
                    chars.forEach(charName => {
                        const safeName = charName.replace(/'/g, "\\'"); // Escapa aspas simples
                        charHtml += `<li>${charName} <button class="btn-banir" onclick="removerPerfil('${uid}', '${safeName}')" style="margin-left:5px; padding:2px 5px; font-size:0.7rem;">üíÄ Deletar</button></li>`;
                    });

                    const div = document.createElement('div');
                    div.className = 'player-card-admin';
                    div.innerHTML = `<div class="player-email">${data.email}</div><ul style="padding-left:15px; margin:5px 0;">${charHtml || '<li>Sem personagens</li>'}</ul><button class="btn-banir" onclick="removerConta('${uid}', '${data.email}')">üíÄ Desativar Conta</button>`;
                    list.appendChild(div);
                });
            });
        }
        
        function carregarUsuariosInativos() {
             onValue(ref(db, 'mesa_rpg/accounts'), snapshot => {
                const list = document.getElementById('inactive-users-list');
                list.innerHTML = "";
                if(!snapshot.exists()) return;
                snapshot.forEach(childSnap => {
                    const uid = childSnap.key;
                    const data = childSnap.val();
                    if (data.status !== 'inactive') return;
                    const div = document.createElement('div');
                    div.className = 'player-card-admin inactive-account';
                    div.innerHTML = `<div class="player-email">${data.email} <button class="btn-banir reactivate-btn" onclick="reativarConta('${uid}', '${data.email}')">‚úÖ Reativar</button></div>`;
                    list.appendChild(div);
                });
            });
        }
        
        window.removerPerfil = function(uid, charName) {
            if(confirm(`Deletar o personagem "${charName}"?\n\nIsso apaga a ficha, os itens e libera o espa√ßo na conta.`)) {
                // 1. Remove do n√≥ geral de jogadores (onde ficam as fichas)
                remove(ref(db, `mesa_rpg/jogadores/${charName}`))
                    .then(() => {
                        // 2. Remove da lista de personagens da conta do usu√°rio
                        return remove(ref(db, `mesa_rpg/accounts/${uid}/characters/${charName}`));
                    })
                    .then(() => {
                        alert("Personagem deletado com sucesso!");
                    })
                    .catch((err) => {
                        alert("Erro ao deletar: " + err.message);
                        console.error(err);
                    });
            }
        };
        
        window.removerConta = function(uid, email) {
            if (confirm(`Desativar ${email}?`)) update(ref(db, `mesa_rpg/accounts/${uid}`), { status: 'inactive' });
        }
        
        window.reativarConta = function(uid, email) {
            if (confirm(`Reativar ${email}?`)) update(ref(db, `mesa_rpg/accounts/${uid}`), { status: 'active' });
        }
        
        window.abrirModalTrocarSenha = function() { document.getElementById('modal-trocar-senha').classList.add('ativo'); }
        window.fecharModalTrocarSenha = function() { document.getElementById('modal-trocar-senha').classList.remove('ativo'); }
        
        window.confirmarTrocarSenha = async function() {
             const nova = document.getElementById('senha-nova').value;
             if(nova.length < 6) return alert("M√≠nimo 6 caracteres");
             try { await updatePassword(auth.currentUser, nova); alert("Senha alterada!"); fecharModalTrocarSenha(); } catch(e) { alert("Erro: " + e.message); }
        }
    </script>

    <div id="modal-trocar-senha">
        <div class="modal-senha-content">
            <button id="btn-fechar-modal-senha" onclick="fecharModalTrocarSenha()">√ó</button>
            <h2>üîê Nova Senha</h2>
            <div class="input-group"><input type="password" id="senha-nova" placeholder="Nova Senha" class="input-login"></div>
            <div class="btn-group"><button class="btn-confirmar" onclick="confirmarTrocarSenha()">Confirmar</button></div>
        </div>
    </div>
</body>
</html>